<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>排班助手（测试版）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --brand: 88 80 236; scroll-behavior: smooth; }
    body { min-height: 100vh; background: radial-gradient(circle at top, rgba(129,140,248,.18), transparent 55%) fixed, linear-gradient(180deg, rgba(248,250,252,1), rgba(241,245,249,1)); transition: background 0.6s ease; }
    @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(8px) scale(.98);} to { opacity: 1; transform: translateY(0) scale(1);} }
    @keyframes gentleFloat { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
    .animate-fade-in { animation: fadeSlideIn .35s ease both; will-change: transform, opacity; }
    .grid-wrap { height: calc(100vh - 260px); overflow: auto; scroll-behavior: smooth; }
    th.sticky { position: sticky; top: 0; background: rgb(249 250 251/0.95); z-index: 3; backdrop-filter: blur(4px); }
    td, th { white-space: nowrap; }
    input.cell { width: 6rem; padding-right: 1.75rem; }
    .cell-wrap { position: relative; }
    .cell-toggle { position: absolute; right: .25rem; top: .35rem; width: 1.5rem; height: 1.5rem; font-size: 0; color: transparent; background: transparent; border: none; cursor: pointer; }
    .cell-toggle:focus-visible { outline: 2px solid rgb(129 140 248); outline-offset: 2px; }
    .cell-toggle:disabled { cursor: not-allowed; }
    .cell-toggle::after { content: ''; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
    #errbar { display:none; }
    #errbar.show { display:block; }
    .left-sticky { position: sticky; left: 0; z-index: 2; background: white; }
    .left-sticky-2 { position: sticky; left: 8.5rem; z-index: 2; background: white; }
    .left-sticky-3 { position: sticky; left: 14.8rem; z-index: 2; background: white; }
    .badge { display:inline-flex; align-items:center; justify-content:center; min-width:2.25rem; height:1.75rem; border-radius:9999px; padding:0 .5rem; font-size:.75rem; backdrop-filter: blur(4px); }
    .floating-progress { position: fixed; right: 16px; bottom: 16px; z-index: 50; width: 340px; animation: gentleFloat 7.2s ease-in-out infinite; will-change: transform; }
    .fp-card { background: linear-gradient(135deg, rgba(88,80,236,.12), rgba(14,165,233,.12)); border: 1px solid rgba(88,80,236,.18); box-shadow: 0 10px 30px rgba(0,0,0,.08); transition: transform .35s ease, box-shadow .35s ease; backdrop-filter: blur(8px); }
    .fp-card:hover { transform: translateY(-4px); box-shadow: 0 14px 32px rgba(88,80,236,.25); }
    .logbox { max-height: 140px; overflow:auto; background: rgba(255,255,255,.78); border-radius: .75rem; border: 1px solid rgba(88,80,236,.18); transition: box-shadow .3s ease; }
    .logbox:hover { box-shadow: inset 0 0 0 1px rgba(88,80,236,.25); }
    .picker { box-shadow: 0 14px 32px rgba(15,23,42,.18); border: 1px solid rgba(148,163,184,.18); backdrop-filter: blur(10px); }
    .section-card { background: rgba(255,255,255,.92); border-radius: 1.5rem; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 18px 35px rgba(15,23,42,.08); border: 1px solid rgba(148,163,184,.18); backdrop-filter: blur(12px); transition: transform .35s cubic-bezier(.4,0,.2,1), box-shadow .35s cubic-bezier(.4,0,.2,1); }
    .section-card:hover { transform: translateY(-4px); box-shadow: 0 24px 45px rgba(79,70,229,.18); }
    .dock-panel { will-change: transform; }
    .layout-shell { width: min(96vw, 1800px); margin-left: auto; margin-right: auto; padding-left: 1.25rem; padding-right: 1.25rem; }
    @media (max-width: 1024px){ .layout-shell { width: 100vw; padding-left: 1rem; padding-right: 1rem; } }
    @media (prefers-reduced-motion: reduce){
      .animate-fade-in, .floating-progress { animation: none !important; }
      .section-card, .fp-card { transition: none !important; }
    }
  </style>
</head>
<body>
  <div id="errbar" class="bg-red-50 text-red-700 text-sm px-4 py-2"></div>
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
  <script src="static/js/scheduler-algorithms.js"></script>

  <script type="text/babel" data-presets="env,react">
    const { useState, useMemo, useEffect, useRef, useCallback, useLayoutEffect } = React;

    function globalErr(msg){ const bar = document.getElementById('errbar'); if(bar){ bar.textContent = '错误：' + msg; bar.className = 'show bg-red-50 text-red-700 text-sm px-4 py-2'; } }
    window.addEventListener('error', (e)=> globalErr(e?.message || '脚本错误'));
    window.addEventListener('unhandledrejection', (e)=> globalErr(e?.reason?.message || String(e?.reason || 'Promise 错误')));

    const Icon = ({name, className=''}) => { const common = "w-5 h-5"; switch(name){ case 'grid': return <svg className={common+" "+className} viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 9h8V3H3v6zm10 12h8v-6h-8v6zM3 21h8v-6H3v6zm10-12h8V3h-8v6z" strokeWidth="1.5"/></svg>; case 'users': return <svg className={common+" "+className} viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M16 11c1.66 0 3-1.57 3-3.5S17.66 4 16 4s-3 1.57-3 3.5S14.34 11 16 11zM8 11c1.66 0 3-1.57 3-3.5S9.66 4 8 4 5 5.57 5 7.5 6.34 11 8 11zM8 13c-2.67 0-8 1.34-8 4v3h10v-3c0-1.1.9-2 2-2h4c.74 0 1.4.4 1.74 1" strokeWidth="1.5"/></svg>; case 'magic': return <svg className={common+" "+className} viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 21l9-9M14 7l3-3M11 10l3-3" strokeWidth="1.5"/></svg>; case 'chart': return <svg className={common+" "+className} viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 3v18h18M7 13v5M12 9v9M17 6v12" strokeWidth="1.5"/></svg>; case 'history': return <svg className={common+" "+className} viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 8v5l3 3M3 12a9 9 0 1 0 9-9 9 9 0 0 0-9 9zm0 0h3" strokeWidth="1.5"/></svg>; case 'cog': return <svg className={common+" "+className} viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V22a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1 1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a2 2 0 0 1-1.82.33 1.65 1.65 0 0 0-1.51 1H2a2 2 0 0 1 0-4h.09c-.49.2-.95.52-1.15 1z" strokeWidth="1"/></svg>; case 'lock': return <svg className={common+" "+className} viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="11" width="18" height="10" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>; default: return null; } };

    const Spinner = ({ className = 'w-4 h-4 text-white' }) => (
      <svg className={`animate-spin ${className}`} viewBox="0 0 24 24" fill="none">
        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
        <path className="opacity-75" d="M4 12a8 8 0 0 1 8-8v4a4 4 0 0 0-4 4H4z" fill="currentColor"></path>
      </svg>
    );
    const colorClasses = { indigo: 'bg-indigo-600 hover:bg-indigo-500', emerald: 'bg-emerald-600 hover:bg-emerald-500', sky: 'bg-sky-600 hover:bg-sky-500', gray: 'bg-gray-800 hover:bg-gray-700' };
    const PillBtn = ({children, onClick, color='indigo', type='button', disabled=false, title=''}) => (
      <button type={type} disabled={disabled} onClick={onClick} title={title} className={`group relative overflow-hidden inline-flex items-center justify-center gap-2 rounded-full px-4 py-2 text-white ${disabled?'bg-gray-300 cursor-not-allowed':(colorClasses[color] || colorClasses.indigo)} transition-transform duration-200 ${disabled?'':'hover:-translate-y-0.5 active:translate-y-0'} shadow-md`}>
        <span className="relative z-10">{children}</span>
        {!disabled && <span className="absolute inset-0 bg-white/10 opacity-0 group-hover:opacity-100 transition-opacity"></span>}
      </button>
    );
    const Section = ({title, children, right}) => (
      <div className="section-card animate-fade-in">
        <div className="flex items-center justify-between mb-3"><h2 className="text-lg font-semibold">{title}</h2>{right}</div>
        {children}
      </div>
    );

    const API_BASE = '/api';
    const EMPTY_ROW = Object.freeze({});
    const EMPTY_STATS = Object.freeze({ total: 0, white: 0, mid1: 0, mid2: 0, night: 0 });
    const WN = ['日','一','二','三','四','五','六'];
    const today = new Date();
    const SHIFT_TYPES = ['白','中1','中2','夜','休'];
    const SHIFT_WORK_TYPES = ['白','中1','中2','夜'];

    const allowIme = (handler)=>{
      return (event, ...args)=>{
        if(!event) return handler(event, ...args);
        if(event.isComposing || event?.nativeEvent?.isComposing || event?.target?.isComposing) return;
        return handler(event, ...args);
      };
    };

    function fmt(d) { return new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10); }
    function monthRangeOf(dateObj){ const y = dateObj.getFullYear(); const m = dateObj.getMonth(); const start = new Date(y, m, 1); const end = new Date(y, m + 1, 0); return [fmt(start), fmt(end)]; }
    function enumerateDates(start, end){ const out=[]; let d=new Date(start); const e=new Date(end); while(d<=e){ out.push(fmt(d)); d.setDate(d.getDate()+1); } return out; }
    function dow(ymd){ return new Date(ymd).getDay(); }
    function dateAdd(ymd, delta){ const d=new Date(ymd); d.setDate(d.getDate()+delta); return fmt(d); }
    function monthListBetween(start, end){
      const startDate = new Date(start);
      const endDate = new Date(end);
      const cur = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
      const out = [];
      while(cur <= endDate){
        const key = `${cur.getFullYear()}-${String(cur.getMonth()+1).padStart(2,'0')}`;
        const label = `${cur.getFullYear()}年${String(cur.getMonth()+1).padStart(2,'0')}月`;
        const monthStart = fmt(cur);
        const monthEnd = fmt(new Date(cur.getFullYear(), cur.getMonth()+1, 0));
        out.push({ key, label, start: monthStart, end: monthEnd });
        cur.setMonth(cur.getMonth()+1);
      }
      return out;
    }
    function monthKeyToSpan(monthKey){
      if(!monthKey || !/\d{4}-\d{2}/.test(monthKey)) return null;
      const [y, m] = monthKey.split('-').map(Number);
      if(Number.isNaN(y) || Number.isNaN(m)) return null;
      const start = fmt(new Date(y, m-1, 1));
      const end = fmt(new Date(y, m, 0));
      return { start, end };
    }
    function weekStartKey(day){
      const d = new Date(day);
      const mondayIdx = (d.getDay()+6)%7;
      d.setDate(d.getDate()-mondayIdx);
      return fmt(d);
    }
    function formatDateTimeString(value){
      if(!value) return '—';
      const str = String(value);
      const candidate = str.includes('T') ? str : str.replace(' ', 'T');
      const date = new Date(candidate);
      if(Number.isNaN(date.getTime())) return str;
      return date.toLocaleString();
    }

    function albumEntryKey(entry, fallbackIndex = 0){
      if(entry && entry.id) return String(entry.id);
      if(entry && entry.savedAt){
        const stamp = Date.parse(entry.savedAt);
        if(Number.isFinite(stamp)) return `${entry.savedAt}`;
      }
      if(entry && entry.range && entry.range.start && entry.range.end){
        return `${entry.range.start}_${entry.range.end}_${fallbackIndex}`;
      }
      return `album_${fallbackIndex}`;
    }

    async function apiGet(path){ const r = await fetch(API_BASE + path, { credentials: 'include' }); if(!r.ok){ let msg='请求失败'; try { const e=await r.json(); msg=e.message||msg; } catch{} throw new Error(msg); } return r.json(); }
    async function apiPost(path, body){ const r = await fetch(API_BASE + path, { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(body||{}), credentials: 'include' }); if(!r.ok){ let ejson=null; try { ejson = await r.json(); } catch{} const err = new Error((ejson&&ejson.message)||'请求失败'); if(ejson) err.payload = ejson; throw err; } return r.json(); }

    const isWork = (v)=> !!(v && v!=='休');
    function getVal(data, day, emp){ return (data[day]||{})[emp]||''; }
    function setVal(map, day, emp, val){ const row = { ...(map[day]||{}) }; row[emp] = val; map[day] = row; }

    function countByEmpInRange(employees, data, start, end){
      const normalize = (val)=>{
        if(typeof val !== 'string') return null;
        const trimmed = val.slice(0,10);
        return /^\d{4}-\d{2}-\d{2}$/.test(trimmed) ? trimmed : null;
      };
      let s = normalize(start);
      let e = normalize(end);
      if(s && e && s > e){ const tmp = s; s = e; e = tmp; }
      const dates = (s && e) ? enumerateDates(s, e) : Object.keys(data||{}).sort();
      const counter = {}; for(const emp of employees){ counter[emp] = { 总:0 }; for(const shift of SHIFT_WORK_TYPES){ counter[emp][shift]=0; } }
      for(const day of dates){ if(s && day < s) continue; if(e && day > e) continue; const row = data?.[day] || {}; for(const emp of employees){ const v = row[emp]||''; if(!v || v==='休') continue; counter[emp]['总']++; if(SHIFT_WORK_TYPES.includes(v)) counter[emp][v]++; } }
      return counter;
    }
    function countByEmpOnDates(employees, data, dates){
      const counter = {};
      let hasWork = false;
      for(const emp of employees){
        counter[emp] = { 总:0 };
        for(const shift of SHIFT_WORK_TYPES){ counter[emp][shift] = 0; }
      }
      for(const day of dates){
        const row = data?.[day] || {};
        for(const emp of employees){
          const v = row[emp] || '';
          if(!v || v === '休') continue;
          counter[emp]['总']++;
          if(SHIFT_WORK_TYPES.includes(v)) counter[emp][v]++;
          hasWork = true;
        }
      }
      return { counter, hasWork };
    }

    function countRunLeft(data, d, e){ let c=0; for(let i=-1;i>=-10;i--){ const ymd=dateAdd(d,i); const v=getVal(data, ymd, e); if(isWork(v)) c++; else break; } return c; }
    function countRunRight(data, d, e){ let c=0; for(let i=1;i<=10;i++){ const ymd=dateAdd(d,i); const v=getVal(data, ymd, e); if(isWork(v)) c++; else break; } return c; }
    function wouldExceed6(data, e, d, newV){ if(!isWork(newV)) return false; const L=countRunLeft(data,d,e); const R=countRunRight(data,d,e); return (L+1+R)>6; }

    const REST_PAIRS = ['12','23','34','56','71'];
    const MENU_KEYS = ['grid','batch','album','users','stats','history','settings','roles'];
    const defaultShiftColors = { '白':'#eef2ff','中1':'#e0f2fe','中2':'#cffafe','夜':'#fee2e2','休':'#f3f4f6' };
    const defaultStaffingAlerts = {
      total: { threshold: 0, lowColor: '#fee2e2', highColor: '#dcfce7' },
      white: { threshold: 0, lowColor: '#fef3c7', highColor: '#bfdbfe' },
      mid1: { threshold: 0, lowColor: '#fef3c7', highColor: '#bae6fd' }
    };
    const normalizeRestPair = (pair)=> pair==='17' ? '71' : pair;
    function sanitizeRestPairValue(val){
      if(!val) return '';
      const digits = String(val).replace(/\D/g,'');
      if(digits.length !== 2) return '';
      const normalized = normalizeRestPair(digits);
      return REST_PAIRS.includes(normalized) ? normalized : digits;
    }
    function sanitizeRestPrefsMap(map){
      const next = {};
      Object.entries(map||{}).forEach(([emp, raw])=>{
        const cleaned = sanitizeRestPairValue(raw);
        if(cleaned) next[emp] = cleaned;
      });
      return next;
    }
    function normalizeStaffingAlerts(raw){
      const base = JSON.parse(JSON.stringify(defaultStaffingAlerts));
      if(!raw || typeof raw !== 'object') return base;
      ['total','white','mid1'].forEach(key=>{
        const entry = raw[key];
        if(!entry || typeof entry !== 'object') return;
        const threshold = Number(entry.threshold);
        if(Number.isFinite(threshold)) base[key].threshold = threshold;
        if(typeof entry.lowColor === 'string' && entry.lowColor.trim()) base[key].lowColor = entry.lowColor;
        if(typeof entry.highColor === 'string' && entry.highColor.trim()) base[key].highColor = entry.highColor;
      });
      return base;
    }
    function contrastColor(hex){
      if(typeof hex !== 'string') return '#111827';
      const norm = hex.replace('#','');
      if(norm.length !== 6) return '#111827';
      const r = parseInt(norm.slice(0,2),16);
      const g = parseInt(norm.slice(2,4),16);
      const b = parseInt(norm.slice(4,6),16);
      if([r,g,b].some(v=> Number.isNaN(v))) return '#111827';
      const luminance = (0.299*r + 0.587*g + 0.114*b) / 255;
      return luminance > 0.6 ? '#111827' : '#f9fafb';
    }
    function styleForStaffing(count, rule){
      if(!rule) return {};
      const { threshold, lowColor, highColor } = rule;
      const targetColor = (Number.isFinite(threshold) && count <= threshold) ? lowColor : highColor;
      if(!targetColor) return {};
      return {
        backgroundColor: targetColor,
        color: contrastColor(targetColor),
        borderRadius: '999px',
        padding: '0 0.35rem'
      };
    }
    const AUTO_SAVE_SUFFIX = '自动保存';
    function extractUserNames(user){
      if(!user) return { username:'', display:'' };
      const username = typeof user.username === 'string' ? user.username.trim() : '';
      const displayRaw = typeof user.display_name === 'string' ? user.display_name : user.displayName;
      const display = typeof displayRaw === 'string' ? displayRaw.trim() : '';
      return { username, display };
    }
    function formatUserDisplayName(user){
      const { username, display } = extractUserNames(user);
      if(display) return display;
      if(username) return username;
      return '';
    }
    function formatOperatorLabel(user){
      const { username, display } = extractUserNames(user);
      if(username && display && username !== display){
        return `${username}（${display}）`;
      }
      if(display) return display;
      if(username) return username;
      return '管理员';
    }
    function formatAutoSaveOperator(user){
      const label = formatOperatorLabel(user);
      if(!label) return AUTO_SAVE_SUFFIX;
      if(label.endsWith(` ${AUTO_SAVE_SUFFIX}`)) return label;
      return `${label} ${AUTO_SAVE_SUFFIX}`;
    }
    function isAutoSaveLabel(label){
      if(!label || typeof label !== 'string') return false;
      return label.trim().endsWith(AUTO_SAVE_SUFFIX);
    }
    function normalizeNightRules(raw){
      const defaults = {
        prioritizeInterval: false,
        restAfterNight: true,
        enforceRestCap: true,
        restAfterMid2: true,
        allowDoubleMid2: false,
        allowNightDay4: false
      };
      if(!raw || typeof raw !== 'object') return { ...defaults };
      const next = { ...defaults };
      if(typeof raw.prioritizeInterval === 'boolean') next.prioritizeInterval = raw.prioritizeInterval;
      if(typeof raw.restAfterNight === 'boolean') next.restAfterNight = raw.restAfterNight;
      if(typeof raw.enforceRestCap === 'boolean') next.enforceRestCap = raw.enforceRestCap;
      if(typeof raw.restAfterMid2 === 'boolean') next.restAfterMid2 = raw.restAfterMid2;
      if(typeof raw.allowDoubleMid2 === 'boolean') next.allowDoubleMid2 = raw.allowDoubleMid2;
      if(typeof raw.allowNightDay4 === 'boolean') next.allowNightDay4 = raw.allowNightDay4;
      if(raw.rest2AfterNight && typeof raw.rest2AfterNight === 'object'){
        if(typeof raw.rest2AfterNight.enabled === 'boolean') next.restAfterNight = raw.rest2AfterNight.enabled;
        if(typeof raw.rest2AfterNight.mandatory === 'boolean') next.enforceRestCap = raw.rest2AfterNight.mandatory;
      }
      return next;
    }
    function hashPassword(raw){
      if(typeof raw !== 'string') return '';
      try {
        return btoa(unescape(encodeURIComponent(raw)));
      } catch {
        return raw;
      }
    }
    function verifyPassword(hash, raw){
      if(!hash) return raw === '';
      return hash === hashPassword(raw);
    }
    function encodeCredential(raw){
      if(typeof raw !== 'string') return '';
      try {
        return btoa(unescape(encodeURIComponent(raw)));
      } catch {
        return raw;
      }
    }
    function decodeCredential(raw){
      if(typeof raw !== 'string') return '';
      try {
        return decodeURIComponent(escape(atob(raw)));
      } catch {
        try {
          return atob(raw);
        } catch {
          return typeof raw === 'string' ? raw : '';
        }
      }
    }
    const ADMIN_USERNAME = 'admin';
    const ADMIN_DISPLAY_NAME = '超级管理员';
    const ADMIN_DEFAULT_PASSWORD = '19971109';
    const ADMIN_PASSWORD_HASH = hashPassword(ADMIN_DEFAULT_PASSWORD);
    const LOGIN_STORAGE_KEY = 'scheduler_login_cache_v1';
    const LOGIN_STORAGE_TTL = 30 * 24 * 60 * 60 * 1000;
    function defaultMenuPerms(overrides){
      const base = {};
      MENU_KEYS.forEach(key=>{ base[key] = { visible:true, editable:true }; });
      base.roles.visible = false;
      if(overrides){
        Object.entries(overrides).forEach(([key,conf])=>{
          if(!base[key]) return;
          base[key] = { ...base[key], ...conf };
        });
      }
      return base;
    }
    function normalizeMenuPerms(perms){
      const base = defaultMenuPerms();
      if(!perms || typeof perms !== 'object') return base;
      MENU_KEYS.forEach(key=>{
        const conf = perms[key];
        if(conf && typeof conf === 'object'){
          if(typeof conf.visible === 'boolean') base[key].visible = conf.visible;
          if(typeof conf.editable === 'boolean') base[key].editable = conf.editable;
        }
      });
      return base;
    }
    function ensureUniqueId(base, existing){
      let id = base;
      let idx = 1;
      while(existing.has(id)){
        id = `${base}-${idx++}`;
      }
      existing.add(id);
      return id;
    }
    function sanitizeIdFromName(name){
      const base = (name||'team').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
      return base || 'team';
    }
    function normalizeTeamEntry(team, existing){
      const inputId = (team && typeof team.id === 'string' && team.id.trim()) ? team.id.trim() : sanitizeIdFromName(team?.name||'');
      const id = ensureUniqueId(inputId, existing);
      const features = team?.features && typeof team.features === 'object' ? team.features : {};
      return {
        id,
        name: (team && typeof team.name === 'string' && team.name.trim()) ? team.name.trim() : `团队${existing.size}`,
        remark: (team && typeof team.remark === 'string') ? team.remark : '',
        features: {
          albumScheduler: features.albumScheduler !== false,
        }
      };
    }
    function normalizeBackupConfig(raw){
      const base = { intervalMinutes: 10, limit: 50 };
      if(!raw || typeof raw !== 'object') return { ...base };
      const intervalRaw = raw.intervalMinutes ?? raw.interval_minutes ?? raw.interval ?? 10;
      const limitRaw = raw.limit ?? raw.maxCount ?? raw.max_count ?? 50;
      const interval = Number.isFinite(Number(intervalRaw)) ? Math.max(1, Math.round(Number(intervalRaw))) : 10;
      const limit = Number.isFinite(Number(limitRaw)) ? Math.max(1, Math.round(Number(limitRaw))) : 50;
      return { intervalMinutes: interval, limit };
    }
    function defaultOrgConfig(){
      return {
        teams: [
          { id:'default', name:'默认团队', remark:'', features:{ albumScheduler:true } }
        ],
        accounts: [
          {
            username: ADMIN_USERNAME,
            displayName: ADMIN_DISPLAY_NAME,
            role:'super',
            passwordHash: ADMIN_PASSWORD_HASH,
            menus: defaultMenuPerms({ roles:{ visible:true } }),
            teamAccess:['*']
          }
        ],
        backup: normalizeBackupConfig()
      };
    }
    function normalizeOrgConfig(raw){
      const defaults = defaultOrgConfig();
      const teamsInput = Array.isArray(raw?.teams) && raw.teams.length ? raw.teams : defaults.teams;
      const existing = new Set();
      const teams = teamsInput.map(team=> normalizeTeamEntry(team, existing));
      if(!teams.length){
        const fallback = normalizeTeamEntry(defaults.teams[0], existing);
        teams.push(fallback);
      }
      const teamIds = new Set(teams.map(t=>t.id));
      const accounts = [];
      if(Array.isArray(raw?.accounts)){
        raw.accounts.forEach(acc=>{
          if(!acc || typeof acc.username !== 'string') return;
          const username = acc.username.trim();
          if(!username || username === 'admin') return;
          const menus = normalizeMenuPerms(acc.menus);
          let access = ['*'];
          if(Array.isArray(acc.teamAccess)){
            const cleaned = acc.teamAccess.filter(id=> id==='*' || teamIds.has(id));
            const unique = Array.from(new Set(cleaned));
            if(unique.includes('*')){
              access = ['*'];
            } else if(unique.length>0){
              access = unique;
            } else if(acc.teamAccess.length === 0){
              access = [];
            }
          }
          accounts.push({
            username,
            displayName: typeof acc.displayName === 'string' ? acc.displayName : '',
            role: acc.role === 'manager' ? 'manager' : 'guest',
            passwordHash: typeof acc.passwordHash === 'string' ? acc.passwordHash : '',
            menus,
            teamAccess: access
          });
        });
      }
      const adminMenus = defaultMenuPerms({ roles:{ visible:true } });
      const adminAccount = {
        username: ADMIN_USERNAME,
        displayName: ADMIN_DISPLAY_NAME,
        role:'super',
        passwordHash: ADMIN_PASSWORD_HASH,
        menus: adminMenus,
        teamAccess:['*']
      };
      accounts.push(adminAccount);
      const backup = normalizeBackupConfig(raw?.backup || defaults.backup);
      return { teams, accounts, backup };
    }
    function createEmptyTeamState(rangeStart, rangeEnd){
      return {
        start: rangeStart,
        end: rangeEnd,
        viewStart: rangeStart,
        viewEnd: rangeEnd,
        employees: [],
        data: {},
        versionId: null,
        shiftColors: { ...defaultShiftColors },
        staffingAlerts: normalizeStaffingAlerts(),
        adminDays: 0,
        restPrefs: {},
        nightWindows: [{ s: rangeStart, e: rangeEnd }],
        nightOverride: true,
        nightRules: normalizeNightRules(),
        rMin: 0.3,
        rMax: 0.7,
        pMin: 0.3,
        pMax: 0.7,
        mixMax: 1,
        note: '',
        albumWhiteHour: 0.22,
        albumMidHour: 0.06,
        albumRangeStartMonth: rangeStart.slice(0,7),
        albumRangeEndMonth: rangeEnd.slice(0,7),
        albumMaxDiff: 0.5,
        albumAssignments: {},
        albumAutoNote: '',
        albumSelected: {},
        batchChecked: {},
        albumHistory: [],
        historyProfile: null,
        yearlyOptimize: false,
        updatedAt: null,
        lastBackupAt: null
      };
    }
    const ORG_STORAGE_KEY = 'scheduler_org_config_v1';
    const TEAM_STATE_STORAGE_KEY = 'scheduler_team_states_v1';
    const pairToSet = (p)=>{
      const cleaned = sanitizeRestPairValue(p);
      if(cleaned.length !== 2) return new Set();
      const m={"1":1,"2":2,"3":3,"4":4,"5":5,"6":6,"7":7};
      const set = new Set();
      const first = m[cleaned[0]];
      const second = m[cleaned[1]];
      if(typeof first === 'number') set.add(first);
      if(typeof second === 'number') set.add(second);
      return set;
    };
    const dayToW = (day)=> ((new Date(day).getDay()+6)%7)+1; // 周一=1 ... 周日=7
    function isRestDayForEmp(restPrefs, emp, day){ const p = restPrefs?.[emp]; if(!p) return false; const set = pairToSet(p); const w = dayToW(day); return set.has(w); }

    const schedulerAlgorithms = window.SchedulerAlgorithms.create({
      enumerateDates,
      dateAdd,
      getVal,
      setVal,
      isWork,
      wouldExceed6,
      normalizeNightRules,
      isRestDayForEmp
    });
    const {
      buildWhiteFiveTwo,
      applyAlternateByCycle,
      clampDailyByRange,
      clampPersonByRange,
      adjustWithHistory,
      autoAssignNightAndM2,
      sortedByHistory,
      statsForEmployee,
      longestRun,
      mixedCyclesCount,
      cyclesForEmp,
      repairNoMidToWhite,
      planAlbumSchedule
    } = schedulerAlgorithms;

    const waitForFrame = () => new Promise(resolve => {
      if(typeof window !== 'undefined' && window.requestAnimationFrame){
        window.requestAnimationFrame(()=> resolve());
      } else {
        setTimeout(resolve, 16);
      }
    });
    const MenuButton = ({ active, icon, children, onClick }) => (
      <button
        type="button"
        onClick={onClick}
        className={`group relative w-full flex items-center gap-3 rounded-2xl border transition-all duration-200 ${active
          ? 'border-transparent bg-gradient-to-r from-indigo-500 via-sky-500 to-cyan-500 text-white shadow-lg shadow-indigo-200/60'
          : 'border-transparent bg-white/70 text-gray-600 hover:border-indigo-100 hover:bg-white hover:shadow-md'}`}
      >
        <span className={`flex h-9 w-9 items-center justify-center rounded-xl transition-colors ${active
          ? 'bg-white/20 text-white'
          : 'bg-indigo-50 text-indigo-500 group-hover:bg-indigo-100 group-hover:text-indigo-600'}`}>
          <Icon name={icon} />
        </span>
        <span className="text-sm font-medium tracking-wide">{children}</span>
        {active && <span className="ml-auto h-2 w-2 rounded-full bg-white/80 shadow"></span>}
      </button>
    );

    function SideDock({tab,setTab, menuPerms}){
      const [open, setOpen] = useState(false);
      const [hovering, setHovering] = useState(false);
      const expanded = open || hovering;
      const items = [
        { key:'grid', icon:'grid', label:'排班表格' },
        { key:'batch', icon:'magic', label:'自动分配班次' },
        { key:'album', icon:'magic', label:'专辑审核自动排班' },
        { key:'users', icon:'users', label:'员工管理' },
        { key:'stats', icon:'chart', label:'统计与对齐' },
        { key:'history', icon:'history', label:'备份记录' },
        { key:'settings', icon:'cog', label:'设置 / 导出' },
        { key:'roles', icon:'lock', label:'角色设置' }
      ];
      return (
        <div
          className="dock fixed left-4 top-28 bottom-12 z-40 flex items-center"
          onMouseEnter={()=> setHovering(true)}
          onMouseLeave={()=> setHovering(false)}
        >
          <div
            className={`dock-panel absolute left-0 top-0 bottom-0 w-64 transform transition-all duration-300 ${expanded ? 'translate-x-0 opacity-100' : '-translate-x-[120%] opacity-0 pointer-events-none'} bg-white/90 backdrop-blur-xl rounded-3xl border border-indigo-100 shadow-2xl shadow-indigo-100/50 p-3 space-y-2`}
          >
            {items.filter(item=> menuPerms?.[item.key]?.visible).map(item=> (
              <MenuButton key={item.key} active={tab===item.key} icon={item.icon} onClick={()=>setTab(item.key)}>{item.label}</MenuButton>
            ))}
          </div>
          <button
            type="button"
            className={`dock-tab relative ml-3 flex h-12 w-12 items-center justify-center rounded-full border text-indigo-500 shadow-lg transition-all duration-300 ${expanded ? 'border-indigo-200 bg-white/90 shadow-indigo-200/70' : 'border-indigo-100 bg-white/80 hover:bg-white'}`}
            onClick={()=> setOpen(v=> !v)}
          >
            <span className="sr-only">{expanded ? '收起导航' : '展开导航'}</span>
            <svg viewBox="0 0 20 20" className={`h-5 w-5 transition-transform ${expanded ? 'rotate-180' : ''}`}><path d="M12.5 4.5l-5 5.5 5 5.5" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>
          </button>
        </div>
      );
    }

    function TeamSwitcher({teams, value, onChange, disabled, onManage, canManage}){
      const hasTeams = teams && teams.length>0;
      return (
        <div className="flex items-center gap-2">
          <select className={`border rounded px-3 py-1.5 ${disabled?'bg-gray-100 cursor-not-allowed':''}`} value={hasTeams? value : ''}
            onChange={e=> onChange(e.target.value)} disabled={disabled || !hasTeams}>
            {hasTeams ? teams.map(team=> <option key={team.id} value={team.id}>{team.name}</option>) : <option value="">暂无团队</option>}
          </select>
          {canManage && (
            <button type="button" onClick={onManage} className="p-1.5 rounded-full border text-gray-500 hover:text-indigo-600 hover:border-indigo-300" title="管理团队与权限">
              <Icon name="cog" />
            </button>
          )}
        </div>
      );
    }

    function LoginModal({onSuccess, accounts}){
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [remember, setRemember] = useState(false);
      const [err, setErr] = useState('');
      const [loading, setLoading] = useState(false);
      useEffect(()=>{
        try{
          const raw = localStorage.getItem(LOGIN_STORAGE_KEY);
          if(!raw) return;
          const parsed = JSON.parse(raw);
          if(parsed && typeof parsed === 'object'){
            const expiresAt = typeof parsed.expiresAt === 'number' ? parsed.expiresAt : 0;
            if(expiresAt && expiresAt > Date.now()){
              const savedUsername = typeof parsed.username === 'string' ? parsed.username : '';
              const savedPassword = decodeCredential(parsed.password || '');
              setUsername(savedUsername);
              setPassword(savedPassword);
              setRemember(true);
            } else {
              localStorage.removeItem(LOGIN_STORAGE_KEY);
            }
          }
        }catch{}
      }, []);
      const persistLogin = (shouldRemember, nextUsername, nextPassword)=>{
        try{
          if(shouldRemember && nextUsername && nextPassword){
            const payload = {
              username: nextUsername,
              password: encodeCredential(nextPassword),
              expiresAt: Date.now() + LOGIN_STORAGE_TTL
            };
            localStorage.setItem(LOGIN_STORAGE_KEY, JSON.stringify(payload));
          } else {
            localStorage.removeItem(LOGIN_STORAGE_KEY);
          }
        }catch{}
      };
      async function doLogin(e){
        e.preventDefault();
        setErr('');
        const trimmedUsername = username.trim();
        if(!trimmedUsername || !password){
          setErr('请输入账号和密码');
          return;
        }
        if(trimmedUsername !== username){
          setUsername(trimmedUsername);
        }
        const accountEntry = Array.isArray(accounts) ? accounts.find(acc=> acc.username === trimmedUsername) : null;
        if(accountEntry){
          if(!verifyPassword(accountEntry.passwordHash, password)){
            setErr('密码错误');
            return;
          }
          if(trimmedUsername === ADMIN_USERNAME){
            try{
              setLoading(true);
              const res = await apiPost('/login', { username: trimmedUsername, password });
              persistLogin(remember, trimmedUsername, password);
              onSuccess({ ...res.user, localAccount: false });
            } catch(ex){
              setErr(ex.message||'登录失败');
            } finally {
              setLoading(false);
            }
            return;
          }
          persistLogin(remember, trimmedUsername, password);
          onSuccess({ username: accountEntry.username, display_name: accountEntry.displayName || '', role: accountEntry.role, localAccount: true });
          return;
        }
        try{
          setLoading(true);
          const res = await apiPost('/login', { username: trimmedUsername, password });
          persistLogin(remember, trimmedUsername, password);
          onSuccess(res.user);
        } catch(ex){
          setErr(ex.message||'登录失败');
        } finally {
          setLoading(false);
        }
      }
      return (
        <div className="fixed inset-0 bg-black/20 backdrop-blur flex items-center justify-center z-50">
          <form onSubmit={doLogin} className="bg-white rounded-2xl shadow-xl p-6 w-[360px] animate-fade-in">
            <h2 className="text-lg font-semibold mb-4 text-center">管理员登录</h2>
            <div className="space-y-3">
              <div>
                <label className="block text-sm text-gray-600 mb-1">用户名</label>
                <input className="w-full border rounded px-3 py-2" value={username}
                  disabled={loading}
                  onCompositionStart={()=>{}}
                  onCompositionEnd={(e)=>setUsername(e.target.value)}
                  onChange={e=>setUsername(e.target.value)} />
              </div>
              <div>
                <label className="block text-sm text-gray-600 mb-1">密码</label>
                <input type="password" className="w-full border rounded px-3 py-2" value={password}
                  disabled={loading}
                  onCompositionStart={()=>{}}
                  onCompositionEnd={(e)=>setPassword(e.target.value)}
                  onChange={e=>setPassword(e.target.value)} />
              </div>
              <label className="flex items-center gap-2 text-sm text-gray-600">
                <input type="checkbox" className="rounded border-gray-300" disabled={loading}
                  checked={remember}
                  onChange={e=> setRemember(e.target.checked)} />
                <span>记住账号密码（保存30天）</span>
              </label>
              {err && <div className="text-sm text-red-600">{err}</div>}
              <button type="submit" disabled={loading} className={`w-full rounded-full text-white py-2 transition flex items-center justify-center gap-2 ${loading?'bg-indigo-400 cursor-not-allowed':'bg-indigo-600 hover:bg-indigo-500'}`}>
                {loading && <Spinner className="w-4 h-4 text-white" />}
                <span>登录</span>
              </button>
            </div>
          </form>
        </div>
      );
    }

    const MonthInput = React.memo(function MonthInputComponent({ value, onChange, disabled=false, className='', placeholder='YYYY-MM' }){
      const [draft, setDraft] = useState(()=> value || '');
      useEffect(()=>{ setDraft(value || ''); }, [value]);
      const format = (raw)=>{
        const digits = String(raw||'').replace(/[^0-9]/g,'');
        let next = digits.slice(0,4);
        if(digits.length > 4){
          next += '-' + digits.slice(4,6);
        }
        return next;
      };
      const commit = (input)=>{
        if(!onChange) return;
        if(!input){ onChange(''); return; }
        const match = input.match(/^(\d{4})(?:-(\d{1,2}))?$/);
        if(!match){ onChange(value || ''); return; }
        const year = match[1];
        const monthRaw = match[2] ?? '';
        const monthNum = monthRaw ? parseInt(monthRaw, 10) : NaN;
        const month = Number.isFinite(monthNum) ? Math.min(12, Math.max(1, monthNum)) : 1;
        const normalized = `${year}-${String(month).padStart(2,'0')}`;
        onChange(normalized);
        setDraft(normalized);
      };
      const handleChange = (e)=>{
        if(disabled) return;
        const formatted = format(e.target.value);
        setDraft(formatted);
        if(formatted.length >= 7){
          commit(formatted);
        } else if(formatted === ''){
          if(onChange) onChange('');
        }
      };
      const handleBlur = ()=>{
        if(disabled) return;
        if(!draft){
          if(onChange) onChange('');
          return;
        }
        commit(draft);
      };
      return (
        <input type="text" inputMode="numeric" pattern="\d{4}-\d{2}" className={className}
          value={draft}
          placeholder={placeholder}
          disabled={disabled}
          onChange={handleChange}
          onBlur={handleBlur}
        />
      );
    });

    function App(){
      const [user, setUser] = useState(null);
      useEffect(()=>{ (async()=>{ try{ await apiPost('/logout',{}); } catch{} finally { setUser(null); } })(); },[]);

      const [orgConfig, setOrgConfig] = useState(()=>{
        try{
          const raw = JSON.parse(localStorage.getItem(ORG_STORAGE_KEY)||'null');
          return normalizeOrgConfig(raw||undefined);
        }catch{
          return normalizeOrgConfig();
        }
      });
      const updateOrgConfig = (updater)=>{
        setOrgConfig(prev=>{
          const base = typeof updater === 'function' ? updater(prev) : updater;
          return normalizeOrgConfig(base);
        });
      };
      useEffect(()=>{ try{ localStorage.setItem(ORG_STORAGE_KEY, JSON.stringify(orgConfig)); }catch{} }, [orgConfig]);
      const orgConfigLoadedRef = useRef(false);
      const lastSyncedOrgConfigRef = useRef('');
      useEffect(()=>{
        let cancelled = false;
        (async()=>{
          try{
            const res = await apiGet('/org-config');
            if(cancelled) return;
            if(res && res.config && typeof res.config === 'object'){
              const normalized = normalizeOrgConfig(res.config);
              lastSyncedOrgConfigRef.current = JSON.stringify(normalized);
              updateOrgConfig(normalized);
            }
          }catch(e){
            console.warn('加载 org 配置失败', e);
          } finally {
            if(!cancelled){
              orgConfigLoadedRef.current = true;
            }
          }
        })();
        return ()=>{ cancelled = true; };
      }, []);
      useEffect(()=>{
        if(!orgConfigLoadedRef.current) return;
        const serialized = JSON.stringify(orgConfig);
        if(serialized === lastSyncedOrgConfigRef.current) return;
        const timer = setTimeout(()=>{
          (async()=>{
            try{
              await apiPost('/org-config', { config: orgConfig });
              lastSyncedOrgConfigRef.current = serialized;
            }catch(e){
              console.warn('保存 org 配置失败', e);
            }
          })();
        }, 400);
        return ()=> clearTimeout(timer);
      }, [orgConfig]);

      const [defaultStart, defaultEnd] = useMemo(()=> monthRangeOf(today), []);
      const [teamStateMap, setTeamStateMap] = useState(()=>{
        try{
          const raw = JSON.parse(localStorage.getItem(TEAM_STATE_STORAGE_KEY)||'{}');
          if(raw && typeof raw === 'object') return raw;
        }catch{}
        return {};
      });
      useEffect(()=>{ try{ localStorage.setItem(TEAM_STATE_STORAGE_KEY, JSON.stringify(teamStateMap)); }catch{} }, [teamStateMap]);
      useEffect(()=>{
        setTeamStateMap(prev=>{
          let changed = false;
          const next = { ...prev };
          const valid = new Set();
          orgConfig.teams.forEach(team=>{
            valid.add(team.id);
            if(!next[team.id]){
              next[team.id] = createEmptyTeamState(defaultStart, defaultEnd);
              changed = true;
            }
          });
          Object.keys(next).forEach(id=>{
            if(!valid.has(id)){
              delete next[id];
              changed = true;
            }
          });
          return changed ? next : prev;
        });
      }, [orgConfig.teams, defaultStart, defaultEnd]);

      const [team, setTeam] = useState(()=> (orgConfig.teams?.[0]?.id || 'default'));
      const [note, setNote] = useState('');
      const [serverUpdatedAt, setServerUpdatedAt] = useState(null);
      const [lastBackupAt, setLastBackupAt] = useState(null);
      const [planStart, setPlanStart] = useState(defaultStart);
      const [planEnd, setPlanEnd]     = useState(defaultEnd);
      const [viewStart, setViewStart] = useState(defaultStart);
      const [viewEnd, setViewEnd]     = useState(defaultEnd);
      const viewManuallyAdjustedRef = useRef(false);
      const [employees, setEmployees] = useState([]);
      const [data, setData] = useState({});
      const [versionId, setVersionId] = useState(null);
      const [versions, setVersions]   = useState([]);
      const [versionsLoading, setVersionsLoading] = useState(false);
      const [showAutoSaves, setShowAutoSaves] = useState(false);
      const filteredVersions = useMemo(()=>{
        if(showAutoSaves) return versions;
        return versions.filter(v=>{
          const operator = (v?.created_by_name || v?.created_by || '').trim();
          return !isAutoSaveLabel(operator);
        });
      }, [versions, showAutoSaves]);
      const [versionDeletingId, setVersionDeletingId] = useState(null);
      const [logExportStart, setLogExportStart] = useState('');
      const [logExportEnd, setLogExportEnd] = useState('');
      const [logExporting, setLogExporting] = useState(false);
      const [logExportError, setLogExportError] = useState('');
      const [toast, setToast] = useState(null);
      useEffect(()=>{ lastSyncedSnapshotRef.current = null; }, [team]);
      const toastTimerRef = useRef(null);
      useEffect(()=>{
        return ()=>{
          if(toastTimerRef.current) clearTimeout(toastTimerRef.current);
        };
      }, []);
      const showToast = (message, type = 'info', duration = 2600) => {
        if(!message) return;
        if(toastTimerRef.current) clearTimeout(toastTimerRef.current);
        setToast({ message, type });
        toastTimerRef.current = setTimeout(()=> setToast(null), duration);
      };

      const [prog, setProg] = useState({ running:false, stage:'', done:0, total:100 });
      const [logs, setLogs] = useState([]);
      const logEndRef = useRef(null);
      const pushLog = (msg)=> setLogs(prev=> [...prev.slice(-199), `[${new Date().toLocaleTimeString()}] ${msg}`]);
      useEffect(()=>{ if(prog.running){ const t = setInterval(()=>{ pushLog('心跳：计算中…'); }, 1000); return ()=> clearInterval(t); } }, [prog.running]);
      useEffect(()=>{ logEndRef.current && logEndRef.current.scrollIntoView({behavior:'auto'}); }, [logs]);
      const setStage = (stage, done, total)=> { setProg({ running:true, stage, done, total }); pushLog(stage); };
      const endStage = ()=> { setProg({ running:false, stage:'完成', done:100, total:100 }); pushLog('执行完成'); };

      const [batchChecked, setBatchChecked] = useState({});
      const checkedList = useMemo(()=> employees.filter(e=>batchChecked[e]), [employees, batchChecked]);

      const [albumSelected, setAlbumSelected] = useState({});
      const albumCheckedList = useMemo(()=> employees.filter(e=> albumSelected[e]), [employees, albumSelected]);
      const [albumWhiteHour, setAlbumWhiteHour] = useState(0.22);
      const [albumMidHour, setAlbumMidHour] = useState(0.06);
      const [albumRangeStartMonth, setAlbumRangeStartMonth] = useState(defaultStart.slice(0,7));
      const [albumRangeEndMonth, setAlbumRangeEndMonth] = useState(defaultEnd.slice(0,7));
      const [albumMaxDiff, setAlbumMaxDiff] = useState(0.5);
      const [albumAssignments, setAlbumAssignments] = useState({});
      const [albumAutoNote, setAlbumAutoNote] = useState('');
      const [albumHistory, setAlbumHistory] = useState([]);
      const [accountPasswordDrafts, setAccountPasswordDrafts] = useState({});
      const [accountDisplayDrafts, setAccountDisplayDrafts] = useState({});
      const importInputRef = useRef(null);
      const [importing, setImporting] = useState(false);

      useEffect(()=>{
        if(viewManuallyAdjustedRef.current) return;
        setViewStart(planStart);
        setViewEnd(planEnd);
      }, [planStart, planEnd]);

      const [shiftColors, setShiftColors] = useState({ ...defaultShiftColors });
      const [staffingAlerts, setStaffingAlerts] = useState(()=> normalizeStaffingAlerts());
      const [adminDays, setAdminDays] = useState(0);
      const [restPrefs, setRestPrefs] = useState({});
      const [nightWindows, setNightWindows] = useState([{ s: defaultStart, e: defaultEnd }]);
      const [nightOverride, setNightOverride] = useState(true);
      const [nightRules, setNightRules] = useState(()=> normalizeNightRules());

      const [historyProfile, setHistoryProfile] = useState(null);

      const [rMin, setRMin] = useState(0.3);
      const [rMax, setRMax] = useState(0.7);
      const [pMin, setPMin] = useState(0.3);
      const [pMax, setPMax] = useState(0.7);
      const [mixMax, setMixMax] = useState(1);
      const [yearlyOptimize, setYearlyOptimize] = useState(false);

      const manualPlanAdjustRef = useRef(false);
      const handlePlanStartChange = useCallback((value)=>{
        manualPlanAdjustRef.current = true;
        setPlanStart(value);
      }, [setPlanStart]);
      const handlePlanEndChange = useCallback((value)=>{
        manualPlanAdjustRef.current = true;
        setPlanEnd(value);
      }, [setPlanEnd]);

      const skipSaveRef = useRef(false);
      const skipLoadRef = useRef(false);
      const initializedRef = useRef(false);

      const snapshotRef = useRef(null);
      const lastSyncedSnapshotRef = useRef(null);
      const lastSavedSnapshotRef = useRef('');
      const pendingAutoSaveRef = useRef(false);
      const [autoSaveTicker, setAutoSaveTicker] = useState(0);
      const autoSaveSendingRef = useRef(false);
      const initialTeamSyncRef = useRef({});

      useEffect(()=>{
        if(skipLoadRef.current){
          skipLoadRef.current = false;
          return;
        }
        const base = teamStateMap[team];
        const fallback = createEmptyTeamState(defaultStart, defaultEnd);
        const merged = base ? { ...fallback, ...base } : fallback;
        skipSaveRef.current = true;
        const nextPlanStart = merged.start || defaultStart;
        const nextPlanEnd = merged.end || defaultEnd;
        setPlanStart(nextPlanStart);
        setPlanEnd(nextPlanEnd);
        viewManuallyAdjustedRef.current = false;
        setViewStart(merged.viewStart || nextPlanStart);
        setViewEnd(merged.viewEnd || nextPlanEnd);
        setEmployees(Array.isArray(merged.employees) ? merged.employees : []);
        setData(merged.data || {});
        setVersionId(merged.versionId || null);
        setShiftColors(merged.shiftColors ? { ...defaultShiftColors, ...merged.shiftColors } : { ...defaultShiftColors });
        setStaffingAlerts(normalizeStaffingAlerts(merged.staffingAlerts));
        setAdminDays(Number(merged.adminDays||0));
        setRestPrefs(sanitizeRestPrefsMap(merged.restPrefs||{}));
        const wins = Array.isArray(merged.nightWindows) && merged.nightWindows.length ? merged.nightWindows : [{ s: nextPlanStart, e: nextPlanEnd }];
        setNightWindows(wins.map(w=> ({ s: w.s || nextPlanStart, e: w.e || nextPlanEnd })));
        setNightOverride(merged.nightOverride !== undefined ? !!merged.nightOverride : true);
        setNightRules(normalizeNightRules(merged.nightRules));
        setRMin(typeof merged.rMin === 'number' ? merged.rMin : 0.3);
        setRMax(typeof merged.rMax === 'number' ? merged.rMax : 0.7);
        setPMin(typeof merged.pMin === 'number' ? merged.pMin : 0.3);
        setPMax(typeof merged.pMax === 'number' ? merged.pMax : 0.7);
        setMixMax(typeof merged.mixMax === 'number' ? merged.mixMax : 1);
        setYearlyOptimize(merged.yearlyOptimize === true);
        setNote(typeof merged.note === 'string' ? merged.note : '');
        setBatchChecked(merged.batchChecked || {});
        setAlbumSelected(merged.albumSelected || {});
        setAlbumWhiteHour(typeof merged.albumWhiteHour === 'number' ? merged.albumWhiteHour : 0.22);
        setAlbumMidHour(typeof merged.albumMidHour === 'number' ? merged.albumMidHour : 0.06);
        const startMonth = (merged.albumRangeStartMonth || nextPlanStart).slice(0,7);
        const endMonth = (merged.albumRangeEndMonth || nextPlanEnd).slice(0,7);
        setAlbumRangeStartMonth(startMonth);
        setAlbumRangeEndMonth(endMonth);
        setAlbumMaxDiff(typeof merged.albumMaxDiff === 'number' ? merged.albumMaxDiff : 0.5);
        setAlbumAssignments(merged.albumAssignments || {});
        setAlbumAutoNote(typeof merged.albumAutoNote === 'string' ? merged.albumAutoNote : '');
        setAlbumHistory(Array.isArray(merged.albumHistory) ? merged.albumHistory.map(item=> ({ ...item, assignments: item.assignments || {} })) : []);
        setHistoryProfile(merged.historyProfile || null);
        initializedRef.current = true;
      }, [team, teamStateMap, defaultStart, defaultEnd]);

      useEffect(()=>{
        if(!initializedRef.current) return;
        if(skipSaveRef.current){
          skipSaveRef.current = false;
          return;
        }
        const snapshot = {
          start: planStart,
          end: planEnd,
          viewStart,
          viewEnd,
          employees,
          data,
          versionId,
          shiftColors,
          staffingAlerts,
          adminDays,
          restPrefs: sanitizeRestPrefsMap(restPrefs),
          nightWindows,
          nightOverride,
          nightRules,
          rMin,
          rMax,
          pMin,
          pMax,
          mixMax,
          note,
          batchChecked,
          albumSelected,
          albumWhiteHour,
          albumMidHour,
          albumRangeStartMonth,
          albumRangeEndMonth,
          albumMaxDiff,
          albumAssignments,
          albumAutoNote,
          albumHistory: Array.isArray(albumHistory) ? albumHistory.map(item=> ({ ...item, assignments: item.assignments || {} })) : [],
          historyProfile,
          yearlyOptimize
        };
        const snapshotForRef = {
          ...snapshot,
          employees: Array.isArray(employees) ? employees.slice() : [],
          shiftColors: { ...shiftColors },
          staffingAlerts: { ...staffingAlerts },
          restPrefs: sanitizeRestPrefsMap(restPrefs),
          nightWindows: Array.isArray(nightWindows) ? nightWindows.map(w=> ({ s: w.s, e: w.e })) : [],
          batchChecked: batchChecked ? { ...batchChecked } : {},
          albumSelected: albumSelected ? { ...albumSelected } : {},
          albumAssignments: albumAssignments ? { ...albumAssignments } : {},
          albumHistory: Array.isArray(snapshot.albumHistory) ? snapshot.albumHistory.map(item=> ({ ...item, assignments: { ...(item.assignments || {}) } })) : []
        };
        snapshotRef.current = snapshotForRef;
        let serialized = '';
        try{ serialized = JSON.stringify(snapshotForRef); }catch(e){ serialized = ''; }
        if(serialized && serialized === lastSavedSnapshotRef.current){
          pendingAutoSaveRef.current = false;
        } else {
          const shouldQueue = snapshotHasMeaningfulData(snapshotForRef) && serialized !== lastSavedSnapshotRef.current;
          pendingAutoSaveRef.current = shouldQueue;
          if(shouldQueue){
            setAutoSaveTicker(tick=> tick + 1);
          }
        }
        skipLoadRef.current = true;
        setTeamStateMap(prev=> ({ ...prev, [team]: snapshot }));
      }, [team, planStart, planEnd, viewStart, viewEnd, employees, data, versionId, shiftColors, staffingAlerts, adminDays, restPrefs, nightWindows, nightOverride, nightRules, rMin, rMax, pMin, pMax, mixMax, note, batchChecked, albumSelected, albumWhiteHour, albumMidHour, albumRangeStartMonth, albumRangeEndMonth, albumMaxDiff, albumAssignments, albumAutoNote, albumHistory, historyProfile, yearlyOptimize]);

      const REST_STORE_KEY = 'scheduler_restprefs_store_v2';
      function restStoreKey(team,start,end){ return `${team}__${start}__${end}`; }
      function loadRestStore(){ try{ return JSON.parse(localStorage.getItem(REST_STORE_KEY)||'{}'); }catch{ return {}; } }
      function saveRestStore(map){ try{ localStorage.setItem(REST_STORE_KEY, JSON.stringify(map||{})); }catch{} }
      function saveRestForView(){ const map = loadRestStore(); map[restStoreKey(team,planStart,planEnd)] = restPrefs; saveRestStore(map); }
      function tryRestoreRestForView(){ const map = loadRestStore(); const hit = map[restStoreKey(team,planStart,planEnd)]; if(hit && Object.keys(hit).length){ setRestPrefs(sanitizeRestPrefsMap(hit)); } }
      useEffect(()=>{ if(Object.keys(restPrefs||{}).length) saveRestForView(); }, [restPrefs, team, planStart, planEnd]);
      useEffect(()=>{ tryRestoreRestForView(); }, [team, planStart, planEnd]);

      const teamsList = orgConfig.teams || [];
      const backupConfig = useMemo(()=> normalizeBackupConfig(orgConfig.backup), [orgConfig.backup]);
      const accountConfig = useMemo(()=>{
        if(!user) return null;
        return orgConfig.accounts.find(acc=> acc.username === user.username) || null;
      }, [orgConfig, user]);
      const accessibleTeams = useMemo(()=>{
        if(!user) return teamsList;
        if(!accountConfig) return teamsList;
        const access = Array.isArray(accountConfig.teamAccess) ? accountConfig.teamAccess : ['*'];
        if(access.includes('*')) return teamsList;
        const allow = new Set(access);
        const filtered = teamsList.filter(t=> allow.has(t.id));
        if(filtered.length) return filtered;
        return access.length === 0 ? [] : teamsList;
      }, [teamsList, accountConfig, user]);
      useEffect(()=>{
        if(!accessibleTeams.some(t=> t.id === team) && accessibleTeams.length){
          setTeam(accessibleTeams[0].id);
        }
      }, [accessibleTeams, team]);

      useEffect(()=>{
        if(!user) return;
        const teamsToLoad = accessibleTeams.map(t=> t.id).filter(Boolean);
        if(!teamsToLoad.length) return;
        let cancelled = false;
        (async()=>{
          for(const teamId of teamsToLoad){
            if(cancelled) return;
            if(initialTeamSyncRef.current[teamId]) continue;
            initialTeamSyncRef.current[teamId] = true;
            try{
              const params = new URLSearchParams();
              params.set('team', teamId);
              const res = await apiGet(`/schedule?${params.toString()}`);
              if(cancelled) return;
              const payload = { ...res, versionId: res.version_id || res.versionId };
              const version = payload.versionId || null;
              if(teamId === team){
                if(pendingAutoSaveRef.current){
                  initialTeamSyncRef.current[teamId] = false;
                  continue;
                }
                if(version !== null && snapshotRef.current && snapshotRef.current.versionId === version) continue;
                applyServerState(payload);
              } else {
                const otherSnapshot = convertPayloadToTeamState(payload, { start: defaultStart, end: defaultEnd });
                if(otherSnapshot){
                  setTeamStateMap(prev=> ({ ...prev, [teamId]: otherSnapshot }));
                }
              }
              if(version){
                lastLoadedVersionRef.current[teamId] = version;
              }
            }catch(e){
              initialTeamSyncRef.current[teamId] = false;
              if(!cancelled){
                console.warn('加载团队最新排班失败', teamId, e);
              }
            }
          }
        })();
        return ()=>{ cancelled = true; };
      }, [user, accessibleTeams, team, defaultStart, defaultEnd]);
      const activeTeam = useMemo(()=> teamsList.find(t=> t.id === team) || teamsList[0] || { id: team, name: team, features:{ albumScheduler:true } }, [teamsList, team]);
      const teamFeatures = activeTeam?.features || { albumScheduler:true };
      const teamDisplayName = activeTeam?.name || team;
      const canManageRoles = !!(user && user.username === 'admin');

      const menuPerms = useMemo(()=>{
        const perms = defaultMenuPerms();
        if(accountConfig && accountConfig.menus){
          MENU_KEYS.forEach(key=>{
            const conf = accountConfig.menus[key];
            if(conf){
              if(typeof conf.visible === 'boolean') perms[key].visible = conf.visible;
              if(typeof conf.editable === 'boolean') perms[key].editable = conf.editable;
            }
          });
        }
        if(teamFeatures && teamFeatures.albumScheduler === false){
          perms.album.visible = false;
        }
        if(canManageRoles){
          perms.roles.visible = true;
        } else {
          perms.roles.visible = false;
          perms.roles.editable = false;
        }
        MENU_KEYS.forEach(key=>{ if(!perms[key].visible) perms[key].editable = false; });
        return perms;
      }, [accountConfig, teamFeatures, user]);

      const [tab, setTab] = useState('batch');
      const allowedTabs = useMemo(()=> MENU_KEYS.filter(key=> menuPerms[key]?.visible), [menuPerms]);
      useEffect(()=>{
        if(!allowedTabs.length) return;
        if(!allowedTabs.includes(tab)){
          setTab(allowedTabs[0]);
        }
      }, [allowedTabs, tab]);

      useEffect(()=>{
        if(allowedTabs.length === 0 && tab !== 'batch'){
          setTab('batch');
        }
      }, [allowedTabs, tab]);

      const viewReadOnly = menuPerms[tab]?.editable === false;
      const editingLocked = prog.running || viewReadOnly;
      useEffect(()=>{ setVersions([]); }, [team]);

      const menuLabels = {
        grid: '排班表格',
        batch: '自动分配班次',
        album: '专辑审核',
        users: '员工管理',
        stats: '统计与对齐',
        history: '备份记录',
        settings: '设置 / 导出',
        roles: '角色设置'
      };

      const addTeam = ()=>{
        updateOrgConfig(prev=>{
          const existing = new Set((prev.teams||[]).map(t=>t.id));
          const newId = ensureUniqueId(`team-${(prev.teams||[]).length+1}`, existing);
          const newTeam = { id:newId, name:`新团队${(prev.teams||[]).length+1}`, remark:'', features:{ albumScheduler:true } };
          return { ...prev, teams: [...(prev.teams||[]), newTeam] };
        });
      };
      const updateTeamField = (id, key, value)=>{
        updateOrgConfig(prev=>({
          ...prev,
          teams: prev.teams.map(t=> t.id===id ? { ...t, [key]: value } : t)
        }));
      };
      const updateTeamFeature = (id, key, value)=>{
        updateOrgConfig(prev=>({
          ...prev,
          teams: prev.teams.map(t=> t.id===id ? { ...t, features: { ...(t.features||{}), [key]: value } } : t)
        }));
      };
      const removeTeam = (id)=>{
        if((orgConfig.teams||[]).length<=1){ alert('至少保留一个团队'); return; }
        if(!confirm('确定删除该团队及其本地设置？')) return;
        updateOrgConfig(prev=>({
          ...prev,
          teams: prev.teams.filter(t=> t.id!==id)
        }));
        setTeamStateMap(prev=>{
          const next = { ...prev };
          delete next[id];
          return next;
        });
        if(team === id && teamsList.length>0){
          const fallback = teamsList.find(t=> t.id!==id);
          if(fallback) setTeam(fallback.id);
        }
      };

      const updateAccountConfig = (username, updater)=>{
        updateOrgConfig(prev=>({
          ...prev,
          accounts: prev.accounts.map(acc=> acc.username===username ? updater(acc) : acc)
        }));
      };
      const addAccount = ()=>{
        updateOrgConfig(prev=>{
          const base = `user${(prev.accounts||[]).length+1}`;
          const existing = new Set((prev.accounts||[]).map(acc=>acc.username));
          let candidate = base;
          let idx = 1;
          while(existing.has(candidate) || candidate==='admin'){
            candidate = `${base}${idx++}`;
          }
          const menus = defaultMenuPerms({ roles:{ visible:false, editable:false } });
          const nextAcc = { username:candidate, displayName:'', role:'guest', passwordHash:'', menus, teamAccess:['*'] };
          return { ...prev, accounts: [...prev.accounts, nextAcc] };
        });
      };
      const removeAccount = (username)=>{
        if(username==='admin') return;
        if(!confirm('确定删除该账号？')) return;
        updateOrgConfig(prev=>({
          ...prev,
          accounts: prev.accounts.filter(acc=> acc.username!==username)
        }));
        setAccountPasswordDrafts(prev=>{
          if(!(username in prev)) return prev;
          const next = { ...prev }; delete next[username]; return next;
        });
        setAccountDisplayDrafts(prev=>{
          if(!(username in prev)) return prev;
          const next = { ...prev }; delete next[username]; return next;
        });
        if(user && user.username === username){ setUser(null); }
      };
      const setAccountUsername = (username, nextUsername)=>{
        const trimmed = (nextUsername||'').trim();
        if(!trimmed || trimmed === 'admin'){
          alert('账号名不可为空或为 admin');
          return;
        }
        if(orgConfig.accounts.some(acc=> acc.username === trimmed && acc.username !== username)){
          alert('账号名已存在');
          return;
        }
        updateAccountConfig(username, acc=> ({ ...acc, username: trimmed }));
        setAccountPasswordDrafts(prev=>{
          if(!(username in prev)) return prev;
          const next = { ...prev };
          next[trimmed] = next[username];
          delete next[username];
          return next;
        });
        setAccountDisplayDrafts(prev=>{
          if(!(username in prev)) return prev;
          const next = { ...prev };
          next[trimmed] = next[username];
          delete next[username];
          return next;
        });
        if(user && user.username === username){ setUser(prev=> prev? { ...prev, username: trimmed } : prev); }
      };
      const setAccountDisplayDraft = (username, value)=>{
        setAccountDisplayDrafts(prev=> ({ ...prev, [username]: value }));
      };
      const setAccountDisplayName = (username, value)=>{
        const nextValue = typeof value === 'string' ? value.trim() : '';
        updateAccountConfig(username, acc=> ({ ...acc, displayName: nextValue }));
        setAccountDisplayDrafts(prev=>{
          if(!(username in prev)) return prev;
          const next = { ...prev };
          delete next[username];
          return next;
        });
      };
      const setAccountRole = (username, role)=> updateAccountConfig(username, acc=> ({ ...acc, role }));
      const setAccountPassword = (username)=>{
        const raw = accountPasswordDrafts[username] || '';
        updateAccountConfig(username, acc=> ({ ...acc, passwordHash: hashPassword(raw) }));
        setAccountPasswordDrafts(prev=> ({ ...prev, [username]: '' }));
      };
      const updateAccountPasswordDraft = (username, value)=>{
        setAccountPasswordDrafts(prev=> ({ ...prev, [username]: value }));
      };
      useEffect(()=>{
        setAccountDisplayDrafts(prev=>{
          const keep = {};
          const valid = new Set((orgConfig.accounts||[]).map(acc=> acc.username));
          let changed = false;
          Object.entries(prev).forEach(([key, val])=>{
            if(valid.has(key)){
              keep[key] = val;
            } else {
              changed = true;
            }
          });
          return changed ? keep : prev;
        });
      }, [orgConfig.accounts]);
      const updateAccountMenu = (username, key, field, value)=>{
        updateAccountConfig(username, acc=>{
          const baseMenus = defaultMenuPerms();
          const current = (acc.menus && acc.menus[key]) ? acc.menus[key] : baseMenus[key];
          const nextMenus = { ...acc.menus, [key]: { ...current, [field]: value } };
          if(!nextMenus[key].visible){ nextMenus[key].editable = false; }
          return { ...acc, menus: nextMenus };
        });
      };
      const setAccountAllTeams = (username, enabled)=>{
        updateAccountConfig(username, acc=> ({ ...acc, teamAccess: enabled ? ['*'] : [] }));
      };
      const setAccountTeamAccess = (username, teamId, enabled)=>{
        updateAccountConfig(username, acc=>{
          const allIds = teamsList.map(t=> t.id);
          let current = acc.teamAccess && acc.teamAccess.includes('*') ? allIds.slice() : Array.from(new Set(acc.teamAccess||[]));
          if(enabled){
            if(!current.includes(teamId)) current.push(teamId);
          } else {
            current = current.filter(id=> id!==teamId);
          }
          if(current.length >= allIds.length && allIds.length){
            return { ...acc, teamAccess:['*'] };
          }
          return { ...acc, teamAccess: current };
        });
      };
      const updateBackupSetting = (field, value)=>{
        updateOrgConfig(prev=>{
          const current = normalizeBackupConfig(prev.backup);
          const next = { ...current, [field]: value };
          return { ...prev, backup: next };
        });
      };

      const lastLoadedVersionRef = useRef({});
      const autoLoadedTeamRef = useRef({});
      useEffect(()=>{ lastLoadedVersionRef.current = {}; autoLoadedTeamRef.current = {}; }, [user?.username]);
      useEffect(()=>{
        snapshotRef.current = null;
        lastSavedSnapshotRef.current = '';
        pendingAutoSaveRef.current = false;
        autoSaveSendingRef.current = false;
        initialTeamSyncRef.current = {};
        if(user){
          setTeamStateMap({});
        }
        setServerUpdatedAt(null);
        setLastBackupAt(null);
      }, [user?.username]);
      const autoLoadKey = useMemo(()=>{
        const safeTeam = team || 'default';
        const safeStart = (planStart || '').slice(0,10);
        const safeEnd = (planEnd || '').slice(0,10);
        const flag = yearlyOptimize ? 'on' : 'off';
        return `${safeTeam}__${flag}__${safeStart}__${safeEnd}`;
      }, [team, planStart, planEnd, yearlyOptimize]);
      function snapshotHasMeaningfulData(snapshot){
        if(!snapshot || typeof snapshot !== 'object') return false;
        if(Array.isArray(snapshot.employees) && snapshot.employees.length) return true;
        if(typeof snapshot.note === 'string' && snapshot.note.trim()) return true;
        if(Number(snapshot.adminDays||0) > 0) return true;
        if(snapshot.restPrefs && Object.keys(snapshot.restPrefs).length) return true;
        if(snapshot.albumAutoNote && snapshot.albumAutoNote.trim()) return true;
        if(snapshot.albumAssignments && Object.keys(snapshot.albumAssignments).length) return true;
        if(Array.isArray(snapshot.albumHistory) && snapshot.albumHistory.length) return true;
        const data = snapshot.data || {};
        for(const day in data){
          const row = data[day] || {};
          for(const emp in row){
            const val = row[emp];
            if(val !== undefined && val !== null && String(val).trim() !== ''){
              return true;
            }
          }
        }
        return false;
      }

      function deepCloneSnapshot(snapshot){
        if(!snapshot || typeof snapshot !== 'object') return null;
        try {
          return JSON.parse(JSON.stringify(snapshot));
        } catch {
          return null;
        }
      }

      function computeSnapshotDiff(baseSnapshot, currentSnapshot){
        if(!currentSnapshot || typeof currentSnapshot !== 'object') return null;
        if(!baseSnapshot || typeof baseSnapshot !== 'object') return null;
        const diff = { fields:{}, data:{} };
        let changed = false;
        const keys = ['viewStart','viewEnd','start','end','employees','note','adminDays','restPrefs','nightRules','nightWindows','nightOverride','rMin','rMax','pMin','pMax','mixMax','shiftColors','staffingAlerts','batchChecked','albumSelected','albumWhiteHour','albumMidHour','albumRangeStartMonth','albumRangeEndMonth','albumMaxDiff','albumAssignments','albumAutoNote','albumHistory','historyProfile','yearlyOptimize'];
        keys.forEach(key=>{
          const baseVal = baseSnapshot[key];
          const curVal = currentSnapshot[key];
          if(!jsonEquals(baseVal, curVal)){
            diff.fields[key] = true;
            changed = true;
          }
        });
        const baseData = baseSnapshot && typeof baseSnapshot.data === 'object' ? baseSnapshot.data : {};
        const currentData = currentSnapshot && typeof currentSnapshot.data === 'object' ? currentSnapshot.data : {};
        const days = new Set([...Object.keys(baseData), ...Object.keys(currentData)]);
        days.forEach(day=>{
          const baseRow = baseData[day] && typeof baseData[day] === 'object' ? baseData[day] : {};
          const curRow = currentData[day] && typeof currentData[day] === 'object' ? currentData[day] : {};
          const emps = new Set([...Object.keys(baseRow), ...Object.keys(curRow)]);
          const rowDiff = {};
          emps.forEach(emp=>{
            const baseVal = baseRow[emp] === undefined || baseRow[emp] === null ? '' : String(baseRow[emp]);
            const curVal = curRow[emp] === undefined || curRow[emp] === null ? '' : String(curRow[emp]);
            if(baseVal !== curVal){
              rowDiff[emp] = curRow[emp] === undefined ? '' : curRow[emp];
            }
          });
          if(Object.keys(rowDiff).length){
            diff.data[day] = rowDiff;
            changed = true;
          }
        });
        return changed ? diff : null;
      }

      function convertPayloadToTeamState(payload, fallback = {}){
        if(!payload || typeof payload !== 'object') return null;
        const get = (...keys)=>{
          for(const key of keys){
            if(payload[key] !== undefined && payload[key] !== null){
              return payload[key];
            }
          }
          return undefined;
        };
        const fallbackStart = typeof fallback.start === 'string' && fallback.start ? fallback.start.slice(0,10) : (planStart || defaultStart);
        const fallbackEnd = typeof fallback.end === 'string' && fallback.end ? fallback.end.slice(0,10) : (planEnd || defaultEnd);
        const startRaw = get('start','planStart','viewStart','view_start');
        const endRaw = get('end','planEnd','viewEnd','view_end');
        const resolvedStart = typeof startRaw === 'string' && startRaw ? startRaw.slice(0,10) : fallbackStart.slice(0,10);
        const resolvedEnd = typeof endRaw === 'string' && endRaw ? endRaw.slice(0,10) : fallbackEnd.slice(0,10);
        const viewStartRaw = get('viewStart','view_start');
        const viewEndRaw = get('viewEnd','view_end');
        const resolvedViewStart = typeof viewStartRaw === 'string' && viewStartRaw ? viewStartRaw.slice(0,10) : resolvedStart;
        const resolvedViewEnd = typeof viewEndRaw === 'string' && viewEndRaw ? viewEndRaw.slice(0,10) : resolvedEnd;
        const updatedAtRaw = get('updatedAt','updated_at');
        const lastBackupRaw = get('lastBackupAt','last_backup_at');
        const employeesPayload = get('employees');
        const employees = Array.isArray(employeesPayload) ? employeesPayload.map(e=> typeof e === 'string' ? e : String(e)) : [];
        const dataPayload = get('data');
        const data = (dataPayload && typeof dataPayload === 'object' && !Array.isArray(dataPayload)) ? dataPayload : {};
        const shiftColorsPayload = get('shiftColors','shift_colors');
        const shiftColorsState = shiftColorsPayload && typeof shiftColorsPayload === 'object' ? { ...defaultShiftColors, ...shiftColorsPayload } : { ...defaultShiftColors };
        const staffingPayload = get('staffingAlerts','staffing_alerts');
        const staffingAlertsState = normalizeStaffingAlerts(staffingPayload);
        const adminDaysVal = Number(get('adminDays','admin_days') || 0);
        const restPayload = get('restPrefs','rest_prefs');
        const restPrefsState = sanitizeRestPrefsMap(restPayload || {});
        const nightWindowsPayload = get('nightWindows','night_windows');
        let nightWindowsState = [{ s: resolvedStart, e: resolvedEnd }];
        if(Array.isArray(nightWindowsPayload) && nightWindowsPayload.length){
          nightWindowsState = nightWindowsPayload.map(w=> ({
            s: typeof w?.s === 'string' && w.s ? w.s : (typeof w?.start === 'string' ? w.start : resolvedStart),
            e: typeof w?.e === 'string' && w.e ? w.e : (typeof w?.end === 'string' ? w.end : resolvedEnd)
          }));
        }
        const nightOverridePayload = get('nightOverride','night_override');
        const nightRulesPayload = get('nightRules','night_rules');
        const rMinPayload = get('rMin','r_min');
        const rMaxPayload = get('rMax','r_max');
        const pMinPayload = get('pMin','p_min');
        const pMaxPayload = get('pMax','p_max');
        const mixMaxPayload = get('mixMax','mix_max');
        const notePayload = get('note','remark');
        const batchPayload = get('batchChecked','batch_checked');
        const albumSelectedPayload = get('albumSelected','album_selected');
        const albumWhitePayload = get('albumWhiteHour','album_white_hour');
        const albumMidPayload = get('albumMidHour','album_mid_hour');
        const albumRangeStartPayload = get('albumRangeStartMonth','album_range_start_month');
        const albumRangeEndPayload = get('albumRangeEndMonth','album_range_end_month');
        const albumMaxDiffPayload = get('albumMaxDiff','album_max_diff');
        const albumAssignmentsPayload = get('albumAssignments','album_assignments');
        const albumAutoNotePayload = get('albumAutoNote','album_auto_note');
        const albumHistoryPayload = get('albumHistory','album_history');
        const historyProfilePayload = get('historyProfile','history_profile');
        const yearlyOptimizePayload = get('yearlyOptimize','year_optimize');
        const versionPayload = get('versionId','version_id');
        return {
          start: resolvedStart,
          end: resolvedEnd,
          viewStart: resolvedViewStart,
          viewEnd: resolvedViewEnd,
          employees,
          data,
          versionId: versionPayload !== undefined && versionPayload !== null ? versionPayload : null,
          shiftColors: shiftColorsState,
          staffingAlerts: staffingAlertsState,
          adminDays: adminDaysVal,
          restPrefs: restPrefsState,
          nightWindows: nightWindowsState,
          nightOverride: nightOverridePayload !== undefined ? !!nightOverridePayload : true,
          nightRules: normalizeNightRules(nightRulesPayload),
          rMin: typeof rMinPayload === 'number' ? rMinPayload : 0.3,
          rMax: typeof rMaxPayload === 'number' ? rMaxPayload : 0.7,
          pMin: typeof pMinPayload === 'number' ? pMinPayload : 0.3,
          pMax: typeof pMaxPayload === 'number' ? pMaxPayload : 0.7,
          mixMax: typeof mixMaxPayload === 'number' ? mixMaxPayload : 1,
          note: typeof notePayload === 'string' ? notePayload : '',
          batchChecked: batchPayload && typeof batchPayload === 'object' ? batchPayload : {},
          albumSelected: albumSelectedPayload && typeof albumSelectedPayload === 'object' ? albumSelectedPayload : {},
          albumWhiteHour: typeof albumWhitePayload === 'number' ? albumWhitePayload : 0.22,
          albumMidHour: typeof albumMidPayload === 'number' ? albumMidPayload : 0.06,
          albumRangeStartMonth: (typeof albumRangeStartPayload === 'string' && albumRangeStartPayload ? albumRangeStartPayload : resolvedStart).slice(0,7),
          albumRangeEndMonth: (typeof albumRangeEndPayload === 'string' && albumRangeEndPayload ? albumRangeEndPayload : resolvedEnd).slice(0,7),
          albumMaxDiff: typeof albumMaxDiffPayload === 'number' ? albumMaxDiffPayload : 0.5,
          albumAssignments: albumAssignmentsPayload && typeof albumAssignmentsPayload === 'object' ? albumAssignmentsPayload : {},
          albumAutoNote: typeof albumAutoNotePayload === 'string' ? albumAutoNotePayload : '',
          albumHistory: Array.isArray(albumHistoryPayload) ? albumHistoryPayload.map(item=> ({ ...item, assignments: item?.assignments || {} })) : [],
          historyProfile: historyProfilePayload || null,
          yearlyOptimize: yearlyOptimizePayload === true || yearlyOptimizePayload === 1 || yearlyOptimizePayload === '1',
          updatedAt: typeof updatedAtRaw === 'string' && updatedAtRaw ? updatedAtRaw : null,
          lastBackupAt: typeof lastBackupRaw === 'string' && lastBackupRaw ? lastBackupRaw : null
        };
      }

      function applyServerState(payload){
        if(!payload || typeof payload !== 'object') return;
        const snapshot = convertPayloadToTeamState(payload, { start: planStart, end: planEnd });
        if(!snapshot) return;
        skipSaveRef.current = true;
        viewManuallyAdjustedRef.current = false;
        setPlanStart(snapshot.start);
        setPlanEnd(snapshot.end);
        setViewStart(snapshot.viewStart);
        setViewEnd(snapshot.viewEnd);
        setEmployees(Array.isArray(snapshot.employees) ? snapshot.employees.slice() : []);
        setData(snapshot.data || {});
        setVersionId(snapshot.versionId || null);
        setShiftColors({ ...snapshot.shiftColors });
        setStaffingAlerts({ ...snapshot.staffingAlerts });
        setAdminDays(Number(snapshot.adminDays || 0));
        setRestPrefs(sanitizeRestPrefsMap(snapshot.restPrefs || {}));
        setNightWindows((snapshot.nightWindows || [{ s: snapshot.start, e: snapshot.end }]).map(w=> ({ s: w.s, e: w.e })));
        setNightOverride(snapshot.nightOverride !== undefined ? !!snapshot.nightOverride : true);
        setNightRules(normalizeNightRules(snapshot.nightRules));
        setRMin(typeof snapshot.rMin === 'number' ? snapshot.rMin : 0.3);
        setRMax(typeof snapshot.rMax === 'number' ? snapshot.rMax : 0.7);
        setPMin(typeof snapshot.pMin === 'number' ? snapshot.pMin : 0.3);
        setPMax(typeof snapshot.pMax === 'number' ? snapshot.pMax : 0.7);
        setMixMax(typeof snapshot.mixMax === 'number' ? snapshot.mixMax : 1);
        setNote(typeof snapshot.note === 'string' ? snapshot.note : '');
        setBatchChecked(snapshot.batchChecked ? { ...snapshot.batchChecked } : {});
        setAlbumSelected(snapshot.albumSelected ? { ...snapshot.albumSelected } : {});
        setAlbumWhiteHour(typeof snapshot.albumWhiteHour === 'number' ? snapshot.albumWhiteHour : 0.22);
        setAlbumMidHour(typeof snapshot.albumMidHour === 'number' ? snapshot.albumMidHour : 0.06);
        setAlbumRangeStartMonth((snapshot.albumRangeStartMonth || snapshot.start).slice(0,7));
        setAlbumRangeEndMonth((snapshot.albumRangeEndMonth || snapshot.end).slice(0,7));
        setAlbumMaxDiff(typeof snapshot.albumMaxDiff === 'number' ? snapshot.albumMaxDiff : 0.5);
        setAlbumAssignments(snapshot.albumAssignments ? { ...snapshot.albumAssignments } : {});
        setAlbumAutoNote(typeof snapshot.albumAutoNote === 'string' ? snapshot.albumAutoNote : '');
        setAlbumHistory(Array.isArray(snapshot.albumHistory) ? snapshot.albumHistory.map(item=> ({ ...item, assignments: { ...(item.assignments || {}) } })) : []);
        setHistoryProfile(snapshot.historyProfile || null);
        setYearlyOptimize(snapshot.yearlyOptimize === true);
        const payloadUpdatedAt = typeof payload?.updatedAt === 'string' ? payload.updatedAt : (typeof payload?.updated_at === 'string' ? payload.updated_at : (snapshot.updatedAt || null));
        const payloadBackupAt = typeof payload?.lastBackupAt === 'string' ? payload.lastBackupAt : (typeof payload?.last_backup_at === 'string' ? payload.last_backup_at : (snapshot.lastBackupAt || null));
        setServerUpdatedAt(payloadUpdatedAt || null);
        setLastBackupAt(payloadBackupAt || null);
        const snapshotClone = {
          ...snapshot,
          employees: Array.isArray(snapshot.employees) ? snapshot.employees.slice() : [],
          data: snapshot.data || {},
          shiftColors: { ...snapshot.shiftColors },
          staffingAlerts: { ...snapshot.staffingAlerts },
          restPrefs: sanitizeRestPrefsMap(snapshot.restPrefs || {}),
          nightWindows: (snapshot.nightWindows || []).map(w=> ({ s: w.s, e: w.e })),
          batchChecked: snapshot.batchChecked ? { ...snapshot.batchChecked } : {},
          albumSelected: snapshot.albumSelected ? { ...snapshot.albumSelected } : {},
          albumAssignments: snapshot.albumAssignments ? { ...snapshot.albumAssignments } : {},
          albumHistory: Array.isArray(snapshot.albumHistory) ? snapshot.albumHistory.map(item=> ({ ...item, assignments: { ...(item.assignments || {}) } })) : [],
          updatedAt: payloadUpdatedAt || null,
          lastBackupAt: payloadBackupAt || null
        };
        snapshotRef.current = snapshotClone;
        const syncedClone = deepCloneSnapshot(snapshotClone);
        lastSyncedSnapshotRef.current = syncedClone || snapshotClone;
        lastSavedSnapshotRef.current = JSON.stringify(snapshotClone);
        pendingAutoSaveRef.current = false;
      }

      function buildSavePayload(options = {}, snapshot = snapshotRef.current){
        const base = snapshot || {
          start: planStart,
          end: planEnd,
          viewStart,
          viewEnd,
          employees,
          data,
          versionId,
          shiftColors,
          staffingAlerts,
          adminDays,
          restPrefs: sanitizeRestPrefsMap(restPrefs),
          nightWindows,
          nightOverride,
          nightRules,
          rMin,
          rMax,
          pMin,
          pMax,
          mixMax,
          note,
          batchChecked,
          albumSelected,
          albumWhiteHour,
          albumMidHour,
          albumRangeStartMonth,
          albumRangeEndMonth,
          albumMaxDiff,
          albumAssignments,
          albumAutoNote,
          albumHistory,
          historyProfile,
          yearlyOptimize
        };
        const noteValue = options.noteOverride !== undefined ? options.noteOverride : (base.note ?? note);
        const payload = {
          team,
          viewStart: base.viewStart || viewStart,
          viewEnd: base.viewEnd || viewEnd,
          start: base.start || planStart,
          end: base.end || planEnd,
          employees: base.employees || employees,
          data: base.data || data,
          baseVersionId: base.versionId ?? versionId,
          note: noteValue,
          operator: options.operatorOverride ?? formatOperatorLabel(user),
          adminDays: base.adminDays ?? adminDays,
          restPrefs: base.restPrefs ?? sanitizeRestPrefsMap(restPrefs),
          nightRules: base.nightRules ?? normalizeNightRules(nightRules),
          nightWindows: base.nightWindows ?? nightWindows,
          nightOverride: base.nightOverride ?? nightOverride,
          rMin: base.rMin ?? rMin,
          rMax: base.rMax ?? rMax,
          pMin: base.pMin ?? pMin,
          pMax: base.pMax ?? pMax,
          mixMax: base.mixMax ?? mixMax,
          shiftColors: base.shiftColors ?? shiftColors,
          staffingAlerts: base.staffingAlerts ?? staffingAlerts,
          batchChecked: base.batchChecked ?? batchChecked,
          albumSelected: base.albumSelected ?? albumSelected,
          albumWhiteHour: base.albumWhiteHour ?? albumWhiteHour,
          albumMidHour: base.albumMidHour ?? albumMidHour,
          albumRangeStartMonth: base.albumRangeStartMonth ?? albumRangeStartMonth,
          albumRangeEndMonth: base.albumRangeEndMonth ?? albumRangeEndMonth,
          albumMaxDiff: base.albumMaxDiff ?? albumMaxDiff,
          albumAssignments: base.albumAssignments ?? albumAssignments,
          albumAutoNote: base.albumAutoNote ?? albumAutoNote,
          albumHistory: base.albumHistory ?? albumHistory,
          historyProfile: base.historyProfile ?? historyProfile,
          yearlyOptimize: base.yearlyOptimize ?? yearlyOptimize
        };
        const diff = computeSnapshotDiff(lastSyncedSnapshotRef.current, base);
        if(diff){
          payload.changes = diff;
        }
        return payload;
      }

      function safeParseSnapshot(serialized){
        if(typeof serialized !== 'string' || !serialized) return null;
        try { return JSON.parse(serialized); } catch { return null; }
      }

      function cloneDataMap(data){
        if(!data || typeof data !== 'object') return {};
        const next = {};
        Object.keys(data).forEach(day=>{
          const row = data[day];
          next[day] = row && typeof row === 'object' ? { ...row } : {};
        });
        return next;
      }

      function computeDataDiff(baseSnapshot, localSnapshot){
        if(!baseSnapshot || !localSnapshot) return [];
        const baseData = (baseSnapshot && typeof baseSnapshot.data === 'object') ? baseSnapshot.data : {};
        const localData = (localSnapshot && typeof localSnapshot.data === 'object') ? localSnapshot.data : {};
        const days = new Set([...Object.keys(baseData), ...Object.keys(localData)]);
        const changes = [];
        days.forEach(day=>{
          const baseRow = baseData[day] || {};
          const localRow = localData[day] || {};
          const emps = new Set([...Object.keys(baseRow), ...Object.keys(localRow)]);
          emps.forEach(emp=>{
            const baseVal = (baseRow[emp] ?? '').toString();
            const localValRaw = localRow[emp];
            const localVal = localValRaw === undefined || localValRaw === null ? '' : String(localValRaw);
            if(localVal !== baseVal){
              changes.push({ day, emp, baseVal, value: localVal });
            }
          });
        });
        return changes;
      }

      function jsonEquals(a, b){
        if(a === b) return true;
        try { return JSON.stringify(a) === JSON.stringify(b); } catch { return false; }
      }

      async function fetchLatestSchedulePayload(){
        if(!team){
          throw new Error('尚未选择团队，无法加载最新排班');
        }
        const params = new URLSearchParams();
        if(team) params.set('team', team);
        if(planStart) params.set('start', planStart);
        if(planEnd) params.set('end', planEnd);
        if(yearlyOptimize){
          const yrMatch = (planStart || '').match(/^(\d{4})/);
          if(yrMatch){
            params.set('historyYearStart', `${yrMatch[1]}-01-01`);
            params.set('yearOptimize', '1');
          }
        }
        const query = params.toString();
        const res = await apiGet(`/schedule${query ? `?${query}` : ''}`);
        return { ...res, versionId: res.version_id || res.versionId };
      }

      async function resolveSaveConflict(reason, localSnapshot, options = {}){
        let latestPayload;
        try {
          latestPayload = await fetchLatestSchedulePayload();
        } catch(err){
          globalErr(err?.message || '加载最新排班失败');
          return { applied: 0, skipped: 0 };
        }
        if(!latestPayload){
          return { applied: 0, skipped: 0 };
        }
        const baseSnapshot = safeParseSnapshot(lastSavedSnapshotRef.current);
        const mergedPayload = { ...latestPayload };
        const mergedData = cloneDataMap(latestPayload.data || {});
        const baseData = baseSnapshot && typeof baseSnapshot.data === 'object' ? baseSnapshot.data : {};
        const localData = localSnapshot && typeof localSnapshot.data === 'object' ? localSnapshot.data : {};
        const diffs = baseSnapshot && localSnapshot ? computeDataDiff(baseSnapshot, localSnapshot) : [];
        let applied = 0;
        let skipped = 0;
        diffs.forEach(diff=>{
          const serverRow = mergedData[diff.day] || {};
          const serverVal = serverRow[diff.emp] ?? '';
          const expectVal = (baseData[diff.day] || {})[diff.emp] ?? '';
          if(String(serverVal) === String(expectVal)){
            if(!mergedData[diff.day]) mergedData[diff.day] = {};
            mergedData[diff.day][diff.emp] = diff.value;
            applied += 1;
          } else {
            skipped += 1;
          }
        });
        mergedPayload.data = mergedData;
        if(baseSnapshot && localSnapshot){
          const baseNote = typeof baseSnapshot.note === 'string' ? baseSnapshot.note : '';
          const serverNote = typeof latestPayload.note === 'string' ? latestPayload.note : '';
          if(serverNote === baseNote && typeof localSnapshot.note === 'string' && localSnapshot.note !== baseNote){
            mergedPayload.note = localSnapshot.note;
            applied += 1;
          }
          const mergeableFields = ['adminDays','restPrefs','nightRules','nightWindows','nightOverride','rMin','rMax','pMin','pMax','mixMax','shiftColors','staffingAlerts','batchChecked','albumSelected','albumWhiteHour','albumMidHour','albumRangeStartMonth','albumRangeEndMonth','albumMaxDiff','albumAssignments','albumAutoNote','albumHistory','historyProfile','yearlyOptimize'];
          mergeableFields.forEach(field=>{
            const baseVal = baseSnapshot[field];
            const serverVal = latestPayload[field];
            const localVal = localSnapshot[field];
            if(localVal !== undefined && !jsonEquals(localVal, baseVal) && jsonEquals(serverVal, baseVal)){
              mergedPayload[field] = Array.isArray(localVal) ? localVal.slice() : (localVal && typeof localVal === 'object' ? JSON.parse(JSON.stringify(localVal)) : localVal);
              applied += 1;
            }
          });
        }
        applyServerState({ ...mergedPayload, versionId: mergedPayload.versionId ?? mergedPayload.version_id ?? null });
        skipSaveRef.current = false;
        const latestVersion = mergedPayload.versionId ?? mergedPayload.version_id ?? null;
        if(team && latestVersion){
          lastLoadedVersionRef.current[team] = latestVersion;
        }
        if(team){
          initialTeamSyncRef.current[team] = true;
        }
        if(applied > 0){
          pendingAutoSaveRef.current = true;
          try {
            lastSavedSnapshotRef.current = JSON.stringify(snapshotRef.current);
          } catch {
            lastSavedSnapshotRef.current = '';
          }
          setTimeout(()=> setAutoSaveTicker(tick=> tick + 1), 0);
        } else {
          pendingAutoSaveRef.current = false;
        }
        if(applied > 0 || skipped > 0){
          const msg = skipped > 0
            ? `检测到其他账号已保存新版本，已同步最新数据，${skipped} 项本地改动因冲突未自动合并，请手动确认。`
            : '检测到其他账号已保存新版本，已同步最新数据并保留本地改动。';
          showToast(msg, skipped > 0 ? 'error' : 'info');
        }
        return { applied, skipped };
      }

      async function triggerAutoSave(reason, options = {}){
        const { waitForResponse = false } = options;
        if(autoSaveSendingRef.current) return false;
        if(!pendingAutoSaveRef.current) return false;
        const snapshot = snapshotRef.current;
        if(!snapshot || !snapshotHasMeaningfulData(snapshot)) return false;
        let payload;
        try{
          const autoOperator = formatAutoSaveOperator(user);
          const autoNote = snapshot.note && snapshot.note.trim() ? snapshot.note : AUTO_SAVE_SUFFIX;
          payload = buildSavePayload({
            operatorOverride: autoOperator,
            noteOverride: autoNote
          }, snapshot);
        }catch(e){
          return false;
        }
        if(!payload?.changes && lastSyncedSnapshotRef.current){
          pendingAutoSaveRef.current = false;
          autoSaveSendingRef.current = false;
          return false;
        }
        let serializedSnapshot = '';
        try{ serializedSnapshot = JSON.stringify(snapshot); }catch(e){ serializedSnapshot = ''; }
        autoSaveSendingRef.current = true;
        if(waitForResponse){
          try{
            const res = await apiPost('/schedule/save', payload);
            const returnedVersion = res && (res.version_id || res.versionId);
            if(returnedVersion){
              setVersionId(returnedVersion);
              snapshotRef.current = { ...snapshotRef.current, versionId: returnedVersion };
              if(team){
                lastLoadedVersionRef.current[team] = returnedVersion;
              }
            }
            if(res){
              if(res.updated_at || res.updatedAt){
                setServerUpdatedAt(res.updated_at || res.updatedAt);
              }
              if(res.last_backup_at || res.lastBackupAt){
                setLastBackupAt(res.last_backup_at || res.lastBackupAt);
              }
            }
            if(serializedSnapshot){
              lastSavedSnapshotRef.current = serializedSnapshot;
            }
            const syncedState = deepCloneSnapshot(snapshotRef.current);
            if(syncedState){
              lastSyncedSnapshotRef.current = syncedState;
            }
            pendingAutoSaveRef.current = false;
            autoSaveSendingRef.current = false;
            return true;
          }catch(error){
            autoSaveSendingRef.current = false;
            if(error?.payload && error.payload.code === 409){
              await resolveSaveConflict(reason, snapshot);
              return false;
            }
            console.warn('自动保存失败', reason, error);
            pendingAutoSaveRef.current = true;
            setAutoSaveTicker(tick=> tick + 1);
            return false;
          }
        }
        let body;
        try{ body = JSON.stringify(payload); } catch(e){
          autoSaveSendingRef.current = false;
          pendingAutoSaveRef.current = true;
          setAutoSaveTicker(tick=> tick + 1);
          return false;
        }
        let sent = false;
        if(typeof navigator !== 'undefined' && navigator.sendBeacon){
          try{
            const blob = new Blob([body], { type:'application/json' });
            sent = navigator.sendBeacon(`${API_BASE}/schedule/save`, blob);
          }catch(e){ sent = false; }
        }
        if(!sent){
          try{
            fetch(`${API_BASE}/schedule/save`, {
              method:'POST',
              headers:{ 'Content-Type':'application/json' },
              body,
              credentials:'include',
              keepalive:true
            }).catch(()=>{});
          }catch(e){}
        }
        if(serializedSnapshot){
          lastSavedSnapshotRef.current = serializedSnapshot;
        } else {
          lastSavedSnapshotRef.current = body;
        }
        try{
          const nowIso = new Date().toISOString();
          setServerUpdatedAt(nowIso);
        }catch{}
        pendingAutoSaveRef.current = false;
        autoSaveSendingRef.current = false;
        return true;
      }

      useEffect(()=>{
        const handleBeforeUnload = ()=>{ try{ triggerAutoSave('beforeunload'); }catch(e){} };
        const handlePageHide = ()=>{ try{ triggerAutoSave('pagehide'); }catch(e){} };
        const handleVisibility = ()=>{
          if(document.visibilityState === 'hidden'){
            triggerAutoSave('visibilitychange');
          }
        };
        window.addEventListener('beforeunload', handleBeforeUnload);
        window.addEventListener('pagehide', handlePageHide);
        document.addEventListener('visibilitychange', handleVisibility);
        return ()=>{
          window.removeEventListener('beforeunload', handleBeforeUnload);
          window.removeEventListener('pagehide', handlePageHide);
          document.removeEventListener('visibilitychange', handleVisibility);
        };
      }, []);

      useEffect(()=>{
        if(!autoSaveTicker) return;
        if(!pendingAutoSaveRef.current) return;
        let cancelled = false;
        const timer = setTimeout(()=>{
          if(cancelled) return;
          triggerAutoSave('debounce', { waitForResponse:true });
        }, 2500);
        return ()=>{
          cancelled = true;
          clearTimeout(timer);
        };
      }, [autoSaveTicker, team]);

      async function loadFromServer(){
        try {
          const payload = await fetchLatestSchedulePayload();
          applyServerState(payload);
          const latestVersion = payload.versionId;
          if(latestVersion){
            lastLoadedVersionRef.current[team] = latestVersion;
          }
          if(team){
            initialTeamSyncRef.current[team] = true;
          }
        } catch(e){
          globalErr(e.message);
        }
      }
      async function loadVersions(){
        const trimmedTeam = (team || '').trim();
        if(!trimmedTeam){
          globalErr('请选择团队后再刷新备份记录');
          return;
        }
        setVersionsLoading(true);
        try{
          const params = new URLSearchParams();
          params.set('team', trimmedTeam);
          params.set('start', '1970-01-01');
          params.set('end', '2100-12-31');
          const res = await apiGet(`/schedule/versions?${params.toString()}`);
          const list = Array.isArray(res.versions) ? res.versions.slice() : [];
          list.sort((a,b)=>{
            const at = Date.parse(a.created_at || a.createdAt || 0) || 0;
            const bt = Date.parse(b.created_at || b.createdAt || 0) || 0;
            return bt - at;
          });
          setVersions(list);
          if(list.length){
            const latestId = list[0]?.id;
            if(latestId && lastLoadedVersionRef.current[trimmedTeam] !== latestId){
              await loadVersionById(latestId, { silent:true });
            }
          } else {
            delete lastLoadedVersionRef.current[trimmedTeam];
          }
        } catch(e){
          globalErr(e.message);
        } finally {
          setVersionsLoading(false);
        }
      }
      async function loadVersionById(id, options={}){
        try{
          const res = await apiGet(`/version?id=${id}`);
          applyServerState({ ...res, versionId: id });
          lastLoadedVersionRef.current[team] = id;
        } catch(e){
          if(!options?.silent){
            globalErr(e.message);
          }
        }
      }
      async function deleteVersionById(id){
        if(!id) return;
        if(!confirm('确定删除该备份记录吗？删除后无法恢复。')) return;
        const trimmedTeam = (team || '').trim();
        if(!trimmedTeam){
          globalErr('请选择团队后再操作');
          return;
        }
        setVersionDeletingId(id);
        try{
          await apiPost('/schedule/version/delete', { id, team: trimmedTeam });
          setVersions(prev=> prev.filter(v=> v.id !== id));
          if(lastLoadedVersionRef.current[trimmedTeam] === id){
            delete lastLoadedVersionRef.current[trimmedTeam];
          }
          showToast('已删除备份记录', 'success');
          await loadVersions();
        } catch(e){
          globalErr(e.message);
        } finally {
          setVersionDeletingId(null);
        }
      }
      useEffect(()=>{
        if(!user) return;
        if(!team) return;
        const key = autoLoadKey;
        if(manualPlanAdjustRef.current && pendingAutoSaveRef.current){
          manualPlanAdjustRef.current = false;
          return;
        }
        manualPlanAdjustRef.current = false;
        if(autoLoadedTeamRef.current[key]) return;
        autoLoadedTeamRef.current[key] = true;
        loadFromServer();
      }, [autoLoadKey, team, user]);
      async function doLogout(){ try{ await apiPost('/logout',{}); setUser(null);}catch{} }
      async function exportExcel(){
        if(!team){ alert('请选择团队后再导出'); return; }
        const start = (viewStart || '').slice(0,10);
        const end = (viewEnd || '').slice(0,10);
        if(!start || !end || start > end){ alert('请先设置有效的筛选时间范围'); return; }
        const dates = enumerateDates(start, end);
        if(!dates.length){ alert('筛选时间范围无效'); return; }
        const exportEmployees = Array.isArray(employees) ? employees.slice() : [];
        const payload = {
          team,
          start,
          end,
          employees: exportEmployees,
          data: {}
        };
        for(const day of dates){
          const row = data?.[day] || {};
          const nextRow = {};
          exportEmployees.forEach(emp=>{
            if(row[emp] !== undefined && row[emp] !== null && row[emp] !== ''){
              nextRow[emp] = row[emp];
            }
          });
          payload.data[day] = nextRow;
        }
        try{
          const res = await fetch(`${API_BASE}/export/xlsx`, {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify(payload),
            credentials: 'include'
          });
          if(!res.ok){
            let msg = '导出失败';
            try{ const err = await res.json(); if(err?.message) msg = err.message; }catch(e){}
            throw new Error(msg);
          }
          const blob = await res.blob();
          let filename = `排班_${start}_${end}.xlsx`;
          const disposition = res.headers.get('Content-Disposition') || '';
          const match = disposition.match(/filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i);
          if(match){
            const encoded = match[1] || match[2];
            if(encoded){
              try{ filename = decodeURIComponent(encoded.replace(/"/g,'')); }catch(e){ filename = encoded.replace(/"/g,''); }
            }
          }
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        }catch(e){
          globalErr(e.message || '导出失败');
        }
      }
      function downloadTemplate(){ window.location.href = `${API_BASE}/template/xlsx`; }
      async function exportTeamLogs(){
        const trimmedTeam = (team || '').trim();
        if(!trimmedTeam){
          globalErr('请选择团队后再导出日志');
          return;
        }
        if(logExportStart && logExportEnd && logExportStart > logExportEnd){
          setLogExportError('开始日期不能晚于结束日期');
          return;
        }
        setLogExportError('');
        setLogExporting(true);
        try{
          const params = new URLSearchParams();
          params.set('team', trimmedTeam);
          if(logExportStart) params.set('start', logExportStart);
          if(logExportEnd) params.set('end', logExportEnd);
          const res = await fetch(`${API_BASE}/team/logs/export?${params.toString()}`, { credentials:'include' });
          if(!res.ok){
            let msg = '导出失败';
            try{ const err = await res.json(); if(err?.message) msg = err.message; }catch{}
            throw new Error(msg);
          }
          const blob = await res.blob();
          let filename = `操作日志_${trimmedTeam}.csv`;
          const disposition = res.headers.get('Content-Disposition') || '';
          const match = disposition.match(/filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i);
          if(match){
            const encoded = match[1] || match[2];
            if(encoded){
              try{ filename = decodeURIComponent(encoded.replace(/"/g,'')); }catch{ filename = encoded.replace(/"/g,''); }
            }
          }
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        }catch(err){
          setLogExportError(err?.message || '导出失败');
        }finally{
          setLogExporting(false);
        }
      }
      function openImportPicker(){ if(editingLocked) return; if(importInputRef.current){ importInputRef.current.click(); } }
      async function importScheduleFile(file){
        if(!file) return;
        setImporting(true);
        try{
          const formData = new FormData();
          formData.append('file', file);
          const res = await fetch(`${API_BASE}/import/xlsx`, {
            method: 'POST',
            body: formData,
            credentials: 'include'
          });
          if(!res.ok){
            let msg = '导入失败';
            try {
              const err = await res.json();
              if(err && err.message) msg = err.message;
            } catch{}
            throw new Error(msg);
          }
          const payload = await res.json();
          const importedEmployees = Array.isArray(payload?.employees) ? payload.employees : [];
          const importedData = (payload && typeof payload.data === 'object' && !Array.isArray(payload.data)) ? payload.data : {};
          const start = typeof payload?.start === 'string' ? payload.start.slice(0,10) : '';
          const end = typeof payload?.end === 'string' ? payload.end.slice(0,10) : '';
          if(importedEmployees.length){
            setEmployees(importedEmployees);
          }
          setData(importedData);
          setVersionId(null);
          setBatchChecked({});
          setAlbumSelected({});
          if(start){
            handlePlanStartChange(start);
          }
          if(end){
            handlePlanEndChange(end);
          }
          if(start || end){
            viewManuallyAdjustedRef.current = false;
            if(start) setViewStart(start);
            if(end) setViewEnd(end);
          }
          showToast(payload?.message || '导入成功，已覆盖当前排班', 'success');
        } catch(e){
          alert(e.message || '导入失败');
        } finally {
          setImporting(false);
          if(importInputRef.current){ importInputRef.current.value = ''; }
        }
      }
      const onImportInputChange = (e)=>{
        const file = e.target?.files?.[0];
        if(!file){
          if(importInputRef.current){ importInputRef.current.value = ''; }
          return;
        }
        importScheduleFile(file);
      };

      useEffect(()=>{
        if(tab === 'history'){
          loadVersions();
        }
      }, [tab, team]);

      const dateList = useMemo(()=>{
        const hasView = viewStart && viewEnd;
        if(hasView){
          const s = viewStart <= viewEnd ? viewStart : viewEnd;
          const e = viewStart <= viewEnd ? viewEnd : viewStart;
          return enumerateDates(s, e);
        }
        return enumerateDates(planStart, planEnd);
      }, [viewStart, viewEnd, planStart, planEnd]);
      const allDateKeys = useMemo(()=> Object.keys(data||{}).sort(), [data]);
      const planDateList = useMemo(()=>{
        const valid = (val)=> typeof val === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(val);
        const s = valid(planStart) ? planStart : null;
        const e = valid(planEnd) ? planEnd : null;
        if(s && e){
          const start = s <= e ? s : e;
          const end = s <= e ? e : s;
          return enumerateDates(start, end);
        }
        return allDateKeys.filter(day=> (!s || day >= s) && (!e || day <= e));
      }, [planStart, planEnd, allDateKeys]);
      const gridContainerRef = useRef(null);
      useEffect(()=>{
        const node = gridContainerRef.current;
        if(node){
          node.scrollTop = 0;
          node.scrollLeft = 0;
        }
      }, [team, viewStart, viewEnd, planStart, planEnd, employees.length]);
      const activeCellRef = useRef(null);
      const setCellByIndex = useCallback((dIndex, eIndex, value)=>{
        const d = dateList[dIndex];
        const emp = employees[eIndex];
        if(!d || !emp) return;
        setData(prev=>{
          const next = { ...prev };
          const row = { ...(next[d]||{}) };
          row[emp] = value;
          next[d] = row;
          return next;
        });
      }, [dateList, employees]);
      const onFocusCell = useCallback((dIndex, eIndex)=>{ activeCellRef.current = { dIndex, eIndex }; }, []);
      const moveActive = useCallback((dx, dy)=>{
        const cur = activeCellRef.current || { dIndex:0, eIndex:0 };
        const ni = Math.max(0, Math.min((cur.dIndex||0) + dy, dateList.length - 1));
        const nj = Math.max(0, Math.min((cur.eIndex||0) + dx, employees.length - 1));
        activeCellRef.current = { dIndex: ni, eIndex: nj };
        const id = `cell-${ni}-${nj}`;
        requestAnimationFrame(()=>{
          const el = document.getElementById(id);
          if(el){
            el.focus();
            if(typeof el.scrollIntoView === 'function'){
              try{ el.scrollIntoView({ block:'nearest', inline:'nearest' }); }catch{}
            }
          }
        });
      }, [dateList, employees]);
      const openPickerAt = useCallback((di, ei, anchorEl)=>{
        if(editingLocked) return;
        const el = anchorEl || document.getElementById(`cell-${di}-${ei}`);
        if(!el) return;
        const rect = el.getBoundingClientRect();
        const margin = 8;
        const pickerWidth = 176;
        const pickerHeight = 236;
        const viewportWidth = window.innerWidth || document.documentElement.clientWidth || 0;
        const viewportHeight = window.innerHeight || document.documentElement.clientHeight || 0;
        let left = rect.left;
        let top = rect.bottom + 6;
        if(left + pickerWidth > viewportWidth - margin){
          left = Math.max(margin, viewportWidth - pickerWidth - margin);
        } else {
          left = Math.max(margin, left);
        }
        let placement = 'down';
        if(top + pickerHeight > viewportHeight - margin){
          const above = rect.top - pickerHeight - 6;
          if(above >= margin){
            top = above;
            placement = 'up';
          } else {
            top = Math.max(margin, viewportHeight - pickerHeight - margin);
          }
        }
        setPicker({ open:true, di, ei, x:left, y:top, placement });
      }, [editingLocked]);
      const onKeyDownCell = useCallback((e, di, ei)=>{
        if(e.isComposing) return;
        if(e.altKey && (e.key==='ArrowDown' || e.key==='Enter')){
          e.preventDefault();
          openPickerAt(di, ei, e.currentTarget);
          return;
        }
        if(e.key==='Enter'){
          e.preventDefault();
          moveActive(1,0);
        } else if(e.key==='ArrowRight'){
          e.preventDefault();
          moveActive(1,0);
        } else if(e.key==='ArrowLeft'){
          e.preventDefault();
          moveActive(-1,0);
        } else if(e.key==='ArrowDown'){
          e.preventDefault();
          moveActive(0,1);
        } else if(e.key==='ArrowUp'){
          e.preventDefault();
          moveActive(0,-1);
        }
      }, [moveActive, openPickerAt]);

      const sameEmployees = (prevList, nextList)=>{
        if(prevList === nextList) return true;
        if(!Array.isArray(prevList) || !Array.isArray(nextList)) return false;
        if(prevList.length !== nextList.length) return false;
        for(let i=0; i<nextList.length; i++){
          if(prevList[i] !== nextList[i]) return false;
        }
        return true;
      };

      const sameRowValues = (prevRow, nextRow, employees)=>{
        if(prevRow === nextRow) return true;
        const prevMap = prevRow || EMPTY_ROW;
        const nextMap = nextRow || EMPTY_ROW;
        for(let i=0; i<employees.length; i++){
          const emp = employees[i];
          const prevVal = prevMap?.[emp] ?? '';
          const nextVal = nextMap?.[emp] ?? '';
          if(String(prevVal) !== String(nextVal)) return false;
        }
        return true;
      };

      const areScheduleRowPropsEqual = (prev, next)=>{
        if(prev.day !== next.day) return false;
        if(prev.issue !== next.issue) return false;
        if(prev.editingLocked !== next.editingLocked) return false;
        if(prev.shiftColors !== next.shiftColors) return false;
        if(prev.onFocusCell !== next.onFocusCell) return false;
        if(prev.onKeyDownCell !== next.onKeyDownCell) return false;
        if(prev.openPickerAt !== next.openPickerAt) return false;
        if(prev.setCellByIndex !== next.setCellByIndex) return false;
        if(!sameEmployees(prev.employeesList, next.employeesList)) return false;
        if(!sameRowValues(prev.rowData, next.rowData, next.employeesList || [])) return false;
        const prevStats = prev.stats || EMPTY_STATS;
        const nextStats = next.stats || EMPTY_STATS;
        if(prevStats !== nextStats){
          if(prevStats.total !== nextStats.total) return false;
          if(prevStats.white !== nextStats.white) return false;
          if(prevStats.mid1 !== nextStats.mid1) return false;
          if(prevStats.mid2 !== nextStats.mid2) return false;
          if(prevStats.night !== nextStats.night) return false;
        }
        const prevAlerts = prev.staffingAlerts || {};
        const nextAlerts = next.staffingAlerts || {};
        if(prevAlerts !== nextAlerts){
          if((prevAlerts.total ?? null) !== (nextAlerts.total ?? null)) return false;
          if((prevAlerts.white ?? null) !== (nextAlerts.white ?? null)) return false;
          if((prevAlerts.mid1 ?? null) !== (nextAlerts.mid1 ?? null)) return false;
        }
        return true;
      };

      const ScheduleRow = React.memo(function ScheduleRow({
        day,
        di,
        employeesList,
        rowData,
        issue,
        stats,
        staffingAlerts,
        editingLocked,
        shiftColors,
        onFocusCell,
        onKeyDownCell,
        openPickerAt,
        setCellByIndex,
      }){
        const dataRow = rowData || EMPTY_ROW;
        const statsSafe = stats || EMPTY_STATS;
        const staffingRule = staffingAlerts || {};
        const w = dow(day);
        const weekend = w===0 || w===6;
        const weekLabel = WN[w];
        return (
          <tr className={`border-t hover:bg-indigo-50/30 ${weekend ? 'bg-gray-50' : ''}`}>
            <td className="py-1.5 px-3 font-medium text-gray-800 left-sticky" style={{minWidth:'8.5rem'}}>
              <div className="flex items-center gap-2"><span>{day}</span></div>
              <div className="text-xs text-gray-500 flex flex-wrap items-center gap-1">
                <span style={styleForStaffing(statsSafe.total, staffingRule.total)}>在岗 {statsSafe.total}</span>
                <span>（</span>
                <span style={styleForStaffing(statsSafe.white, staffingRule.white)}>白 {statsSafe.white}</span>
                <span>/</span>
                <span style={styleForStaffing(statsSafe.mid1, staffingRule.mid1)}>中1 {statsSafe.mid1}</span>
                <span>/</span>
                <span>中2 {statsSafe.mid2}</span>
                <span>/</span>
                <span>夜 {statsSafe.night}</span>
                <span>）</span>
              </div>
            </td>
            <td className="py-1.5 px-3 text-gray-500 left-sticky-2" style={{minWidth:'6.5rem'}}>周{weekLabel}</td>
            <td className="py-1.5 px-3 left-sticky-3" style={{minWidth:'9rem'}}>
              {issue ? <span className={`badge ${issue==='缺夜&中2'?'bg-red-100 text-red-700':'bg-amber-100 text-amber-700'}`}>{issue}</span> : <span className="text-gray-400">—</span>}
            </td>
            {employeesList.map((emp, ei)=>{
              const value = dataRow[emp] || '';
              const bg = shiftColors[value] || undefined;
              return (
                <td key={emp} className="py-1.5 px-3">
                  <div className="cell-wrap">
                    <input list="shift-options" id={`cell-${di}-${ei}`} className="cell border rounded-lg px-2 py-1.5 focus:ring-2 focus:ring-indigo-300 focus:outline-none transition disabled:bg-gray-100"
                      style={{ backgroundColor: bg }} value={value}
                      disabled={editingLocked}
                      title={editingLocked? '执行中：只读' : ''}
                      onFocus={()=> onFocusCell(di, ei)}
                      onKeyDown={(ev)=> onKeyDownCell(ev, di, ei)}
                      onCompositionStart={(ev)=>{ ev.target.isComposing = true; }}
                      onCompositionEnd={(ev)=>{ ev.target.isComposing = false; setCellByIndex(di, ei, ev.currentTarget.value); }}
                      onChange={ev=> setCellByIndex(di, ei, ev.target.value)}
                      onDoubleClick={(ev)=>{ if(editingLocked) return; openPickerAt(di, ei, ev.currentTarget); }} placeholder="白/中1/中2/夜/休 或留空" />
                    <button className="cell-toggle" disabled={editingLocked} aria-label="选择班次" title="选择班次"
                      onClick={(ev)=>{ ev.preventDefault(); ev.stopPropagation(); openPickerAt(di, ei); }}>
                      <span className="sr-only">打开班次选择器</span>
                    </button>
                  </div>
                </td>
              );
            })}
          </tr>
        );
      }, areScheduleRowPropsEqual);

      function clearRange(mode='empty'){
        setData(prev=>{ const next={...prev}; for(const d of dateList){ const r={...(next[d]||{})}; for(const e of employees){ r[e] = (mode==='rest')? '休' : ''; } next[d]=r; } return next; });
      }

      const nightIssues = useMemo(()=>{ const issues={}; function inAnyWin(day){ for(const w of nightWindows){ if(!w.s||!w.e) continue; if(day>=w.s && day<=w.e) return true; } return false; } for(const d of dateList){ if(!inAnyWin(d)) continue; const row=data[d]||{}; const vals=Object.values(row); const hasN = vals.includes('夜'); const hasM2 = vals.includes('中2'); let msg=''; if(!hasN && !hasM2) msg='缺夜&中2'; else if(!hasN) msg='缺夜'; else if(!hasM2) msg='缺中2'; if(msg) issues[d]=msg; } return issues; }, [nightWindows, data, dateList]);

      // —— 新增：全局单个浮动班次选择器 ——
      const [picker, setPicker] = useState({ open:false, di:null, ei:null, x:0, y:0, placement:'down' });
      const pickerRef = useRef(null);
      useEffect(()=>{
        function onDocDown(ev){ if(!picker.open) return; if(pickerRef.current && !pickerRef.current.contains(ev.target)) setPicker(p=>({...p, open:false})); }
        document.addEventListener('mousedown', onDocDown);
        return ()=> document.removeEventListener('mousedown', onDocDown);
      }, [picker.open]);

      const pickerContext = useMemo(()=>{
        if(!picker.open) return null;
        const { di, ei } = picker;
        const day = dateList[di];
        const emp = employees[ei];
        if(!day || !emp) return null;
        const parse = (ymd)=> new Date(`${ymd}T00:00:00`);
        const timeline = planDateList.length ? planDateList : allDateKeys;
        const computeGap = (targetShift)=>{
          const search = (source)=>{
            if(!source.length) return null;
            const anchorIdx = source.indexOf(day);
            const walk = (startIdx, skipSameDay)=>{
              for(let idx = startIdx; idx >= 0; idx--){
                const prevDay = source[idx];
                if(!prevDay) continue;
                if(skipSameDay && prevDay >= day) continue;
                const val = getVal(data, prevDay, emp);
                if(val === targetShift){
                  const diff = Math.round((parse(day) - parse(prevDay)) / 86400000);
                  return Number.isFinite(diff) ? diff : null;
                }
              }
              return null;
            };
            if(anchorIdx !== -1){
              return walk(anchorIdx - 1, false);
            }
            return walk(source.length - 1, true);
          };
          const primary = search(timeline);
          if(primary !== null) return primary;
          if(planDateList.length){
            const fallback = search(allDateKeys);
            if(fallback !== null) return fallback;
          }
          return null;
        };
        return {
          day,
          emp,
          nightGap: computeGap('夜'),
          mid2Gap: computeGap('中2')
        };
        }, [picker, dateList, employees, data, planDateList, allDateKeys]);

      const gridEmpCounts = useMemo(()=>{
        const usingPlan = planDateList.length > 0;
        const primaryDates = usingPlan ? planDateList : allDateKeys;
        const primary = countByEmpOnDates(employees, data, primaryDates);
        if(primary.hasWork || !usingPlan){
          return primary.counter;
        }
        const fallback = countByEmpOnDates(employees, data, allDateKeys);
        return fallback.hasWork ? fallback.counter : primary.counter;
      }, [employees, data, planDateList, allDateKeys]);

      const viewYear = useMemo(()=>{
        const base = viewStart || planStart || dateList[0];
        if(!base) return null;
        const d = new Date(`${base}T00:00:00`);
        if(Number.isNaN(d.getTime())) return null;
        return d.getFullYear();
      }, [viewStart, planStart, dateList]);

      const empYearStats = useMemo(()=>{
        if(!viewYear) return {};
        const start = fmt(new Date(viewYear, 0, 1));
        const end = fmt(new Date(viewYear, 11, 31));
        const empSet = new Set(employees);
        const monthMap = {};
        Object.entries(data || {}).forEach(([day, row])=>{
          if(!row) return;
          if(day < start || day > end) return;
          const monthKey = day.slice(0,7);
          Object.entries(row).forEach(([emp, val])=>{
            if(!empSet.has(emp)) return;
            if(!isWork(val)) return;
            if(!monthMap[emp]) monthMap[emp] = new Set();
            monthMap[emp].add(monthKey);
          });
        });
        const result = {};
        employees.forEach(emp=>{
          const stats = statsForEmployee(data, emp, start, end);
          const monthCount = monthMap[emp]?.size || 0;
          const divisor = monthCount || 12;
          result[emp] = {
            year: viewYear,
            night: stats.night,
            mid2: stats.mid2,
            avgNight: divisor ? stats.night / divisor : 0,
            avgMid2: divisor ? stats.mid2 / divisor : 0,
            months: monthCount
          };
        });
        return result;
      }, [viewYear, employees, data]);

      const dailyStats = useMemo(()=>{
        if(!dateList.length || employees.length===0){
          const fallback = {};
          dateList.forEach(day=>{ fallback[day] = EMPTY_STATS; });
          return fallback;
        }
        const result = {};
        for(const day of dateList){
          const row = data?.[day] || EMPTY_ROW;
          let total = 0;
          let white = 0;
          let mid1 = 0;
          let mid2 = 0;
          let night = 0;
          for(const emp of employees){
            const raw = row?.[emp];
            if(raw === undefined || raw === null) continue;
            const value = String(raw).trim();
            if(value === '') continue;
            total += 1;
            if(value === '白'){ white += 1; }
            else if(value === '中1'){ mid1 += 1; }
            else if(value === '中2'){ mid2 += 1; }
            else if(value === '夜'){ night += 1; }
          }
          if(total === 0 && white === 0 && mid1 === 0 && mid2 === 0 && night === 0){
            result[day] = EMPTY_STATS;
          } else {
            result[day] = { total, white, mid1, mid2, night };
          }
        }
        return result;
      }, [dateList, employees, data]);

      const ViewGrid = (
        <Section title="排班表格" right={<span className="text-sm text-gray-500">提示：点击单元格→直接输入或从 Excel 粘贴；支持 IME 连续输入 {editingLocked && <span className='inline-flex items-center gap-1 text-rose-600 ml-2'><Icon name='lock'/>执行中：只读</span>}</span>}>
          {employees.length===0 ? (
            <div className="text-sm text-gray-500">请先在「员工管理」中添加员工。</div>
          ) : (
            <>
              <div
                ref={gridContainerRef}
                className="grid-wrap border rounded-xl shadow-inner"
                onPaste={(e)=>{ if(editingLocked) return; const cur = activeCellRef.current; if(!cur) return; const text = e.clipboardData.getData('text'); if(!text) return; e.preventDefault(); const rows = text.replace(/\r/g,'').split('\n').filter(x=>x.length>0).map(r=>r.split(/\t|,/)); const baseI = cur.eIndex; const baseD = cur.dIndex; setData(prev=>{ const next = { ...prev }; for(let r=0; r<rows.length; r++){ const d = dateList[baseD + r]; if(!d) break; const row = { ...(next[d]||{}) }; for(let c=0; c<rows[r].length; c++){ const emp = employees[baseI + c]; if(!emp) break; row[emp] = rows[r][c]; } next[d] = row; } return next; }); }}
              >
                <table className="min-w-max text-sm w-full">
                  <thead>
                    <tr className="bg-gray-50">
                      <th className="sticky py-2 px-3 text-left left-sticky" style={{minWidth:'8.5rem'}}>日期</th>
                      <th className="sticky py-2 px-3 text-left left-sticky-2" style={{minWidth:'6.5rem'}}>星期</th>
                      <th className="sticky py-2 px-3 text-left left-sticky-3" style={{minWidth:'9rem'}}>问题</th>
                      {employees.map(e=> {
                        const diff = (gridEmpCounts[e]?.总||0) - Number(adminDays||0);
                        const diffCls = diff===0? 'bg-gray-100 text-gray-700' : (diff>0? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700');
                        const tooltip = empYearStats[e];
                        return (
                          <th key={e} className="sticky py-2 px-3 text-left">
                            <div className="group relative inline-flex items-center gap-2">
                              <span className="cursor-help font-medium text-gray-700">{e}</span>
                              <span className={`badge ${diffCls}`} title="差值=实际总天数-行政班应上天数">{diff>0?`+${diff}`:diff}</span>
                              {tooltip && (
                                <div className="pointer-events-none absolute top-full right-0 z-30 mt-2 hidden min-w-[220px] max-w-[280px] rounded-2xl bg-gray-900/95 p-3 text-left text-xs text-white shadow-2xl group-hover:block" style={{ maxWidth: 'min(280px, calc(100vw - 48px))' }}>
                                  <div className="text-sm font-semibold text-white/90">{tooltip.year} 年排班</div>
                                  <div className="mt-1 space-y-1">
                                    <div className="flex items-center justify-between"><span>夜班总计</span><span>{tooltip.night} 天</span></div>
                                    <div className="flex items-center justify-between"><span>中2 总计</span><span>{tooltip.mid2} 天</span></div>
                                    <div className="h-px bg-white/10"></div>
                                    <div className="flex items-center justify-between"><span>夜班月均</span><span>{tooltip.avgNight.toFixed(1)} 天</span></div>
                                    <div className="flex items-center justify-between"><span>中2 月均</span><span>{tooltip.avgMid2.toFixed(1)} 天</span></div>
                                  </div>
                                  <div className="mt-1 text-[10px] text-white/50">{tooltip.months>0 ? `基于 ${tooltip.months} 个月排班记录统计` : '暂无该年度排班记录'}</div>
                                </div>
                              )}
                            </div>
                          </th>
                        );
                      })}
                    </tr>
                  </thead>
                  <tbody>
                    {dateList.map((d, di)=>{
                      return (
                        <ScheduleRow
                          key={d}
                          day={d}
                          di={di}
                          employeesList={employees}
                          rowData={data[d] || EMPTY_ROW}
                          stats={dailyStats[d] || EMPTY_STATS}
                          issue={nightIssues[d] || ''}
                          staffingAlerts={staffingAlerts}
                          editingLocked={editingLocked}
                          shiftColors={shiftColors}
                          onFocusCell={onFocusCell}
                          onKeyDownCell={onKeyDownCell}
                          openPickerAt={openPickerAt}
                          setCellByIndex={setCellByIndex}
                        />
                      );
                    })}
                  </tbody>
                </table>
                <datalist id="shift-options">
                  {SHIFT_TYPES.map(s=> <option key={s} value={s} />)}
                </datalist>
              </div>
            </>
          )}
        </Section>
      );

      function EmployeeChecklist(){
        const [kw, setKw] = useState('');
        const filtered = useMemo(()=>{ const k = kw.trim().toLowerCase(); return k ? employees.filter(e=> e.toLowerCase().includes(k)) : employees; }, [kw, employees]);
        const listRef = useRef(null);
        const withStay = (cb)=>{ const el=listRef.current; const st=el?el.scrollTop:0; const sl=el?el.scrollLeft:0; cb(); requestAnimationFrame(()=>{ const node=listRef.current; if(node){ node.scrollTop = st; node.scrollLeft = sl; } }); };
        const selectedCount = filtered.filter(n=> !!batchChecked[n]).length;
        const allSelected = filtered.length>0 && selectedCount===filtered.length;
        return (
          <div className="border rounded-xl p-3">
            <input className="border rounded px-2 py-1 text-sm w-full mb-2" placeholder="搜索姓名…" value={kw} onChange={e=>setKw(e.target.value)} />
            <div className="flex items-center justify-between text-xs text-gray-600 mb-2">
              <div>当前筛选：{filtered.length} 人；已选 {selectedCount} 人</div>
              <div className="space-x-2">
                <button className={`px-2 py-1 rounded border ${editingLocked?'opacity-50 cursor-not-allowed':''}`} disabled={editingLocked} onClick={()=> withStay(()=>{ const next={...batchChecked}; filtered.forEach(n=> next[n]=true); setBatchChecked(next); })}>全选</button>
                <button className={`px-2 py-1 rounded border ${editingLocked?'opacity-50 cursor-not-allowed':''}`} disabled={editingLocked} onClick={()=> withStay(()=> setBatchChecked(prev=>{ const next={...prev}; filtered.forEach(n=> next[n]=!prev[n]); return next; }))}>反选</button>
                <button className={`px-2 py-1 rounded border ${editingLocked?'opacity-50 cursor-not-allowed':''}`} disabled={editingLocked} onClick={()=> withStay(()=> setBatchChecked(prev=>{ const next={...prev}; filtered.forEach(n=> { next[n]=false; }); return next; }))}>清空</button>
              </div>
            </div>
            <div ref={listRef} className="divide-y">
              {filtered.map(name=> (
                <label key={name} className="flex items-center gap-2 py-1">
                  <input type="checkbox" disabled={editingLocked} checked={!!batchChecked[name]} onChange={()=> withStay(()=> setBatchChecked(p=>({ ...p, [name]: !p[name] })))} />
                  <span className="text-sm">{name}</span>
                </label>
              ))}
            </div>
          </div>
        );
      }

      function AlbumEmployeeChecklist(){
        const [kw, setKw] = useState('');
        const filtered = useMemo(()=>{ const k = kw.trim().toLowerCase(); return k? employees.filter(e=> e.toLowerCase().includes(k)) : employees; }, [kw, employees]);
        const listRef = useRef(null);
        const withStay = (cb)=>{ const el=listRef.current; const st=el?el.scrollTop:0; const sl=el?el.scrollLeft:0; cb(); requestAnimationFrame(()=>{ const node=listRef.current; if(node){ node.scrollTop = st; node.scrollLeft = sl; } }); };
        const selectedCount = filtered.filter(name=> !!albumSelected[name]).length;
        return (
          <div className="rounded-2xl border bg-gradient-to-br from-white via-white to-indigo-50/40 p-3">
            <div className="flex items-center gap-2 mb-2">
              <input className="border rounded px-2 py-1 text-sm flex-1" placeholder="搜索姓名…" value={kw} onChange={e=> setKw(e.target.value)} />
              <span className="text-xs text-gray-500 whitespace-nowrap">已选 {albumCheckedList.length} / {employees.length}</span>
            </div>
            <div className="flex items-center justify-between text-xs text-gray-600 mb-2">
              <div>当前筛选：{filtered.length} 人；选中 {selectedCount} 人</div>
              <div className="space-x-1">
                <button className={`px-2 py-1 rounded border text-xs ${editingLocked?'opacity-50 cursor-not-allowed':''}`} disabled={editingLocked} onClick={()=> withStay(()=>{ const next={...albumSelected}; filtered.forEach(n=> next[n]=true); setAlbumSelected(next); })}>全选</button>
                <button className={`px-2 py-1 rounded border text-xs ${editingLocked?'opacity-50 cursor-not-allowed':''}`} disabled={editingLocked || filtered.length===0} onClick={()=> withStay(()=> setAlbumSelected(prev=>{ const next={...prev}; filtered.forEach(n=>{ next[n] = !prev[n]; }); return next; }))}>反选</button>
                <button className={`px-2 py-1 rounded border text-xs ${editingLocked?'opacity-50 cursor-not-allowed':''}`} disabled={editingLocked || filtered.length===0} onClick={()=> withStay(()=> setAlbumSelected(prev=>{ const next={...prev}; filtered.forEach(n=>{ next[n] = false; }); return next; }))}>清空</button>
              </div>
            </div>
              <div ref={listRef} className="divide-y">
              {filtered.map(name=> (
                <label key={name} className="flex items-center gap-2 py-1 text-sm">
                  <input type="checkbox" checked={!!albumSelected[name]} disabled={editingLocked} onChange={()=> withStay(()=> setAlbumSelected(prev=> ({ ...prev, [name]: !prev[name] })))} />
                  <span>{name}</span>
                </label>
              ))}
              {filtered.length===0 && <div className="text-xs text-gray-400 py-3 text-center">未找到匹配人员</div>}
            </div>
            <div className="mt-3 text-xs text-gray-500 bg-indigo-50/50 rounded-xl px-3 py-2">
              勾选后的人员将参与专辑审核排班与统计；未选择偏好时不会进入预测与自动分配。
            </div>
          </div>
        );
      }

      function MainRulePanel(){
        async function runMainRule(){
          const targets = checkedList.length? checkedList : employees;
          if(targets.length===0){ alert('请先勾选人员'); return; }

          const prioritizedTargets = sortedByHistory(targets, historyProfile);

          setStage('阶段 1/6：拉齐白班（5白+2休）', 10, 100);
          let cur = buildWhiteFiveTwo({ employees: prioritizedTargets, data, start: planStart, end: planEnd, restPrefs });
          setData(cur); await waitForFrame();

          setStage('阶段 2/6：按周期交替错开放中班', 30, 100);
          cur = applyAlternateByCycle({ employees: prioritizedTargets, data: cur, start: planStart, end: planEnd }, mixMax);
          setData(cur); await waitForFrame();

          setStage('阶段 3/6：按天比例收敛', 55, 100);
          cur = clampDailyByRange({ employees: prioritizedTargets, data: cur, start: planStart, end: planEnd, rMin, rMax, maxRounds: 300, mixMaxRatio: mixMax });
          setData(cur); await waitForFrame();

          setStage('阶段 4/6：个人比例收敛', 78, 100);
          for(let sweep=0; sweep<8; sweep++){
            cur = clampDailyByRange({ employees: prioritizedTargets, data: cur, start: planStart, end: planEnd, rMin, rMax, maxRounds: 220, mixMaxRatio: mixMax });
            cur = clampPersonByRange({ employees: prioritizedTargets, data: cur, start: planStart, end: planEnd, pMin, pMax, maxRounds: 260, mixMaxRatio: mixMax });
            pushLog(`循环微调：第 ${sweep+1} 轮`);
            if((sweep+1) % 2 === 0) await waitForFrame();
          }
          setData(cur); await waitForFrame();

          setStage('阶段 5/6：参考历史与行政天数调整', 92, 100);
          cur = adjustWithHistory({ data: cur, employees: prioritizedTargets, start: planStart, end: planEnd, adminDays, historyProfile, mixMaxRatio: mixMax, yearlyOptimize });
          setData(cur); await waitForFrame();

          setStage('阶段 6/6：校验并微调', 98, 100);
          cur = repairNoMidToWhite({ data: cur, employees: prioritizedTargets, start: planStart, end: planEnd });
          setData(cur);

          endStage();
        }

        return (
          <div className="rounded-2xl border border-indigo-100/60 bg-white/80 backdrop-blur-sm p-4 space-y-3 shadow-sm transition-transform duration-300 hover:-translate-y-1 hover:shadow-xl">
            <div className="space-y-2">
              <div className="font-medium text-gray-700">自动排班日期范围</div>
              <div className="flex flex-wrap items-center gap-2 text-sm">
                <label className="inline-flex items-center gap-2">开始
                    <input type="date" className={`border rounded px-2 py-1 ${editingLocked?'bg-gray-100':''}`} value={planStart}
                      onChange={e=> handlePlanStartChange(e.target.value)} disabled={editingLocked} />
                </label>
                <span className="text-gray-400">—</span>
                <label className="inline-flex items-center gap-2">结束
                    <input type="date" className={`border rounded px-2 py-1 ${editingLocked?'bg-gray-100':''}`} value={planEnd}
                      onChange={e=> handlePlanEndChange(e.target.value)} disabled={editingLocked} />
                </label>
                <span className="text-xs text-gray-400">顶部日期仅用于筛选视图</span>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
              <div className="space-y-2">
                <div className="font-medium text-gray-700">每日比例（中1:白）</div>
                <div className="flex items-center gap-2">
                  <span>1 :</span>
                  <input type="number" step="0.05" min="0" max="3" className={`w-24 border rounded px-2 py-1 ${editingLocked?'bg-gray-100 cursor-not-allowed':''}`} value={rMin} onChange={(e)=> setRMin(Math.max(0, Math.min(3, parseFloat(e.target.value||'0'))))} disabled={editingLocked} />
                  <span>~</span>
                  <input type="number" step="0.05" min="0" max="3" className={`w-24 border rounded px-2 py-1 ${editingLocked?'bg-gray-100 cursor-not-allowed':''}`} value={rMax} onChange={(e)=> setRMax(Math.max(0, Math.min(3, parseFloat(e.target.value||'0'))))} disabled={editingLocked} />
                  <span className="text-gray-400">（示例：1:0.4~0.6）</span>
                </div>
              </div>
              <div className="space-y-2">
                <div className="font-medium text-gray-700">个人比例（中1:白）</div>
                <div className="flex items-center gap-2">
                  <span>1 :</span>
                  <input type="number" step="0.05" min="0" max="3" className={`w-24 border rounded px-2 py-1 ${editingLocked?'bg-gray-100 cursor-not-allowed':''}`} value={pMin} onChange={(e)=> setPMin(Math.max(0, Math.min(3, parseFloat(e.target.value||'0'))))} disabled={editingLocked} />
                  <span>~</span>
                  <input type="number" step="0.05" min="0" max="3" className={`w-24 border rounded px-2 py-1 ${editingLocked?'bg-gray-100 cursor-not-allowed':''}`} value={pMax} onChange={(e)=> setPMax(Math.max(0, Math.min(3, parseFloat(e.target.value||'0'))))} disabled={editingLocked} />
                  <span className="text-gray-400">（示例：1:0.4~0.6）</span>
                </div>
              </div>
            </div>
            <div className="space-y-2">
              <div className="font-medium text-gray-700">混合周期上限（比例）</div>
              <div className="flex items-center gap-2 text-sm">
                <span>混合周期 ≤ 总周期 ×</span>
                <input type="number" step="0.05" min="0" max="1" className={`w-24 border rounded px-2 py-1 ${editingLocked?'bg-gray-100 cursor-not-allowed':''}`} value={mixMax} onChange={(e)=> setMixMax(Math.max(0, Math.min(1, parseFloat(e.target.value||'0'))))} disabled={editingLocked} />
                <span className="text-gray-400">（例如：0.5 表示有白且有中的周期不超过一半）</span>
              </div>
            </div>

            <div className="flex flex-wrap items-center gap-3">
              <PillBtn color="indigo" onClick={runMainRule} disabled={editingLocked} title={editingLocked ? '当前账号仅支持查看，无法执行自动排班' : ''}>开始自动排班</PillBtn>
            </div>

            <div className="text-xs text-gray-500">规则说明：① 全程禁止生成“中1→白”相邻；② 严格遵守最多 6 天连续上班；③ 混合周期（白+中1 同在一周期）不超过设定比例；④ 夜/中2 不参与本算法但保留；⑤ 多轮“按天→按人”收敛，优先确保你的目标约束而非速度。</div>
          </div>
        );
      }

      function NightPanel(){
        return (
          <div className="rounded-2xl border border-slate-200/70 bg-white/85 backdrop-blur-sm p-4 shadow-sm transition-transform duration-300 hover:-translate-y-1 hover:shadow-xl">
            <h4 className="font-medium mb-2">夜班窗口（每天尽量有 夜 + 中2）</h4>
            <div className="space-y-2">
              {nightWindows.map((w,i)=> (
                <div key={i} className="flex flex-wrap items-end gap-2">
                  <label className="text-sm">开始 <input type="date" value={w.s} onChange={e=> setNightWindows(arr=>{ const a=[...arr]; a[i]={...a[i], s:e.target.value}; return a; })} className={`border rounded px-2 py-1 ml-1 ${editingLocked?'bg-gray-100 cursor-not-allowed':''}`} disabled={editingLocked}/></label>
                  <label className="text-sm">结束 <input type="date" value={w.e} onChange={e=> setNightWindows(arr=>{ const a=[...arr]; a[i]={...a[i], e:e.target.value}; return a; })} className={`border rounded px-2 py-1 ml-1 ${editingLocked?'bg-gray-100 cursor-not-allowed':''}`} disabled={editingLocked}/></label>
                  <button className={`px-2 py-1 border rounded ${editingLocked?'opacity-50 cursor-not-allowed':''}`} onClick={()=> setNightWindows(arr=> arr.filter((_,idx)=> idx!==i))} disabled={editingLocked}>删除</button>
                </div>
              ))}
              <button className={`px-3 py-1.5 border rounded ${editingLocked?'opacity-50 cursor-not-allowed':''}`} onClick={()=> setNightWindows(a=> [...a, {s:planStart,e:planEnd}])} disabled={editingLocked}>新增一段</button>
            </div>

            <div className="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
              <label className="inline-flex items-center gap-2"><input type="checkbox" checked={nightOverride} onChange={e=> setNightOverride(e.target.checked)} disabled={editingLocked} /> 应用夜/中2时允许覆盖现有班次</label>
              <label className="inline-flex items-center gap-2"><input type="checkbox" checked={nightRules.prioritizeInterval} onChange={e=> setNightRules(r=>({...r, prioritizeInterval:e.target.checked}))} disabled={editingLocked}/> 夜班按间隔优先分配</label>
              <label className="inline-flex items-center gap-2"><input type="checkbox" checked={nightRules.restAfterNight} onChange={e=> setNightRules(r=>({...r, restAfterNight:e.target.checked}))} disabled={editingLocked}/> 夜班后休息 2 天</label>
              <label className="inline-flex items-center gap-2"><input type="checkbox" checked={nightRules.enforceRestCap} onChange={e=> setNightRules(r=>({...r, enforceRestCap:e.target.checked}))} disabled={editingLocked}/> 夜后休息不超过 2 天</label>
              <label className="inline-flex items-center gap-2"><input type="checkbox" checked={nightRules.restAfterMid2} onChange={e=> setNightRules(r=>({...r, restAfterMid2:e.target.checked}))} disabled={editingLocked}/> 中2 后休息 2 天</label>
              <label className="inline-flex items-center gap-2"><input type="checkbox" checked={nightRules.allowDoubleMid2} onChange={e=> setNightRules(r=>({...r, allowDoubleMid2:e.target.checked}))} disabled={editingLocked}/> 允许连续 2 个中2</label>
              <label className="inline-flex items-center gap-2"><input type="checkbox" checked={nightRules.allowNightDay4} onChange={e=> setNightRules(r=>({...r, allowNightDay4:e.target.checked}))} disabled={editingLocked}/> 支持周期第 4 天排夜班</label>
            </div>

            <div className="flex flex-wrap items-center gap-3 mt-3 text-sm">
              <PillBtn color="emerald" onClick={()=>{
                if(checkedList.length===0){ alert('请先勾选人员'); return; }
                let newD={...data};
                for(const w of nightWindows){ if(!w.s||!w.e) continue; newD = autoAssignNightAndM2({ employees: checkedList, data:newD, start:w.s, end:w.e, override: nightOverride, nightRules, restPrefs }); }
                setData(newD);
              }} disabled={editingLocked} title={editingLocked ? '当前账号仅支持查看，无法执行自动排班' : ''}>AI 一键分配 夜/中2（按窗口，多段）</PillBtn>
              <span className="text-xs text-gray-500">规则：夜后两天必须休；夜后两天禁止该员工中2；中2后一天强制休。</span>
            </div>
          </div>
        );
      }

      const ViewBatch = (
        <Section title="自动分配班次" right={editingLocked? <span className='text-rose-600 text-sm inline-flex items-center gap-1'><Icon name='lock'/>执行中：只读浏览</span>: null}>
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 items-start">
            <div className="lg:col-span-1"><h3 className="font-medium mb-2">选择人员</h3><EmployeeChecklist/></div>
            <div className="lg:col-span-2 space-y-4"><MainRulePanel/><NightPanel/></div>
          </div>
        </Section>
      );

      const albumRange = useMemo(()=>{
        const spanStart = monthKeyToSpan(albumRangeStartMonth);
        const spanEnd = monthKeyToSpan(albumRangeEndMonth);
        if(!spanStart || !spanEnd) return null;
        let s = spanStart.start;
        let e = spanEnd.end;
        if(s > e){ const tmp = s; s = spanEnd.start; e = spanStart.end; }
        const clipStart = s < planStart ? planStart : s;
        const clipEnd = e > planEnd ? planEnd : e;
        if(clipStart > clipEnd) return null;
        return { start: clipStart, end: clipEnd };
      }, [albumRangeStartMonth, albumRangeEndMonth, planStart, planEnd]);
      const albumDates = useMemo(()=> albumRange? enumerateDates(albumRange.start, albumRange.end) : [], [albumRange]);

      useEffect(()=>{
        if(albumDates.length===0){
          setAlbumAssignments(prev=> Object.keys(prev||{}).length? {} : prev);
          return;
        }
        setAlbumAssignments(prev=>{
          const set = new Set(albumDates);
          let changed = false;
          const next = {};
          albumDates.forEach(d=>{
            if(prev && prev[d]){
              next[d] = prev[d];
            } else {
              next[d] = { white:'', mid:'' };
              changed = true;
            }
          });
          if(prev){
            for(const key of Object.keys(prev)){
              if(!set.has(key)){
                changed = true;
                break;
              }
            }
          }
          return changed ? next : prev;
        });
      }, [albumDates]);

      useEffect(()=>{
        if(albumCheckedList.length===0){
          setAlbumAssignments(prev=>{
            if(!prev || Object.keys(prev).length===0) return prev;
            const cleared={};
            Object.keys(prev).forEach(day=>{ cleared[day] = { white:'', mid:'' }; });
            return cleared;
          });
          return;
        }
        setAlbumAssignments(prev=>{
          if(!prev) return prev;
          const sel = new Set(albumCheckedList);
          let changed = false;
          const next = {};
          Object.entries(prev).forEach(([day, info])=>{
            const safe = info || { white:'', mid:'' };
            const white = sel.has(safe.white) ? safe.white : '';
            const mid = sel.has(safe.mid) ? safe.mid : '';
            if(white!==safe.white || mid!==safe.mid) changed = true;
            next[day] = { white, mid };
          });
          return changed ? next : prev;
        });
      }, [albumCheckedList]);

      useEffect(()=>{
        if(albumCheckedList.length===0 || albumDates.length===0){
          setAlbumAutoNote('');
        }
      }, [albumCheckedList, albumDates]);

      const albumWhiteHourValue = Number(albumWhiteHour) || 0;
      const albumMidHourValue = Number(albumMidHour) || 0;
      const albumStats = useMemo(()=>{
        const base = {};
        albumCheckedList.forEach(emp=>{
          base[emp] = { whiteDays:0, midDays:0, whiteHours:0, midHours:0, totalHours:0 };
        });
        albumDates.forEach(day=>{
          const info = albumAssignments[day] || {};
          if(info.white && base[info.white]){
            base[info.white].whiteDays += 1;
            base[info.white].whiteHours += albumWhiteHourValue;
            base[info.white].totalHours += albumWhiteHourValue;
          }
          if(info.mid && base[info.mid]){
            base[info.mid].midDays += 1;
            base[info.mid].midHours += albumMidHourValue;
            base[info.mid].totalHours += albumMidHourValue;
          }
        });
        return albumCheckedList.map(emp=> ({ emp, ...base[emp] }));
      }, [albumAssignments, albumDates, albumCheckedList, albumWhiteHourValue, albumMidHourValue]);
      const albumTotals = useMemo(()=> albumStats.reduce((acc,row)=>{
        acc.whiteDays += row.whiteDays;
        acc.midDays += row.midDays;
        acc.whiteHours += row.whiteHours;
        acc.midHours += row.midHours;
        acc.totalHours += row.totalHours;
        return acc;
      }, { whiteDays:0, midDays:0, whiteHours:0, midHours:0, totalHours:0 }), [albumStats]);
      const albumDiff = useMemo(()=>{
        if(albumStats.length===0) return 0;
        const totals = albumStats.map(r=> r.totalHours);
        return totals.length? Math.max(...totals) - Math.min(...totals) : 0;
      }, [albumStats]);
      const albumCoverage = useMemo(()=>{
        const totalDays = albumDates.length;
        let whiteAssigned = 0;
        let midAssigned = 0;
        albumDates.forEach(day=>{
          const info = albumAssignments[day] || {};
          if(info.white) whiteAssigned += 1;
          if(info.mid) midAssigned += 1;
        });
        return { totalDays, whiteAssigned, midAssigned };
      }, [albumDates, albumAssignments]);

      const exportAlbumPlan = ()=>{
        if(albumDates.length===0){
          alert('暂无可导出的专辑审核排班数据');
          return;
        }
        const escape = (val)=> String(val||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
        const headerHtml = '<tr><th>日期</th><th>星期</th><th>白班审核人</th><th>中班审核人</th></tr>';
        const bodyHtml = albumDates.map(day=>{
          const info = albumAssignments[day] || { white:'', mid:'' };
          const weekLabel = '周' + WN[new Date(day).getDay()];
          return `<tr><td>${escape(day)}</td><td>${escape(weekLabel)}</td><td>${escape(info.white||'')}</td><td>${escape(info.mid||'')}</td></tr>`;
        }).join('');
        const tableHtml = `<table>${headerHtml}${bodyHtml}</table>`;
        const blob = new Blob(['\ufeff' + tableHtml], { type: 'application/vnd.ms-excel' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        const rangeLabel = albumRange ? `_${albumRange.start}_${albumRange.end}` : '';
        link.href = url;
        link.download = `专辑审核排班表${rangeLabel}.xls`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(()=> URL.revokeObjectURL(url), 200);
      };

      const confirmAlbumPlan = ()=>{
        if(editingLocked){ alert('执行中：请稍后再试'); return; }
        if(!albumRange || albumDates.length===0){ alert('请先设置有效的月份范围并生成排班'); return; }
        const snapshot = {};
        albumDates.forEach(day=>{
          const info = albumAssignments[day] || { white:'', mid:'' };
          snapshot[day] = { white: info.white || '', mid: info.mid || '' };
        });
        const hasAny = Object.values(snapshot).some(info=> info.white || info.mid);
        if(!hasAny && !confirm('当前排班表全部未分配，仍然确认并保存吗？')) return;
        const existingIdx = albumHistory.findIndex(item=> item?.range?.start===albumRange.start && item?.range?.end===albumRange.end);
        if(existingIdx>=0 && !confirm('该时间范围已存在确认排班，继续将覆盖历史记录，是否继续？')) return;
        const entry = {
          id: `album-${Date.now()}`,
          savedAt: new Date().toISOString(),
          range: { start: albumRange.start, end: albumRange.end },
          assignments: snapshot,
          whiteHour: albumWhiteHourValue,
          midHour: albumMidHourValue,
          totals: { ...albumTotals },
          diff: albumDiff,
          coverage: { ...albumCoverage }
        };
        setAlbumHistory(prev=>{
          const next = existingIdx>=0 ? prev.filter((_,idx)=> idx!==existingIdx) : prev.slice();
          return [entry, ...next];
        });
        setAlbumAutoNote('排班已确认并保存，可在统计视图查看历史与分析。');
      };

      const autoAssignAlbum = ()=>{
        if(editingLocked){ alert('当前账号仅支持查看，无法执行自动排班'); return; }
        if(albumCheckedList.length===0){ alert('请先在左侧勾选参与专辑审核的人员'); return; }
        if(albumDates.length===0){ alert('请先设置有效的月份范围，并确保与当前排班范围有交集'); return; }
        const diffLimitRaw = Number(albumMaxDiff);
        const diffLimit = Number.isFinite(diffLimitRaw) ? Math.max(0, diffLimitRaw) : Infinity;
        const { plan, note } = planAlbumSchedule({
          albumDates,
          albumCheckedList,
          data,
          whiteHour: albumWhiteHourValue,
          midHour: albumMidHourValue,
          diffLimit
        });
        setAlbumAssignments(plan);
        setAlbumAutoNote(note);
      };

      const updateAlbumAssignment = (day, field, value)=>{
        if(editingLocked) return;
        setAlbumAssignments(prev=> ({
          ...prev,
          [day]: { ...(prev?.[day]||{ white:'', mid:'' }), [field]: value }
        }));
        setAlbumAutoNote('排班已更新，右侧统计已同步。');
      };

      const ViewAlbum = (
        <Section title="专辑审核自动排班" right={<span className="text-xs text-gray-500">白班 1 人 + 中1 1 人，时长均衡的审核计划</span>}>
          <div className="grid grid-cols-1 xl:grid-cols-4 gap-4 items-start">
            <div className="space-y-4">
              <div className="rounded-2xl border bg-gradient-to-br from-white via-white to-amber-50/60 p-4 space-y-3">
                <div className="flex items-center gap-2 text-sm font-medium text-amber-700"><Icon name="magic" className="w-4 h-4"/>自动排班参数</div>
                <div className="grid grid-cols-1 gap-2 text-sm text-gray-600">
                  <label className="flex items-center justify-between gap-2">开始月份<MonthInput className="border rounded px-2 py-1" value={albumRangeStartMonth} onChange={setAlbumRangeStartMonth} disabled={editingLocked} /></label>
                  <label className="flex items-center justify-between gap-2">结束月份<MonthInput className="border rounded px-2 py-1" value={albumRangeEndMonth} onChange={setAlbumRangeEndMonth} disabled={editingLocked} /></label>
                  <label className="flex items-center justify-between gap-2">白班时长（小时）<input type="number" step="0.01" min="0" className={`border rounded px-2 py-1 w-24 text-right ${editingLocked?'bg-gray-100 cursor-not-allowed':''}`} value={albumWhiteHour}
                    onChange={e=> setAlbumWhiteHour(Number.parseFloat(e.target.value||'0')||0)} disabled={editingLocked} /></label>
                  <label className="flex items-center justify-between gap-2">中1时长（小时）<input type="number" step="0.01" min="0" className={`border rounded px-2 py-1 w-24 text-right ${editingLocked?'bg-gray-100 cursor-not-allowed':''}`} value={albumMidHour}
                    onChange={e=> setAlbumMidHour(Number.parseFloat(e.target.value||'0')||0)} disabled={editingLocked} /></label>
                  <label className="flex items-center justify-between gap-2">允许时长差值 ±<input type="number" step="0.01" min="0" className={`border rounded px-2 py-1 w-24 text-right ${editingLocked?'bg-gray-100 cursor-not-allowed':''}`} value={albumMaxDiff}
                    onChange={e=> setAlbumMaxDiff(e.target.value===''?0:Number.parseFloat(e.target.value)||0)} disabled={editingLocked} /></label>
                </div>
                <PillBtn color="indigo" onClick={autoAssignAlbum} disabled={editingLocked || albumCheckedList.length===0 || albumDates.length===0} title={editingLocked ? '当前账号仅支持查看，无法执行自动排班' : (albumCheckedList.length===0? '请先勾选人员': albumDates.length===0? '请先设置有效月份范围': '')}>智能生成专辑审核排班</PillBtn>
                {albumAutoNote && <div className="text-xs text-indigo-600 bg-indigo-50/80 border border-indigo-100 rounded-xl px-3 py-2">{albumAutoNote}</div>}
                <div className="text-xs text-gray-500">提示：参数调整后可重新生成；排班结果支持右侧表格内手动微调。</div>
              </div>
              <AlbumEmployeeChecklist/>
            </div>

            <div className="space-y-4 xl:col-span-3">
              <div className="rounded-2xl border bg-white/90 p-4">
                <div className="flex flex-wrap items-center justify-between gap-2 text-sm font-medium text-gray-700">
                  <div className="flex items-center gap-2">
                    <span>排班概览</span>
                    <span className="text-xs text-gray-400">{albumRange? `${albumRange.start} ~ ${albumRange.end}` : '请选择排班月份范围'}</span>
                  </div>
                  <div className="flex items-center gap-2">
                    <PillBtn color="emerald" onClick={confirmAlbumPlan} disabled={editingLocked || !albumRange || albumDates.length===0} title={editingLocked? '执行中：只读': (!albumRange || albumDates.length===0 ? '请先设置有效的月份范围' : '确认排班并写入历史')}>确认排班</PillBtn>
                    <PillBtn color="gray" onClick={exportAlbumPlan} disabled={albumDates.length===0} title={albumDates.length===0 ? '暂无可导出的排班数据' : '导出为 Excel'}>导出 Excel</PillBtn>
                  </div>
                </div>
                {albumRange ? (
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-2 mt-3 text-sm">
                    <div className="rounded-2xl border bg-gradient-to-br from-indigo-50 to-white px-3 py-2">
                      <div className="text-xs text-gray-500">覆盖天数</div>
                      <div className="text-lg font-semibold text-indigo-700">{albumCoverage.totalDays}</div>
                    </div>
                    <div className="rounded-2xl border bg-gradient-to-br from-sky-50 to-white px-3 py-2">
                      <div className="text-xs text-gray-500">白班已分配</div>
                      <div className="text-lg font-semibold text-sky-600">{albumCoverage.whiteAssigned}<span className="text-xs text-gray-500 ml-1">天</span></div>
                    </div>
                    <div className="rounded-2xl border bg-gradient-to-br from-amber-50 to-white px-3 py-2">
                      <div className="text-xs text-gray-500">中1已分配</div>
                      <div className="text-lg font-semibold text-amber-600">{albumCoverage.midAssigned}<span className="text-xs text-gray-500 ml-1">天</span></div>
                    </div>
                    <div className="rounded-2xl border bg-gradient-to-br from-emerald-50 to-white px-3 py-2">
                      <div className="text-xs text-gray-500">时长差值</div>
                      <div className={`text-lg font-semibold ${albumDiff <= (Number.isFinite(albumMaxDiff)? Math.max(0, albumMaxDiff) : albumDiff+1) ? 'text-emerald-600':'text-rose-600'}`}>{albumDiff.toFixed(2)}<span className="text-xs text-gray-500 ml-1">小时</span></div>
                    </div>
                  </div>
                ) : (
                  <div className="text-xs text-gray-500 mt-3">尚未设置有效范围，请在左侧选择月份。</div>
                )}
              </div>

              <div className="rounded-2xl border bg-white overflow-hidden">
                <div className="px-4 py-3 border-b bg-gray-50 text-sm font-medium text-gray-700 flex items-center justify-between">
                  <span>播单专辑审核排班表</span>
                  <div className="flex items-center gap-3">
                    <span className="text-xs text-gray-400">支持手动微调，实时更新统计</span>
                    <button onClick={exportAlbumPlan} disabled={albumDates.length===0}
                      className={`px-3 py-1.5 rounded-full text-xs font-medium transition-colors ${albumDates.length===0 ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-indigo-600 text-white hover:bg-indigo-500'}`}>
                      导出 Excel
                    </button>
                  </div>
                </div>
                {albumDates.length===0 ? (
                  <div className="p-4 text-xs text-gray-500">请选择有效月份后再生成排班。</div>
                ) : (
                  <div className="overflow-auto">
                    <table className="min-w-[520px] w-full text-sm">
                      <thead className="bg-gray-50 text-gray-500">
                        <tr>
                          <th className="text-left py-2 px-3">日期</th>
                          <th className="text-left py-2 px-3">星期</th>
                          <th className="text-left py-2 px-3">白班审核人</th>
                          <th className="text-left py-2 px-3">中班审核人</th>
                        </tr>
                      </thead>
                      <tbody>
                        {albumDates.map(day=>{
                          const info = albumAssignments[day] || { white:'', mid:'' };
                          const row = data[day] || {};
                          const weekLabel = WN[new Date(day).getDay()];
                          const whiteCandidates = albumCheckedList.filter(emp=> (row[emp]||'')==='白');
                          const midCandidates = albumCheckedList.filter(emp=> (row[emp]||'')==='中1');
                          const whiteClass = `border rounded px-2 py-1 w-full text-sm transition-colors ${info.white ? 'bg-white border-gray-200 text-gray-700' : 'bg-rose-50 border-rose-200 text-rose-600'} ${editingLocked?'opacity-60 cursor-not-allowed':''}`;
                          const midClass = `border rounded px-2 py-1 w-full text-sm transition-colors ${info.mid ? 'bg-white border-gray-200 text-gray-700' : 'bg-rose-50 border-rose-200 text-rose-600'} ${editingLocked?'opacity-60 cursor-not-allowed':''}`;
                          return (
                            <tr key={`album-${day}`} className="border-t hover:bg-indigo-50/20">
                              <td className="py-1.5 px-3 font-medium text-gray-700">{day}</td>
                              <td className="py-1.5 px-3 text-gray-500">周{weekLabel}</td>
                              <td className="py-1.5 px-3">
                                <select
                                  className={whiteClass}
                                  value={info.white || ''}
                                  onChange={e=> updateAlbumAssignment(day, 'white', e.target.value)}
                                  title={editingLocked ? '当前账号仅支持查看' : (whiteCandidates.length===0 ? '当日无白班可选' : '请选择白班审核人')}
                                  disabled={editingLocked}
                                >
                                  <option value="">未分配</option>
                                  {whiteCandidates.map(emp=> (
                                    <option key={`${day}-${emp}-white`} value={emp}>{emp}</option>
                                  ))}
                                </select>
                              </td>
                              <td className="py-1.5 px-3">
                                <select
                                  className={midClass}
                                  value={info.mid || ''}
                                  onChange={e=> updateAlbumAssignment(day, 'mid', e.target.value)}
                                  title={editingLocked ? '当前账号仅支持查看' : (midCandidates.length===0 ? '当日无中1可选' : '请选择中班审核人')}
                                  disabled={editingLocked}
                                >
                                  <option value="">未分配</option>
                                  {midCandidates.map(emp=> (
                                    <option key={`${day}-${emp}-mid`} value={emp}>{emp}</option>
                                  ))}
                                </select>
                              </td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>

              <div className="rounded-2xl border bg-white overflow-hidden">
                <div className="px-4 py-3 border-b bg-gray-50 text-sm font-medium text-gray-700 flex items-center justify-between">
                  <span>筛选范围内班次预览</span>
                  <span className="text-xs text-gray-400">仅显示已勾选人员</span>
                </div>
                {albumDates.length===0 || albumCheckedList.length===0 ? (
                  <div className="p-4 text-xs text-gray-500">请选择人员并确保月份范围与当前排班有交集。</div>
                ) : (
                  <div className="overflow-auto">
                    <table className="min-w-[620px] w-full text-sm">
                      <thead className="bg-gray-50 text-gray-500">
                        <tr>
                          <th className="text-left py-2 px-3">日期</th>
                          <th className="text-left py-2 px-3">星期</th>
                          {albumCheckedList.map(emp=> <th key={emp} className="text-left py-2 px-3">{emp}</th>)}
                        </tr>
                      </thead>
                      <tbody>
                        {albumDates.map(day=>{
                          const wk = WN[new Date(day).getDay()];
                          return (
                            <tr key={`preview-${day}`} className="border-t hover:bg-gray-50">
                              <td className="py-1.5 px-3 font-medium text-gray-700">{day}</td>
                              <td className="py-1.5 px-3 text-gray-500">周{wk}</td>
                              {albumCheckedList.map(emp=>{
                                const shift = (data[day]||{})[emp] || '';
                                const bg = shiftColors[shift] || '#f9fafb';
                                return (
                                  <td key={`${day}-${emp}`} className="py-1.5 px-3">
                                    <span className="px-2 py-1 rounded-full text-xs" style={{ backgroundColor: bg }}>{shift || '—'}</span>
                                  </td>
                                );
                              })}
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>

              <div className="rounded-2xl border bg-white overflow-hidden">
                <div className="px-4 py-3 border-b bg-gray-50 text-sm font-medium text-gray-700 flex items-center justify-between">
                  <span>人员审核时长统计</span>
                  <span className="text-xs text-gray-400">实时对齐白班/中班天数与小时</span>
                </div>
                {albumCheckedList.length===0 ? (
                  <div className="p-4 text-xs text-gray-500">尚未勾选专辑审核人员。</div>
                ) : (
                  <div className="overflow-auto">
                    <table className="min-w-[600px] w-full text-sm">
                      <thead className="bg-gray-50 text-gray-500">
                        <tr>
                          <th className="text-left py-2 px-3">人员</th>
                          <th className="text-right py-2 px-3">白班天数</th>
                          <th className="text-right py-2 px-3">白班时长</th>
                          <th className="text-right py-2 px-3">中班天数</th>
                          <th className="text-right py-2 px-3">中班时长</th>
                          <th className="text-right py-2 px-3">总时长</th>
                        </tr>
                      </thead>
                      <tbody>
                        {albumStats.map(row=> (
                          <tr key={`stat-${row.emp}`} className="border-t hover:bg-gray-50">
                            <td className="py-1.5 px-3 text-gray-700">{row.emp}</td>
                            <td className="py-1.5 px-3 text-right">{row.whiteDays}</td>
                            <td className="py-1.5 px-3 text-right">{row.whiteHours.toFixed(2)}</td>
                            <td className="py-1.5 px-3 text-right">{row.midDays}</td>
                            <td className="py-1.5 px-3 text-right">{row.midHours.toFixed(2)}</td>
                            <td className="py-1.5 px-3 text-right font-medium">{row.totalHours.toFixed(2)}</td>
                          </tr>
                        ))}
                      </tbody>
                      <tfoot className="bg-indigo-50/60 text-sm">
                        <tr>
                          <td className="py-2 px-3 font-medium text-gray-700">合计</td>
                          <td className="py-2 px-3 text-right font-medium">{albumTotals.whiteDays}</td>
                          <td className="py-2 px-3 text-right font-medium">{albumTotals.whiteHours.toFixed(2)}</td>
                          <td className="py-2 px-3 text-right font-medium">{albumTotals.midDays}</td>
                          <td className="py-2 px-3 text-right font-medium">{albumTotals.midHours.toFixed(2)}</td>
                          <td className="py-2 px-3 text-right font-semibold text-indigo-700">{albumTotals.totalHours.toFixed(2)}</td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                )}
              </div>
            </div>
          </div>
        </Section>
      );

      const [empInput, setEmpInput] = useState('');
      const restForecast = useMemo(()=>{
        const base = {1:0,2:0,3:0,4:0,5:0,6:0,7:0};
        employees.forEach(emp=>{
          const pref = restPrefs[emp];
          if(!pref) return;
          const restDays = pairToSet(pref);
          for(let w=1; w<=7; w++){
            if(!restDays.has(w)) base[w]+=1;
          }
        });
        return base;
      }, [employees, restPrefs]);
      const hasRestForecast = useMemo(()=> employees.some(emp=> !!restPrefs[emp]), [employees, restPrefs]);
      const ViewEmployees = (
        <Section title="员工管理" right={<span className="text-sm text-gray-500">休息偏好保存在服务器与本地（跨视图持久）</span>}>
          <div className="grid grid-cols-1">
            <div className="mb-6">
              <div className="flex items-center justify-between mb-2">
                <h3 className="text-sm font-medium text-gray-700">周一至周日在岗人数预测</h3>
                <span className="text-xs text-gray-400">仅统计已选择休息偏好的人员</span>
              </div>
              <div className="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-2">
                {['周一','周二','周三','周四','周五','周六','周日'].map((label,idx)=>{
                  const day = idx+1;
                  return (
                    <div key={label} className="rounded-2xl border bg-gradient-to-br from-white to-sky-50/60 p-3 text-center shadow-sm">
                      <div className="text-xs text-gray-500">{label}</div>
                      <div className="text-xl font-semibold text-sky-600">{restForecast[day] || 0}<span className="text-sm text-gray-500 ml-1">人</span></div>
                    </div>
                  );
                })}
              </div>
              {!hasRestForecast && <div className="text-xs text-gray-500 mt-2">请选择休息偏好后即可实时看到在岗人数预测。</div>}
            </div>
            <div className="mb-4">
              <label className="block text-sm text-gray-600 mb-1">批量添加（每行/逗号分隔）</label>
              <div className="flex gap-2 items-start">
                <textarea className="flex-1 border rounded px-3 py-2 h-24" value={empInput}
                  onCompositionStart={()=>{}}
                  onCompositionEnd={(e)=>{ setEmpInput(e.target.value); }}
                  onChange={e=>setEmpInput(e.target.value)} placeholder="张三\n李四" />
                <PillBtn onClick={()=>{ empInput.split(/\n|,|\s+/).forEach(n=>{ const name=(n||'').trim(); if(name && !employees.includes(name)) setEmployees(prev=>[...prev, name]); }); setEmpInput(''); }} disabled={editingLocked} title={editingLocked?'执行中：只读':''}>添加</PillBtn>
              </div>
            </div>
            <div className="overflow-auto">
              <table className="text-sm min-w-[760px] w-full">
                <thead>
                  <tr className="text-gray-500"><th className="text-left">姓名</th><th className="text-left">本次休息偏好</th><th className="text-left">操作</th></tr>
                </thead>
                <tbody>
                  {employees.map(e=> (
                    <tr key={e} className="border-t hover:bg-gray-50">
                      <td className="py-1">{e}</td>
                      <td className="py-1">
                        <div className="flex items-center gap-2">
                          {REST_PAIRS.map(p=> (
                            <label key={p} className={`px-2 py-1 rounded border cursor-pointer ${restPrefs[e]===p? 'bg-indigo-50 border-indigo-300 text-indigo-700':'hover:bg-gray-50'} ${editingLocked?'opacity-60 cursor-not-allowed':''}`}>
                              <input type="radio" name={`rest-${e}`} disabled={editingLocked} className="mr-1" checked={restPrefs[e]===p} onChange={()=> setRestPrefs(r=> ({...r, [e]: sanitizeRestPairValue(p)}))} /> 休{p}
                            </label>
                          ))}
                          <button className={`px-2 py-1 rounded border ${editingLocked?'opacity-60 cursor-not-allowed':''}`} disabled={editingLocked} onClick={()=> setRestPrefs(r=>{ const x={...r}; delete x[e]; return x; })}>清除偏好</button>
                        </div>
                      </td>
                      <td className="py-1"><button className={`text-red-600 ${editingLocked?'opacity-60 cursor-not-allowed':''}`} disabled={editingLocked} onClick={()=>{
                        setEmployees(prev=> prev.filter(x=>x!==e));
                        setData(prev=>{ const next={...prev}; for(const d of Object.keys(next)){ if(next[d] && (e in (next[d]||{}))){ const r={...next[d]}; delete r[e]; next[d]=r; } } return next; });
                        setRestPrefs(r=>{ const x={...r}; delete x[e]; return x; });
                      }}>删除</button></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            <div className="mt-3 text-xs text-gray-500">人员与偏好会随编辑自动保存，并参与团队备份。</div>
          </div>
        </Section>
      );

      function periodRanges(){
        const baseStart = viewStart || planStart;
        const baseEnd = viewEnd || planEnd;
        const orderedStart = baseStart <= baseEnd ? baseStart : baseEnd;
        const orderedEnd = baseStart <= baseEnd ? baseEnd : baseStart;
        const dS=new Date(orderedStart);
        const yS = fmt(new Date(dS.getFullYear(),0,1)); const yE = fmt(new Date(dS.getFullYear(),11,31));
        const q = Math.floor(dS.getMonth()/3); const qS = fmt(new Date(dS.getFullYear(), q*3, 1)); const qE = fmt(new Date(dS.getFullYear(), q*3+3, 0));
        const mS = fmt(new Date(dS.getFullYear(), dS.getMonth(), 1)); const mE = fmt(new Date(dS.getFullYear(), dS.getMonth()+1, 0));
        return { y:{s:yS,e:yE}, q:{s:qS,e:qE}, m:{s:mS,e:mE}, r:{s:orderedStart,e:orderedEnd} };
      }
      const ViewStats = (()=>{
        const ranges = periodRanges();
        const [statPeriod, setStatPeriod] = useState('r');
        const [statView, setStatView] = useState('person');
        const [showRestCounts, setShowRestCounts] = useState(true);
        const [orderBy, setOrderBy] = useState('default');
        const [albumStatMode, setAlbumStatMode] = useState('analysis');
        const cur = statPeriod==='y'? ranges.y : statPeriod==='q'? ranges.q : statPeriod==='m'? ranges.m : ranges.r;
        const daysLen = useMemo(()=> enumerateDates(cur.s, cur.e).length, [cur.s, cur.e]);
        const C = useMemo(()=> countByEmpInRange(employees, data, cur.s, cur.e), [employees, data, cur.s, cur.e]);
        const avg = useMemo(()=>{ const sum={白:0,中1:0,中2:0,夜:0,总:0}; for(const e of employees){ sum.白+=C[e]?.白||0; sum.中1+=C[e]?.中1||0; sum.中2+=C[e]?.中2||0; sum.夜+=C[e]?.夜||0; sum.总+=C[e]?.总||0; } const n = Math.max(1, employees.length); return { 白:(sum.白/n).toFixed(1), 中1:(sum.中1/n).toFixed(1), 中2:(sum.中2/n).toFixed(1), 夜:(sum.夜/n).toFixed(1), 总:(sum.总/n).toFixed(1) }; }, [employees, C]);

        // —— 新增：每日分布与总和分析 ——
        const monthSpans = useMemo(()=> monthListBetween(cur.s, cur.e), [cur.s, cur.e]);
        const daySeries = useMemo(()=>{
          const list = enumerateDates(cur.s, cur.e);
          return list.map(d=>{
            const row = data[d]||{}; let W=0,M=0,N2=0,N=0; for(const e of employees){ const v=row[e]; if(!v||v==='休') continue; if(v==='白') W++; else if(v==='中1') M++; else if(v==='中2') N2++; else if(v==='夜') N++; } const total=W+M+N2+N; return { d, W, M, N2, N, total };
          });
        }, [data, employees, cur.s, cur.e]);
        const sumTotals = useMemo(()=> daySeries.reduce((acc,s)=>{ acc.白+=s.W; acc.中1+=s.M; acc.中2+=s.N2; acc.夜+=s.N; acc.总+=s.total; return acc; }, {白:0,中1:0,中2:0,夜:0,总:0}), [daySeries]);
        const totalDays = daySeries.length;
        const dailyAvg = {
          总: totalDays? (sumTotals.总/totalDays).toFixed(1) : '0.0',
          白: totalDays? (sumTotals.白/totalDays).toFixed(1) : '0.0',
          中1: totalDays? (sumTotals.中1/totalDays).toFixed(1) : '0.0'
        };
        const restTotal = useMemo(()=> employees.length*daysLen - sumTotals.总, [employees.length, daysLen, sumTotals.总]);
        const peakMid = useMemo(()=> daySeries.reduce((best,s)=> s.M>best.val ? {d:s.d, val:s.M} : best, {d:'—', val:-1}), [daySeries]);
        const peakWhite = useMemo(()=> daySeries.reduce((best,s)=> s.W>best.val ? {d:s.d, val:s.W} : best, {d:'—', val:-1}), [daySeries]);

        const restCycles = useMemo(()=>{
          return employees.map(emp=>{
            const months = {};
            monthSpans.forEach(span=>{
              const clipStart = cur.s > span.start ? cur.s : span.start;
              const clipEnd = cur.e < span.end ? cur.e : span.end;
              if(clipStart > clipEnd){
                months[span.key] = { display:'', bestPair:'', counts:{}, hasData:false };
                return;
              }
              const dates = enumerateDates(clipStart, clipEnd);
              let hasData = false;
              const weekMap = {};
              dates.forEach(day=>{
                const row = data[day];
                if(!row) return;
                const v = row[emp];
                if(v){ hasData = true; }
                if(v === '休'){
                  const wk = weekStartKey(day);
                  if(!weekMap[wk]) weekMap[wk] = [];
                  weekMap[wk].push(day);
                }
              });
              if(!hasData){
                months[span.key] = { display:'', bestPair:'', counts:{}, hasData:false };
                return;
              }
              const counts = {};
              Object.values(weekMap).forEach(days=>{
                if(days.length < 2) return;
                const sortedDays = days.slice().sort();
                const rawPair = sortedDays.slice(0,2).map(day=> dayToW(day)).join('');
                const pair = normalizeRestPair(rawPair);
                if(pair){ counts[pair] = (counts[pair]||0) + 1; }
              });
              if(!Object.keys(counts).length){
                months[span.key] = { display:'—', bestPair:'', counts:{}, hasData:true };
                return;
              }
              let bestPair = '';
              let bestCount = -1;
              Object.entries(counts).forEach(([pair,count])=>{
                if(count > bestCount || (count === bestCount && pair < bestPair)){
                  bestPair = pair;
                  bestCount = count;
                }
              });
              months[span.key] = {
                display: bestPair ? `休${bestPair}` : '—',
                bestPair: bestPair || '',
                counts,
                hasData:true
              };
            });
            return { emp, months };
          });
        }, [employees, data, monthSpans, cur.s, cur.e]);

        const restPairAverages = useMemo(()=>{
          if(monthSpans.length===0){
            return REST_PAIRS.map(pair=> ({ pair, avg:'0.0' }));
          }
          const totals = REST_PAIRS.reduce((acc,p)=>{ acc[p]=0; return acc; }, {});
          monthSpans.forEach(span=>{
            restCycles.forEach(row=>{
              const info = row.months[span.key];
              const pair = info?.bestPair;
              if(pair && (pair in totals)) totals[pair] += 1;
            });
          });
          return REST_PAIRS.map(pair=> ({ pair, avg: (totals[pair]/monthSpans.length).toFixed(1) }));
        }, [restCycles, monthSpans]);
        const restCycleTotals = useMemo(()=>{
          return restCycles.map(row=>{
            const totals = REST_PAIRS.reduce((acc,p)=>{ acc[p]=0; return acc; }, {});
            let effective = 0;
            monthSpans.forEach(span=>{
              const info = row.months?.[span.key];
              if(info?.hasData){
                effective += 1;
                if(info.bestPair && (info.bestPair in totals)) totals[info.bestPair] += 1;
              }
            });
            return { emp: row.emp, totals, effective };
          });
        }, [restCycles, monthSpans]);

        const albumEntriesSorted = useMemo(()=>{
          const parseStamp = (entry)=>{
            const raw = entry?.savedAt || entry?.createdAt || entry?.updatedAt || '';
            const ts = raw ? Date.parse(raw) : 0;
            return Number.isFinite(ts) ? ts : 0;
          };
          return albumHistory.slice().sort((a,b)=>{
            const diff = parseStamp(b) - parseStamp(a);
            if(diff !== 0) return diff;
            const keyA = albumEntryKey(a);
            const keyB = albumEntryKey(b);
            return keyB.localeCompare(keyA);
          });
        }, [albumHistory]);
        const albumAggregate = useMemo(()=>{
          const dayAssignment = {};
          const entryActiveCount = {};
          albumEntriesSorted.forEach((entry, idx)=>{
            const key = albumEntryKey(entry, idx);
            const assignments = entry?.assignments || {};
            const whiteHour = Number(entry?.whiteHour) || 0;
            const midHour = Number(entry?.midHour) || 0;
            Object.entries(assignments).forEach(([day, info])=>{
              if(dayAssignment[day]) return;
              dayAssignment[day] = {
                white: info?.white || '',
                mid: info?.mid || '',
                whiteHour,
                midHour,
                key
              };
              entryActiveCount[key] = (entryActiveCount[key] || 0) + 1;
            });
          });
          return { dayAssignment, entryActiveCount };
        }, [albumEntriesSorted]);
        const albumEntriesInRange = useMemo(()=>{
          if(!cur?.s || !cur?.e) return [];
          const result = [];
          albumEntriesSorted.forEach((entry, idx)=>{
            const assignments = entry?.assignments || {};
            if(!assignments || !Object.keys(assignments).length) return;
            const key = albumEntryKey(entry, idx);
            const activeCount = albumAggregate.entryActiveCount[key] || 0;
            if(activeCount === 0) return;
            for(const day of Object.keys(assignments)){
              if(day < cur.s || day > cur.e) continue;
              if(albumAggregate.dayAssignment[day]?.key === key){
                result.push({ entry, key, activeCount });
                break;
              }
            }
          });
          return result;
        }, [albumEntriesSorted, albumAggregate, cur?.s, cur?.e]);
        const albumAnalysis = useMemo(()=>{
          const perEmp = {};
          const employeeSet = new Set();
          const summary = { batches: albumEntriesInRange.length, whiteDays:0, midDays:0, whiteHours:0, midHours:0, totalHours:0 };
          Object.entries(albumAggregate.dayAssignment).forEach(([day, detail])=>{
            if(!detail) return;
            if(day < cur.s || day > cur.e) return;
            const { white, mid, whiteHour, midHour } = detail;
            if(white){
              if(!perEmp[white]) perEmp[white] = { whiteDays:0, whiteHours:0, midDays:0, midHours:0 };
              perEmp[white].whiteDays += 1;
              perEmp[white].whiteHours += whiteHour;
              summary.whiteDays += 1;
              summary.whiteHours += whiteHour;
              summary.totalHours += whiteHour;
              employeeSet.add(white);
            }
            if(mid){
              if(!perEmp[mid]) perEmp[mid] = { whiteDays:0, whiteHours:0, midDays:0, midHours:0 };
              perEmp[mid].midDays += 1;
              perEmp[mid].midHours += midHour;
              summary.midDays += 1;
              summary.midHours += midHour;
              summary.totalHours += midHour;
              employeeSet.add(mid);
            }
          });
          const rows = Object.entries(perEmp).map(([emp,val])=> ({
            emp,
            whiteDays: val.whiteDays,
            whiteHours: val.whiteHours,
            midDays: val.midDays,
            midHours: val.midHours,
            totalHours: (val.whiteHours || 0) + (val.midHours || 0)
          })).sort((a,b)=> b.totalHours - a.totalHours || a.emp.localeCompare(b.emp,'zh-CN'));
          const batches = summary.batches || 0;
          const employeeCount = employeeSet.size;
          return {
            rows,
            summary: {
              ...summary,
              employeeCount,
              avgTotalHoursPerBatch: batches? summary.totalHours / batches : 0,
              avgWhiteHoursPerBatch: batches? summary.whiteHours / batches : 0,
              avgMidHoursPerBatch: batches? summary.midHours / batches : 0,
              avgHoursPerEmployee: employeeCount? summary.totalHours / employeeCount : 0
            }
          };
        }, [albumAggregate, albumEntriesInRange.length, cur.s, cur.e]);
        const albumHistoryForView = useMemo(()=>{
          if(!cur?.s || !cur?.e) return [];
          const result = [];
          albumEntriesSorted.forEach((entry, idx)=>{
            const assignments = entry?.assignments || {};
            if(!assignments || !Object.keys(assignments).length) return;
            const hasOverlap = Object.keys(assignments).some(day=> day>=cur.s && day<=cur.e);
            if(!hasOverlap) return;
            const key = albumEntryKey(entry, idx);
            const activeCount = albumAggregate.entryActiveCount[key] || 0;
            result.push({ entry, key, activeCount });
          });
          return result;
        }, [albumEntriesSorted, albumAggregate, cur?.s, cur?.e]);
        const albumSummary = albumAnalysis.summary || { batches:0, whiteDays:0, midDays:0, whiteHours:0, midHours:0, totalHours:0, employeeCount:0, avgTotalHoursPerBatch:0, avgWhiteHoursPerBatch:0, avgMidHoursPerBatch:0, avgHoursPerEmployee:0 };
        const albumRows = albumAnalysis.rows || [];

        const rows = useMemo(()=>{
          const arr = employees.map(e=>{
            const total=C[e]?.总||0; const W=C[e]?.白||0; const M=C[e]?.中1||0; const N2=C[e]?.中2||0; const N=C[e]?.夜||0;
            const ratio = (W>0? (M/W) : (M>0? Infinity:0));
            const ratioStr = (ratio===Infinity? '∞' : ratio.toFixed(2));
            const diff = total - Number(adminDays||0);
            const restDays = daysLen - total; // 统计期内的休/空
            const cycTot = cyclesForEmp(data, e, cur.s, cur.e).length; const cycMix = mixedCyclesCount(data, e, cur.s, cur.e); const cycRatio = cycTot>0? (cycMix/cycTot) : 0;
            const longest = longestRun(data, e, cur.s, cur.e);
            const pass = (ratio!==Infinity && W>0) ? (ratio >= pMin && ratio <= pMax) : (W===0? (M===0) : false);
            const mixOk = cycRatio <= (mixMax||1);
            return { e, W, M, N2, N, total, diff, ratio, ratioStr, restDays, cycTot, cycMix, cycRatio, longest, pass, mixOk };
          });
          switch(orderBy){
            case 'diff': arr.sort((a,b)=> (b.diff)-(a.diff)); break;
            case 'longest': arr.sort((a,b)=> (b.longest)-(a.longest)); break;
            case 'ratioDev': arr.sort((a,b)=> Math.abs((b.ratio||0)-( (pMin+pMax)/2 )) - Math.abs((a.ratio||0)-( (pMin+pMax)/2 )) ); break;
            case 'mix': arr.sort((a,b)=> (b.cycRatio)-(a.cycRatio)); break;
            default: break;
          }
          return arr;
        }, [employees, C, daysLen, adminDays, pMin, pMax, mixMax, orderBy, data, cur.s, cur.e]);

        return (
          <Section title={`统计与对齐（${cur.s} ~ ${cur.e}）`} right={<div className="flex flex-wrap items-center gap-2 text-sm"><label>周期：</label><select className="border rounded px-2 py-1" value={statPeriod} onChange={e=>setStatPeriod(e.target.value)}><option value="y">年度</option><option value="q">季度</option><option value="m">月度</option><option value="r">当前选区</option></select><label className="ml-2">视图：</label><select className="border rounded px-2 py-1" value={statView} onChange={e=>setStatView(e.target.value)}><option value="daily">日期在岗分析</option><option value="person">人员班次统计</option><option value="rest">月度休息周期</option><option value="album">专辑审核</option></select>{statView==='person' && (<><label className="ml-2">排序：</label><select className="border rounded px-2 py-1" value={orderBy} onChange={e=>setOrderBy(e.target.value)}><option value="default">默认</option><option value="diff">差值</option><option value="longest">最长连班</option><option value="ratioDev">中/白偏差</option><option value="mix">混合比例</option></select></>)}{statView==='rest' && (<label className="ml-2 inline-flex items-center gap-1 text-xs text-gray-600"><input type="checkbox" className="rounded" checked={showRestCounts} onChange={e=> setShowRestCounts(e.target.checked)} />显示月度明细</label>)}</div>}>
            {statView==='person' && (
              <div className="mb-3 grid grid-cols-2 md:grid-cols-5 gap-2 text-sm">
                <div className="rounded-xl border p-2 bg-gradient-to-br from-indigo-50 to-white"><div className="text-xs text-gray-500">平均白</div><div className="text-lg font-semibold text-indigo-700">{avg.白}</div></div>
                <div className="rounded-xl border p-2 bg-gradient-to-br from-sky-50 to-white"><div className="text-xs text-gray-500">平均中1</div><div className="text-lg font-semibold text-sky-700">{avg.中1}</div></div>
                <div className="rounded-xl border p-2 bg-gradient-to-br from-cyan-50 to-white"><div className="text-xs text-gray-500">平均中2</div><div className="text-lg font-semibold text-cyan-700">{avg.中2}</div></div>
                <div className="rounded-xl border p-2 bg-gradient-to-br from-rose-50 to-white"><div className="text-xs text-gray-500">平均夜</div><div className="text-lg font-semibold text-rose-700">{avg.夜}</div></div>
                <div className="rounded-xl border p-2 bg-gradient-to-br from-emerald-50 to-white"><div className="text-xs text-gray-500">平均总</div><div className="text-lg font-semibold text-emerald-700">{avg.总}</div></div>
              </div>
            )}

            {['daily','person'].includes(statView) && (
              <div className="mb-4 grid grid-cols-2 md:grid-cols-3 gap-2 text-sm">
                <div className="rounded-xl border p-2 bg-gradient-to-br from-amber-50 to-white"><div className="text-xs text-gray-500">平均每天在岗</div><div className="text-lg font-semibold text-amber-700">{dailyAvg.总}</div></div>
                <div className="rounded-xl border p-2 bg-gradient-to-br from-indigo-50 to-white"><div className="text-xs text-gray-500">平均每天白班</div><div className="text-lg font-semibold text-indigo-700">{dailyAvg.白}</div></div>
                <div className="rounded-xl border p-2 bg-gradient-to-br from-sky-50 to-white"><div className="text-xs text-gray-500">平均每天中1</div><div className="text-lg font-semibold text-sky-700">{dailyAvg.中1}</div></div>
              </div>
            )}

            {statView==='daily' && (
              <>
                <div className="mb-4 grid grid-cols-2 md:grid-cols-6 gap-2 text-sm">
                  <div className="rounded-xl border p-2 bg-indigo-50/60"><div className="text-xs text-gray-500">白（总人次）</div><div className="text-lg font-semibold text-indigo-700">{sumTotals.白}</div></div>
                  <div className="rounded-xl border p-2 bg-sky-50/60"><div className="text-xs text-gray-500">中1（总人次）</div><div className="text-lg font-semibold text-sky-700">{sumTotals.中1}</div></div>
                  <div className="rounded-xl border p-2 bg-cyan-50/60"><div className="text-xs text-gray-500">中2（总人次）</div><div className="text-lg font-semibold text-cyan-700">{sumTotals.中2}</div></div>
                  <div className="rounded-xl border p-2 bg-rose-50/60"><div className="text-xs text-gray-500">夜（总人次）</div><div className="text-lg font-semibold text-rose-700">{sumTotals.夜}</div></div>
                  <div className="rounded-xl border p-2 bg-emerald-50/60"><div className="text-xs text-gray-500">在岗（总人次）</div><div className="text-lg font-semibold text-emerald-700">{sumTotals.总}</div></div>
                  <div className="rounded-xl border p-2 bg-gray-50"><div className="text-xs text-gray-500">休（估算）</div><div className="text-lg font-semibold text-gray-800">{restTotal}</div></div>
                </div>

                <div className="overflow-auto rounded-xl border">
                  <table className="text-sm min-w-[780px] w-full">
                    <thead className="bg-gray-50">
                      <tr className="text-gray-500">
                        <th className="text-left py-2 px-3">日期</th>
                        <th className="text-right py-2 px-3">在岗</th>
                        <th className="text-left py-2 px-3 w-[320px]">构成（白 / 中1 / 中2 / 夜）</th>
                      </tr>
                    </thead>
                    <tbody>
                      {daySeries.map(s=>{
                        const pW = s.total? Math.round(s.W/s.total*100) : 0;
                        const pM = s.total? Math.round(s.M/s.total*100) : 0;
                        const pM2= s.total? Math.round(s.N2/s.total*100) : 0;
                        const pN = s.total? Math.round(s.N/s.total*100) : 0;
                        return (
                          <tr key={s.d} className="border-t hover:bg-gray-50">
                            <td className="py-1.5 px-3">{s.d}</td>
                            <td className="py-1.5 px-3 text-right">{s.total}</td>
                            <td className="py-1.5 px-3">
                              <div className="h-3 rounded-full bg-gray-100 overflow-hidden flex">
                                <div style={{width:`${pW}%`, background: shiftColors['白']}} title={`白 ${s.W}`}></div>
                                <div style={{width:`${pM}%`, background: shiftColors['中1']}} title={`中1 ${s.M}`}></div>
                                <div style={{width:`${pM2}%`, background: shiftColors['中2']}} title={`中2 ${s.N2}`}></div>
                                <div style={{width:`${pN}%`, background: shiftColors['夜']}} title={`夜 ${s.N}`}></div>
                              </div>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>

                <div className="mt-3 text-xs text-gray-600">高峰提示：中1最多 {peakMid.val<0?0:peakMid.val}（{peakMid.d}），白班最多 {peakWhite.val<0?0:peakWhite.val}（{peakWhite.d}）。</div>
              </>
            )}

            {statView==='person' && (
              <>
                <div className="flex items-center gap-2 mb-3 mt-4 text-sm">
                  <label className="inline-flex items-center gap-2">行政班应上天数（当前周期）：<input type="number" className="w-24 border rounded px-2 py-1" value={adminDays} onChange={e=> setAdminDays(Number(e.target.value||0))}/></label>
                  <span className="text-gray-500">差值= 实际总天数 - 行政班应上天数（正=超出，负=不足）</span>
                </div>
                <div className="overflow-auto">
                  <table className="text-sm min-w-[1100px] w-full">
                    <thead>
                      <tr className="text-gray-500">
                        <th className="text-left">姓名</th>
                        {['白','中1','中2','夜','总','休','差值','中/白','中/白状态','最长连班','混合周期','混合状态','建议'].map((h,i)=> <th key={i} className={`text-right pr-3 ${i===0?'text-left':''}`}>{h}</th>)}
                      </tr>
                    </thead>
                    <tbody>
                      {rows.map(r=> (
                        <tr key={r.e} className="border-t hover:bg-gray-50">
                          <td className="py-1 text-left">{r.e}</td>
                          {[r.W, r.M, r.N2, r.N, r.total, r.restDays, r.diff, r.ratioStr].map((v,idx)=> <td key={idx} className={`py-1 text-right pr-3 ${idx===6&&(v<0?'text-red-600':v>0?'text-emerald-600':'text-gray-700')}`}>{v}</td>)}
                          <td className="py-1 text-right pr-3">{r.pass? <span className="badge bg-emerald-100 text-emerald-700">OK</span> : <span className="badge bg-rose-100 text-rose-700">OFF</span>}</td>
                          <td className={`py-1 text-right pr-3 ${r.longest>6?'text-rose-600 font-medium':''}`}>{r.longest}</td>
                          <td className={`py-1 text-right pr-3`}>{r.cycMix}/{r.cycTot}（{(r.cycRatio*100).toFixed(0)}%）</td>
                          <td className="py-1 text-right pr-3">{r.mixOk? <span className="badge bg-emerald-100 text-emerald-700">OK</span> : <span className="badge bg-rose-100 text-rose-700">超限</span>}</td>
                          <td className="py-1 text-right pr-3 text-gray-700">{(()=>{ if(adminDays>0){ if(r.diff>0) return `建议减 ${r.diff}`; if(r.diff<0) return `建议补 ${-r.diff}`; } return '—'; })()}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </>
            )}

            {statView==='rest' && (
              <>
                <div className="mb-4">
                  <div className="flex items-center justify-between mb-2">
                    <h3 className="text-sm font-medium text-gray-700">休息周期平均人数（按月度主休类型）</h3>
                    <span className="text-xs text-gray-400">统计区间：{cur.s} ~ {cur.e}</span>
                  </div>
                  <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-2">
                    {restPairAverages.map(item=> (
                      <div key={item.pair} className="rounded-2xl border bg-gradient-to-br from-white to-indigo-50/70 p-3 text-center shadow-sm">
                        <div className="text-xs text-gray-500">休{item.pair}</div>
                        <div className="text-xl font-semibold text-indigo-600">{item.avg}<span className="text-sm text-gray-500 ml-1">人</span></div>
                      </div>
                    ))}
                  </div>
                  <div className="text-xs text-gray-500 mt-2">说明：以上数值为各月主要休息组合对应的平均人数，便于判断休息偏好分布。</div>
                </div>
                <div className="overflow-auto rounded-2xl border">
                  <table className="min-w-[720px] w-full text-sm">
                    <thead className="bg-gray-50 text-gray-600">
                      <tr>
                        <th className="text-left py-2 px-3 w-36">人员</th>
                        {monthSpans.map(span=> (
                          <th key={span.key} className="text-center py-2 px-3">{span.label}</th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {restCycles.map(row=> (
                        <tr key={row.emp} className="border-t hover:bg-indigo-50/20">
                          <td className="py-2 px-3 font-medium text-gray-700">{row.emp}</td>
                          {monthSpans.map(span=>{
                            const info = row.months[span.key] || {};
                            const pairs = Object.entries(info.counts||{}).sort((a,b)=> b[1]-a[1]);
                            return (
                              <td key={span.key} className="py-2 px-3 text-center">
                                <div className="flex flex-col items-center gap-1">
                                  <span className={`text-base font-semibold ${info.bestPair? 'text-indigo-600':'text-gray-400'}`}>{info.display || (info.hasData? '—':'')}</span>
                                  {showRestCounts && (
                                    <div className="flex flex-wrap justify-center gap-1 text-[11px] text-gray-500 max-w-[160px]">
                                      {pairs.length>0 ? (
                                        pairs.map(([pair,count])=> (
                                          <span key={pair} className="px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700">休{pair}×{count}</span>
                                        ))
                                      ) : info.hasData ? (
                                        <span className="text-gray-400">无完整休息周期</span>
                                      ) : null}
                                    </div>
                                  )}
                                </div>
                              </td>
                            );
                          })}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                {showRestCounts && restCycleTotals.length>0 && (
                  <div className="mt-4 rounded-2xl border bg-white overflow-hidden">
                    <div className="px-4 py-3 border-b bg-gray-50 text-sm font-medium text-gray-700 flex items-center justify-between"><span>主要休息周期次数汇总</span><span className="text-xs text-gray-400">统计区间共 {monthSpans.length} 个月</span></div>
                    <div className="overflow-auto">
                      <table className="min-w-[680px] w-full text-sm">
                        <thead className="bg-gray-50 text-gray-500">
                          <tr>
                            <th className="text-left py-2 px-3">人员</th>
                            {REST_PAIRS.map(pair=> <th key={`tot-${pair}`} className="text-right py-2 px-3">休{pair}</th>)}
                            <th className="text-right py-2 px-3">有排班月份</th>
                          </tr>
                        </thead>
                        <tbody>
                          {restCycleTotals.map(row=> (
                            <tr key={`totrow-${row.emp}`} className="border-t hover:bg-indigo-50/20">
                              <td className="py-1.5 px-3 text-gray-700">{row.emp}</td>
                              {REST_PAIRS.map(pair=> <td key={`cell-${row.emp}-${pair}`} className="py-1.5 px-3 text-right">{row.totals[pair]}</td>)}
                              <td className="py-1.5 px-3 text-right text-gray-600">{row.effective}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}
              </>
            )}

            {statView==='album' && (
              <>
                <div className="mb-4 flex flex-wrap items-center gap-3 text-sm">
                  <span className="font-medium text-gray-700">专辑审核视图</span>
                  <div className="inline-flex rounded-full border border-indigo-100 bg-indigo-50/40 p-0.5">
                    <button onClick={()=>setAlbumStatMode('analysis')} className={`px-3 py-1 rounded-full text-xs font-medium transition ${albumStatMode==='analysis' ? 'bg-indigo-600 text-white shadow' : 'text-indigo-600 hover:bg-indigo-100'}`}>数据统计分析</button>
                    <button onClick={()=>setAlbumStatMode('history')} className={`px-3 py-1 rounded-full text-xs font-medium transition ${albumStatMode==='history' ? 'bg-indigo-600 text-white shadow' : 'text-indigo-600 hover:bg-indigo-100'}`}>历史排班表</button>
                  </div>
                  <span className="text-xs text-gray-400">基于专辑审核确认记录实时汇总</span>
                </div>
                {albumStatMode==='analysis' ? (
                  albumEntriesInRange.length===0 ? (
                    <div className="text-sm text-gray-500">当前统计周期内暂无已确认的专辑审核排班，可在专辑审核自动排班页点击“确认排班”后查看。</div>
                  ) : (
                    <>
                      <div className="mb-4 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-2 text-sm">
                        <div className="rounded-2xl border bg-gradient-to-br from-white to-indigo-50 p-3">
                          <div className="text-xs text-gray-500">确认批次</div>
                          <div className="text-lg font-semibold text-indigo-700">{albumSummary.batches}</div>
                        </div>
                        <div className="rounded-2xl border bg-gradient-to-br from-white to-emerald-50 p-3">
                          <div className="text-xs text-gray-500">参与人员数</div>
                          <div className="text-lg font-semibold text-emerald-700">{albumSummary.employeeCount}</div>
                        </div>
                        <div className="rounded-2xl border bg-gradient-to-br from-white to-sky-50 p-3">
                          <div className="text-xs text-gray-500">累计白班天数</div>
                          <div className="text-lg font-semibold text-sky-600">{albumSummary.whiteDays}</div>
                        </div>
                        <div className="rounded-2xl border bg-gradient-to-br from-white to-amber-50 p-3">
                          <div className="text-xs text-gray-500">累计中班天数</div>
                          <div className="text-lg font-semibold text-amber-600">{albumSummary.midDays}</div>
                        </div>
                        <div className="rounded-2xl border bg-gradient-to-br from-white to-rose-50 p-3">
                          <div className="text-xs text-gray-500">单批平均总时长</div>
                          <div className="text-lg font-semibold text-rose-600">{albumSummary.avgTotalHoursPerBatch.toFixed(2)}<span className="text-sm text-gray-500 ml-1">小时</span></div>
                        </div>
                        <div className="rounded-2xl border bg-gradient-to-br from-white to-slate-50 p-3">
                          <div className="text-xs text-gray-500">人均审核时长</div>
                          <div className="text-lg font-semibold text-slate-700">{albumSummary.avgHoursPerEmployee.toFixed(2)}<span className="text-sm text-gray-500 ml-1">小时</span></div>
                        </div>
                      </div>
                      <div className="mb-3 text-xs text-gray-500">平均每批白班 {albumSummary.avgWhiteHoursPerBatch.toFixed(2)} 小时，中班 {albumSummary.avgMidHoursPerBatch.toFixed(2)} 小时。</div>
                      <div className="overflow-auto rounded-2xl border">
                        <table className="min-w-[680px] w-full text-sm">
                          <thead className="bg-gray-50 text-gray-500">
                            <tr>
                              <th className="text-left py-2 px-3">人员</th>
                              <th className="text-right py-2 px-3">白班天数</th>
                              <th className="text-right py-2 px-3">白班时长</th>
                              <th className="text-right py-2 px-3">中班天数</th>
                              <th className="text-right py-2 px-3">中班时长</th>
                              <th className="text-right py-2 px-3">总时长</th>
                            </tr>
                          </thead>
                          <tbody>
                            {albumRows.map(row=> (
                              <tr key={`album-analysis-${row.emp}`} className="border-t hover:bg-indigo-50/20">
                                <td className="py-1.5 px-3 text-gray-700">{row.emp}</td>
                                <td className="py-1.5 px-3 text-right">{row.whiteDays}</td>
                                <td className="py-1.5 px-3 text-right">{row.whiteHours.toFixed(2)}</td>
                                <td className="py-1.5 px-3 text-right">{row.midDays}</td>
                                <td className="py-1.5 px-3 text-right">{row.midHours.toFixed(2)}</td>
                                <td className="py-1.5 px-3 text-right font-medium text-indigo-700">{row.totalHours.toFixed(2)}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </>
                  )
                ) : (
                  albumHistoryForView.length===0 ? (
                    <div className="text-sm text-gray-500">当前统计周期内暂无历史排班，可在专辑审核自动排班页确认后查看。</div>
                  ) : (
                    <div className="space-y-4">
                      {albumHistoryForView.map(({ entry, key, activeCount })=> {
                        const assignments = entry?.assignments || {};
                        const days = Object.keys(assignments).filter(day=> day>=cur.s && day<=cur.e && albumAggregate.dayAssignment[day]?.key === key).sort();
                        const savedAt = entry?.savedAt ? new Date(entry.savedAt).toLocaleString() : '—';
                        const totals = entry?.totals || {};
                        const coverage = entry?.coverage || {};
                        const isCovered = days.length===0;
                        return (
                          <div key={key} className="rounded-2xl border bg-white overflow-hidden shadow-sm">
                            <div className="px-4 py-3 border-b bg-gray-50 text-sm font-medium text-gray-700 flex flex-wrap items-center justify-between gap-2">
                              <div className="flex flex-col sm:flex-row sm:items-center sm:gap-3">
                                <span>{entry?.range?.start} ~ {entry?.range?.end}</span>
                                <span className="text-xs text-gray-400">保存于 {savedAt}</span>
                              </div>
                              <div className="flex flex-wrap items-center gap-2 text-xs text-gray-600">
                                <span className="px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700">白班 {totals.whiteDays||0} 天 / {(Number(totals.whiteHours)||0).toFixed(2)} 小时</span>
                                <span className="px-2 py-0.5 rounded-full bg-amber-50 text-amber-700">中班 {totals.midDays||0} 天 / {(Number(totals.midHours)||0).toFixed(2)} 小时</span>
                                <span className="px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700">总时长 {(Number(totals.totalHours)||0).toFixed(2)} 小时</span>
                                <span className="px-2 py-0.5 rounded-full bg-slate-100 text-slate-600">时长差值 {(Number(entry.diff)||0).toFixed(2)} 小时</span>
                                <span className="px-2 py-0.5 rounded-full bg-sky-50 text-sky-700">覆盖 {coverage.totalDays||0} 天</span>
                                {isCovered ? (
                                  <span className="px-2 py-0.5 rounded-full bg-gray-100 text-gray-500">已被后续排班覆盖</span>
                                ) : (
                                  <span className="px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-700">当前生效 {days.length} 天</span>
                                )}
                              </div>
                            </div>
                            {days.length===0 ? (
                              <div className="p-4 text-xs text-gray-500">该记录在当前统计周期内已被后续排班覆盖。</div>
                            ) : (
                              <div className="overflow-auto">
                                <table className="min-w-[600px] w-full text-sm">
                                  <thead className="bg-gray-50 text-gray-500">
                                    <tr>
                                      <th className="text-left py-2 px-3">日期</th>
                                      <th className="text-left py-2 px-3">星期</th>
                                      <th className="text-left py-2 px-3">白班审核</th>
                                      <th className="text-left py-2 px-3">中班审核</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {days.map(day=>{
                                      const info = assignments?.[day] || {};
                                      const wk = WN[new Date(day).getDay()];
                                      return (
                                        <tr key={`${key}-${day}`} className="border-t hover:bg-indigo-50/20">
                                          <td className="py-1.5 px-3 font-medium text-gray-700">{day}</td>
                                          <td className="py-1.5 px-3 text-gray-500">周{wk}</td>
                                          <td className="py-1.5 px-3"><span className={`inline-block px-2 py-0.5 rounded-full text-xs ${info.white ? 'bg-white border border-gray-200 text-gray-700' : 'bg-rose-50 border border-rose-200 text-rose-600'}`}>{info.white || '未分配'}</span></td>
                                          <td className="py-1.5 px-3"><span className={`inline-block px-2 py-0.5 rounded-full text-xs ${info.mid ? 'bg-white border border-gray-200 text-gray-700' : 'bg-rose-50 border border-rose-200 text-rose-600'}`}>{info.mid || '未分配'}</span></td>
                                        </tr>
                                      );
                                    })}
                                  </tbody>
                                </table>
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  )
                )}
              </>
            )}
          </Section>
        );
      })();


      const ViewHistory = (
        <Section title={`备份记录（${teamDisplayName}）`} right={<div className="flex items-center gap-3">
          <label className="inline-flex items-center gap-1 text-xs text-gray-600"><input type="checkbox" className="rounded" checked={showAutoSaves} onChange={e=> setShowAutoSaves(e.target.checked)} />显示自动保存</label>
          <button onClick={loadVersions} className={`px-3 py-1.5 rounded-full text-sm text-white transition ${(editingLocked || versionsLoading)?'bg-gray-300 cursor-not-allowed':'bg-gray-800 hover:bg-gray-700'}`} disabled={editingLocked || versionsLoading}>
            {versionsLoading ? (<span className="flex items-center gap-2"><Spinner className="w-4 h-4 text-white" /><span>刷新中…</span></span>) : '刷新备份'}
          </button>
        </div>}>
          {versionsLoading && filteredVersions.length>0 && (
            <div className="flex items-center gap-2 text-xs text-gray-500 mb-3">
              <Spinner className="w-4 h-4 text-indigo-500" />
              <span>正在刷新备份记录，请稍候…</span>
            </div>
          )}
          {versionsLoading && filteredVersions.length===0 ? (
            <div className="text-sm text-gray-500">正在加载备份记录…</div>
          ) : filteredVersions.length===0 ? (
            versions.length>0 && !showAutoSaves && versions.some(v=> isAutoSaveLabel((v?.created_by_name || v?.created_by || '').trim())) ? (
              <p className="text-sm text-gray-500">当前筛选仅隐藏了自动保存记录，如需查看请勾选“显示自动保存”。</p>
            ) : (
              <p className="text-sm text-gray-500">当前团队「{teamDisplayName}」暂无备份记录，稍后刷新即可。</p>
            )
          ) : (
            <div className="overflow-auto rounded-2xl border" style={{ maxHeight: 'min(70vh, calc(100vh - 240px))' }}>
              <table className="text-sm w-full min-w-[780px]">
                <thead className="bg-gray-50 text-gray-500">
                  <tr>
                    <th className="text-left py-2 px-3">备份备注</th>
                    <th className="text-left py-2 px-3">团队</th>
                    <th className="text-left py-2 px-3">版本ID</th>
                    <th className="text-left py-2 px-3">保存时间</th>
                    <th className="text-left py-2 px-3">操作用户</th>
                    <th className="text-left py-2 px-3">备注</th>
                    <th className="text-left py-2 px-3">操作</th>
                  </tr>
                </thead>
                <tbody>
                  {filteredVersions.map(v=> {
                    const name = v.note || v.name || '';
                    const remark = v.remark || v.description || '';
                    const teamName = v.team_name || v.teamName || teamDisplayName;
                    const createdAt = v.created_at || v.createdAt || '—';
                    const operatorRaw = v.created_by_name || v.created_by || '管理员';
                    const operator = operatorRaw || '管理员';
                    const isAuto = isAutoSaveLabel(operatorRaw);
                    const deleting = versionDeletingId === v.id;
                    return (
                      <tr key={v.id} className="border-t hover:bg-gray-50">
                        <td className="py-1 px-3">
                          <div className="font-medium text-gray-900">{name || '（未命名）'}</div>
                        </td>
                        <td className="py-1 px-3 text-gray-600">{teamName}</td>
                        <td className="py-1 px-3 text-gray-600">{v.id}</td>
                        <td className="py-1 px-3 text-gray-600">{formatDateTimeString(createdAt)}</td>
                        <td className="py-1 px-3 text-gray-600">
                          <span>{operator}</span>
                          {isAuto && <span className="ml-2 inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-[11px] text-gray-500">自动保存</span>}
                        </td>
                        <td className="py-1 px-3 text-gray-600">{remark || '—'}</td>
                        <td className="py-1 px-3">
                          <div className="flex items-center gap-3">
                            <button type="button" className="text-indigo-600 hover:underline disabled:text-gray-400 disabled:no-underline" onClick={()=>loadVersionById(v.id)} disabled={versionsLoading || deleting}>载入</button>
                            <button type="button" className="flex items-center gap-1 text-rose-600 hover:underline disabled:text-rose-300 disabled:no-underline" onClick={()=>deleteVersionById(v.id)} disabled={deleting || versionsLoading}>
                              {deleting ? (<><Spinner className="w-3.5 h-3.5 text-rose-500" /><span>删除中</span></>) : '删除'}
                            </button>
                          </div>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          )}
        </Section>
      );
      const scheduleYearLabel = (()=>{
        const rawYear = (planStart || '').slice(0,4);
        return /^\d{4}$/.test(rawYear) ? rawYear : String(today.getFullYear());
      })();
      const ViewSettings = (
        <Section title="设置 / 导出">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm text-gray-600 mb-1">排班备注（自动保存）</label>
              <input className="w-full border rounded px-3 py-2" value={note}
                onCompositionStart={e=>{ e.target.isComposing = true; }}
                onCompositionEnd={e=>{ e.target.isComposing = false; setNote(e.target.value); }}
                onChange={allowIme(e=>setNote(e.target.value))} placeholder="例如：10月排班说明（将自动同步）"/>
            </div>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <label className="block text-sm text-gray-600">备份间隔（分钟）
                <input type="number" min={1} className="mt-1 w-full border rounded px-3 py-2" value={backupConfig.intervalMinutes}
                  onChange={e=> updateBackupSetting('intervalMinutes', Math.max(1, Number(e.target.value)||1))} />
              </label>
              <label className="block text-sm text-gray-600">备份保留数量
                <input type="number" min={1} className="mt-1 w-full border rounded px-3 py-2" value={backupConfig.limit}
                  onChange={e=> updateBackupSetting('limit', Math.max(1, Number(e.target.value)||1))} />
              </label>
            </div>
          </div>
          <div className="mt-2 text-xs text-gray-500">所有改动会立即写入服务器，并按上述设置自动备份。<span className="ml-2">最近保存：{formatDateTimeString(serverUpdatedAt)}</span><span className="ml-2">最近备份：{formatDateTimeString(lastBackupAt)}</span></div>
          <div className="mt-6 border-t border-dashed pt-4">
            <h3 className="text-sm font-medium text-gray-700 mb-3">导出操作日志</h3>
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 text-sm items-end">
              <label className="flex flex-col">
                <span className="text-gray-600">开始日期</span>
                <input type="date" value={logExportStart} onChange={e=> setLogExportStart(e.target.value)} className="mt-1 border rounded px-3 py-2" />
              </label>
              <label className="flex flex-col">
                <span className="text-gray-600">结束日期</span>
                <input type="date" value={logExportEnd} onChange={e=> setLogExportEnd(e.target.value)} className="mt-1 border rounded px-3 py-2" />
              </label>
              <div className="flex items-center">
                <PillBtn color="gray" onClick={exportTeamLogs} disabled={logExporting}>
                  {logExporting ? (
                    <span className="flex items-center gap-2"><Spinner className="w-4 h-4 text-white" /><span>导出中…</span></span>
                  ) : '导出 CSV'}
                </PillBtn>
              </div>
              {logExportError ? <div className="text-xs text-rose-500">{logExportError}</div> : <div className="text-xs text-gray-400">若不选择时间范围，将导出全部日志</div>}
            </div>
            <div className="mt-2 text-xs text-gray-500">日志仅记录实际的排班改动操作，便于追溯多人协作历史。</div>
          </div>
          <div className="mt-4 flex flex-wrap items-end gap-2">
            <PillBtn onClick={exportExcel} color="sky" disabled={editingLocked} title={editingLocked?'执行中：只读':''}>服务器导出 Excel/CSV</PillBtn>
            <PillBtn onClick={downloadTemplate} color="gray">下载导入模板</PillBtn>
            <PillBtn onClick={openImportPicker} color="indigo" disabled={editingLocked || importing} title={editingLocked?'执行中：只读':(importing?'导入中…':'')}>
              {importing ? (<><Spinner className="w-4 h-4 text-white" /> 导入中…</>) : '导入 Excel' }
            </PillBtn>
            <input type="file" ref={importInputRef} className="hidden" accept=".xlsx,.xls,.csv" onChange={onImportInputChange} />
          </div>
          <div className="mt-2 text-xs text-gray-500">导入支持 XLSX / XLS / CSV 格式，将覆盖当前排班并自动更新周期。</div>
          <div className="mt-6">
            <h3 className="font-semibold mb-2">自动排班优化</h3>
            <label className={`flex items-start gap-3 text-sm ${editingLocked?'opacity-60':''}`}>
              <input type="checkbox" className="mt-1" checked={yearlyOptimize} disabled={editingLocked}
                onChange={e=> setYearlyOptimize(e.target.checked)} />
              <span>
                <span className="font-medium text-gray-700">按当年累计班次优化</span>
                <span className="block text-xs text-gray-500 mt-1">开启后，自动排班会参考 {scheduleYearLabel} 年 1 月至排班开始日前的历史安排，延续休息日并均衡全年班次占比。</span>
              </span>
            </label>
          </div>
          <div className="mt-6">
            <h3 className="font-semibold mb-2">班次颜色（同步保存到浏览器）</h3>
            <div className="flex flex-wrap gap-4 items-center text-sm">
              {['白','中1','中2','夜','休'].map(s=> (
                <label key={s} className={`flex items-center gap-2 ${editingLocked?'opacity-60':''}`}><span className="w-10 text-right">{s}</span><input type="color" disabled={editingLocked} value={shiftColors[s]||'#ffffff'} onChange={e=> setShiftColors(p=>({ ...p, [s]: e.target.value }))} /></label>
              ))}
              <button className={`px-3 py-1.5 rounded ${editingLocked?'bg-gray-200 cursor-not-allowed':'bg-gray-100 hover:bg-gray-200'}`} disabled={editingLocked} onClick={()=> setShiftColors({'白':'#eef2ff','中1':'#e0f2fe','中2':'#cffafe','夜':'#fee2e2','休':'#f3f4f6'})}>恢复默认</button>
            </div>
          </div>
          <div className="mt-6 space-y-3">
            <div className="flex items-center justify-between">
              <h3 className="font-semibold">在岗人数提醒颜色</h3>
              <button className={`text-xs px-2 py-1 rounded ${editingLocked?'bg-gray-200 cursor-not-allowed':'bg-gray-100 hover:bg-gray-200'}`} disabled={editingLocked} onClick={()=> setStaffingAlerts(normalizeStaffingAlerts())}>恢复默认</button>
            </div>
            <div className="text-xs text-gray-500">可自定义排班表中「在岗 / 白 / 中1」统计的颜色提示。例如当中1 ≤ 3 时给出醒目颜色。</div>
            <div className="space-y-3">
              {[
                { key:'total', label:'在岗总人数' },
                { key:'white', label:'白班人数' },
                { key:'mid1', label:'中1人数' }
              ].map(item=>{
                const conf = staffingAlerts[item.key];
                return (
                  <div key={item.key} className={`grid grid-cols-1 md:grid-cols-[180px_1fr] gap-3 items-center text-sm ${editingLocked?'opacity-70':''}`}>
                    <div className="font-medium text-gray-700">{item.label}</div>
                    <div className="grid grid-cols-1 md:grid-cols-[auto_auto_auto_auto] gap-2 items-center">
                      <span className="text-xs text-gray-500">≤</span>
                      <input type="number" className="w-20 border rounded px-2 py-1" value={conf?.threshold ?? 0} disabled={editingLocked} onChange={e=> setStaffingAlerts(prev=>{
                        const next = normalizeStaffingAlerts(prev);
                        next[item.key].threshold = Number(e.target.value || 0);
                        return next;
                      })} />
                      <input type="color" className="w-16" disabled={editingLocked} value={conf?.lowColor || '#ffffff'} onChange={e=> setStaffingAlerts(prev=>{
                        const next = normalizeStaffingAlerts(prev);
                        next[item.key].lowColor = e.target.value;
                        return next;
                      })} />
                      <div className="flex items-center gap-2 text-xs text-gray-500"><span>大于阈值</span><input type="color" className="w-16" disabled={editingLocked} value={conf?.highColor || '#ffffff'} onChange={e=> setStaffingAlerts(prev=>{
                        const next = normalizeStaffingAlerts(prev);
                        next[item.key].highColor = e.target.value;
                        return next;
                      })} /></div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </Section>
      );

      const extraAccounts = orgConfig.accounts.filter(acc=> acc.username!=='admin');
      const ViewRoles = canManageRoles ? (
        <>
          <Section title="团队管理" right={<PillBtn onClick={addTeam} color="sky" disabled={editingLocked}>新增团队</PillBtn>}>
            {teamsList.length===0 ? (
              <p className="text-sm text-gray-500">暂未创建团队，请点击右上角按钮新增。</p>
            ) : (
              <div className="space-y-3">
                {teamsList.map(t=> (
                  <div key={t.id} className="border rounded-2xl p-4 bg-white shadow-sm">
                    <div className="flex flex-wrap items-end gap-3 text-sm">
                      <label className="flex flex-col text-sm text-gray-600">
                        <span className="mb-1">团队名称</span>
                        <input className={`border rounded px-3 py-1.5 ${editingLocked?'bg-gray-100':''}`} value={t.name}
                          onCompositionStart={e=>{ e.target.isComposing = true; }}
                          onCompositionEnd={e=>{ e.target.isComposing = false; updateTeamField(t.id, 'name', e.target.value); }}
                          onChange={allowIme(e=> updateTeamField(t.id, 'name', e.target.value))} disabled={editingLocked} />
                      </label>
                      <div className="text-xs text-gray-500">ID：{t.id}</div>
                      <label className="flex-1 flex flex-col text-sm text-gray-600 min-w-[200px]">
                        <span className="mb-1">备注</span>
                        <input className={`border rounded px-3 py-1.5 ${editingLocked?'bg-gray-100':''}`} value={t.remark||''}
                          onCompositionStart={e=>{ e.target.isComposing = true; }}
                          onCompositionEnd={e=>{ e.target.isComposing = false; updateTeamField(t.id, 'remark', e.target.value); }}
                          onChange={allowIme(e=> updateTeamField(t.id, 'remark', e.target.value))} disabled={editingLocked} />
                      </label>
                    </div>
                    <div className="mt-3 flex flex-wrap gap-4 text-sm">
                      <label className={`inline-flex items-center gap-2 ${editingLocked?'opacity-60':''}`}>
                        <input type="checkbox" checked={t.features?.albumScheduler !== false} disabled={editingLocked}
                          onChange={e=> updateTeamFeature(t.id, 'albumScheduler', e.target.checked)} /> 启用专辑审核自动排班
                      </label>
                    </div>
                    {teamsList.length>1 && (
                      <div className="mt-3 text-right">
                        <button onClick={()=> removeTeam(t.id)} className={`text-sm text-rose-600 ${editingLocked?'opacity-50 cursor-not-allowed':'hover:underline'}`} disabled={editingLocked}>删除团队</button>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}
          </Section>
          <Section title="账号与权限" right={<PillBtn onClick={addAccount} color="emerald" disabled={editingLocked}>新增账号</PillBtn>}>
            <div className="space-y-4 text-sm">
              <div className="rounded-xl border border-dashed border-indigo-200 bg-indigo-50/40 p-4 text-xs text-indigo-700">
                超级管理员 <span className="font-medium">admin</span> 拥有全部权限，可在此创建访客或管理者账号，并分配可访问的团队与菜单权限。
              </div>
              {extraAccounts.length===0 ? (
                <p className="text-sm text-gray-500">暂未创建其他账号。</p>
              ) : (
                extraAccounts.map(acc=>{
                  const hasAll = acc.teamAccess && acc.teamAccess.includes('*');
                  const passwordDraft = accountPasswordDrafts[acc.username] || '';
                  const displayDraft = accountDisplayDrafts[acc.username];
                  const displayValue = displayDraft !== undefined ? displayDraft : (acc.displayName || '');
                  return (
                    <div key={acc.username} className="border rounded-2xl p-4 bg-white shadow-sm space-y-3">
                      <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <label className="flex flex-col text-gray-600 text-sm">
                          <span className="mb-1">账号</span>
                          <input className={`border rounded px-3 py-1.5 ${editingLocked?'bg-gray-100':''}`} value={acc.username}
                            onCompositionStart={e=>{ e.target.isComposing = true; }}
                            onCompositionEnd={e=>{ e.target.isComposing = false; setAccountUsername(acc.username, e.target.value); }}
                            onChange={allowIme(e=> setAccountUsername(acc.username, e.target.value))} disabled={editingLocked} />
                        </label>
                        <label className="flex flex-col text-gray-600 text-sm">
                          <span className="mb-1">显示名称</span>
                          <input className={`border rounded px-3 py-1.5 ${editingLocked?'bg-gray-100':''}`} value={displayValue}
                            onCompositionStart={e=>{ e.target.isComposing = true; }}
                            onCompositionEnd={e=>{ e.target.isComposing = false; setAccountDisplayName(acc.username, e.target.value); }}
                            onChange={e=> setAccountDisplayDraft(acc.username, e.target.value)}
                            onBlur={e=>{ if(!editingLocked) setAccountDisplayName(acc.username, e.target.value); }}
                            disabled={editingLocked} />
                        </label>
                        <label className="flex flex-col text-gray-600 text-sm">
                          <span className="mb-1">角色</span>
                          <select className={`border rounded px-3 py-1.5 ${editingLocked?'bg-gray-100':''}`} value={acc.role||'guest'}
                            onChange={e=> setAccountRole(acc.username, e.target.value)} disabled={editingLocked}>
                            <option value="guest">访客（只读）</option>
                            <option value="manager">管理者</option>
                          </select>
                        </label>
                      </div>
                      <div className="flex flex-wrap items-end gap-2">
                        <div>
                          <label className="block text-xs text-gray-500 mb-1">登录密码</label>
                          <input type="password" className={`border rounded px-3 py-1.5 ${editingLocked?'bg-gray-100':''}`} value={passwordDraft}
                            onChange={e=> updateAccountPasswordDraft(acc.username, e.target.value)} placeholder="留空表示清空" disabled={editingLocked} />
                        </div>
                        <PillBtn onClick={()=> setAccountPassword(acc.username)} color="indigo" disabled={editingLocked}>更新密码</PillBtn>
                        <button onClick={()=> removeAccount(acc.username)} className={`text-sm text-rose-600 ${editingLocked?'opacity-50 cursor-not-allowed':'hover:underline'}`} disabled={editingLocked}>删除账号</button>
                      </div>
                      <div>
                        <div className="text-xs text-gray-500 mb-1">可切换团队</div>
                        <div className="flex flex-wrap gap-3">
                          <label className={`inline-flex items-center gap-2 ${editingLocked?'opacity-60 cursor-not-allowed':'hover:text-indigo-600'}`}>
                            <input type="checkbox" checked={hasAll} disabled={editingLocked}
                              onChange={e=> setAccountAllTeams(acc.username, e.target.checked)} /> 全部团队
                          </label>
                          {teamsList.map(teamItem=> (
                            <label key={teamItem.id} className={`inline-flex items-center gap-2 ${editingLocked?'opacity-60 cursor-not-allowed':'hover:text-indigo-600'}`}>
                              <input type="checkbox" disabled={editingLocked} checked={hasAll || (acc.teamAccess||[]).includes(teamItem.id)}
                                onChange={e=> setAccountTeamAccess(acc.username, teamItem.id, e.target.checked)} /> {teamItem.name}
                            </label>
                          ))}
                        </div>
                      </div>
                      <div>
                        <div className="text-xs text-gray-500 mb-1">菜单权限</div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                          {MENU_KEYS.filter(key=> key!=='roles').map(key=>{
                            const conf = (acc.menus && acc.menus[key]) ? acc.menus[key] : defaultMenuPerms()[key];
                            const visible = conf.visible !== false;
                            const editable = conf.editable !== false;
                            return (
                              <div key={key} className="flex items-center gap-2 bg-gray-50 rounded-xl px-3 py-2">
                                <span className="flex-1 text-sm text-gray-700">{menuLabels[key]}</span>
                                <label className={`inline-flex items-center gap-1 text-xs ${editingLocked?'opacity-60':''}`}>
                                  <input type="checkbox" checked={visible} disabled={editingLocked}
                                    onChange={e=> updateAccountMenu(acc.username, key, 'visible', e.target.checked)} /> 可见
                                </label>
                                <label className={`inline-flex items-center gap-1 text-xs ${editingLocked||!visible?'opacity-60':''}`}>
                                  <input type="checkbox" checked={editable && visible} disabled={editingLocked || !visible}
                                    onChange={e=> updateAccountMenu(acc.username, key, 'editable', e.target.checked)} /> 可编辑
                                </label>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    </div>
                  );
                })
              )}
            </div>
          </Section>
        </>
      ) : (
        <Section title="角色设置">
          <p className="text-sm text-gray-500">仅超级管理员可访问此页面。</p>
        </Section>
      );

      const userDisplayName = user ? (formatUserDisplayName(user) || '访客') : '';
      const Topbar = (
        <div className="sticky top-0 z-30 bg-gradient-to-b from-white/90 to-white/60 backdrop-blur border-b">
          <div className="layout-shell py-3 flex items-center gap-3">
            <div className="flex flex-col sm:flex-row sm:items-center sm:gap-3 gap-1">
              <h1 className="text-xl font-bold text-indigo-600">排班助手（测试版）</h1>
              {userDisplayName && <span className="text-sm text-gray-500">您好，{userDisplayName}</span>}
            </div>
            <div className="flex-1"></div>
            <div className="flex lg:hidden items-center gap-2 text-sm mr-2">
              <TeamSwitcher teams={accessibleTeams} value={team} onChange={setTeam} disabled={prog.running} canManage={canManageRoles} onManage={()=> setTab('roles')} />
            </div>
            <div className="hidden lg:flex items-center gap-2 text-sm">
              <TeamSwitcher teams={accessibleTeams} value={team} onChange={setTeam} disabled={prog.running} canManage={canManageRoles} onManage={()=> setTab('roles')} />
              <input type="date" className="border rounded px-3 py-1.5" value={viewStart} onChange={e=> { viewManuallyAdjustedRef.current = true; setViewStart(e.target.value); }} />
              <span className="text-gray-400">—</span>
              <input type="date" className="border rounded px-3 py-1.5" value={viewEnd} onChange={e=> { viewManuallyAdjustedRef.current = true; setViewEnd(e.target.value); }} />
            </div>
            <div className="flex items-center gap-2">
              <PillBtn onClick={exportExcel} color="sky" disabled={editingLocked}>导出</PillBtn>
              {user ? (
                <button onClick={doLogout} className={`px-3 py-1.5 rounded-full text-sm ${prog.running?'bg-gray-200 cursor-not-allowed':'bg-gray-200 hover:bg-gray-300'}`} disabled={prog.running}>退出</button>
              ) : (
                <span className="text-xs text-gray-500">未登录</span>
              )}
            </div>
          </div>
          {Object.keys(nightIssues).length>0 && (
            <div className="layout-shell pb-2 text-sm text-red-600">夜班窗口缺：{Object.entries(nightIssues).slice(0,10).map(([k,v])=>`${k}${v==='缺夜&中2'?'(缺夜&中2)':v==='缺夜'?'(缺夜)':'(缺中2)'}`).join('，')}{Object.keys(nightIssues).length>10?' …':''}</div>
          )}
        </div>
      );

      const content = ({ grid: ViewGrid, batch: ViewBatch, album: ViewAlbum, users: ViewEmployees, stats: ViewStats, history: ViewHistory, settings: ViewSettings, roles: ViewRoles }[tab]) || ViewBatch;

      return (
        <div className="min-h-screen">
          {Topbar}
          <div className="layout-shell py-6">
            <SideDock tab={tab} setTab={setTab} menuPerms={menuPerms}/>
            <main className="animate-fade-in">{content}<footer className="text-center text-xs text-gray-400 py-6">© 排班助手（测试版） v2.5</footer></main>
          </div>

          {toast && (
            <div className="fixed top-4 right-4 z-50">
              <div className={`animate-fade-in px-4 py-3 rounded-xl shadow-lg text-sm text-white ${toast.type==='success' ? 'bg-emerald-500' : toast.type==='error' ? 'bg-rose-500' : 'bg-gray-800'}`}>
                {toast.message}
              </div>
            </div>
          )}
          {prog.running && (
            <div className="floating-progress">
              <div className="fp-card rounded-2xl p-4 animate-fade-in">
                <div className="flex items-center justify-between text-sm font-medium text-indigo-700"><span>排班执行中</span><span>{Math.round(prog.done/prog.total*100)}%</span></div>
                <div className="mt-2 h-2 rounded-full bg-white/60 overflow-hidden"><div className="h-2 bg-indigo-500 transition-all" style={{width: `${Math.round(prog.done/prog.total*100)}%`}}></div></div>
                <div className="mt-2 text-xs text-gray-600">{prog.stage}</div>
                <div className="mt-2 logbox p-2 text-[12px] text-gray-700">
                  {logs.map((l,i)=> <div key={i} className="leading-5">{l}</div>)}
                  <div ref={logEndRef}></div>
                </div>
              </div>
            </div>
          )}
          {picker.open && (
            <div className="fixed z-50" style={{ left: picker.x, top: picker.y }}>
              <div ref={pickerRef} className="picker bg-white border rounded-xl p-1 w-40" style={{ maxHeight: 'min(320px, calc(100vh - 40px))', overflowY: 'auto' }}>
                {SHIFT_TYPES.map(s=> {
                  let helper = '';
                  if(s === '夜'){
                    if(!pickerContext) helper = '';
                    else if(pickerContext.nightGap == null) helper = '距上次夜班：暂无记录';
                    else helper = `距上次夜班：${pickerContext.nightGap} 天`;
                  } else if(s === '中2'){
                    if(!pickerContext) helper = '';
                    else if(pickerContext.mid2Gap == null) helper = '距上次中2：暂无记录';
                    else helper = `距上次中2：${pickerContext.mid2Gap} 天`;
                  }
                  return (
                    <button
                      key={s}
                      className="w-full text-left px-3 py-2 rounded hover:bg-gray-100"
                      onClick={()=>{ setCellByIndex(picker.di, picker.ei, s); setPicker(p=>({...p, open:false})); }}
                    >
                      <div className="flex flex-col text-sm">
                        <span className="font-medium text-gray-700">{s}</span>
                        {helper && <span className="text-[11px] text-gray-500 mt-0.5">{helper}</span>}
                      </div>
                    </button>
                  );
                })}
                <div className="h-px bg-gray-100 my-1"></div>
                <button className="w-full text-left px-3 py-2 rounded hover:bg-gray-100" onClick={()=>{ setCellByIndex(picker.di, picker.ei, ''); setPicker(p=>({...p, open:false})); }}>清空</button>
              </div>
            </div>
          )}

          {!user && <LoginModal onSuccess={setUser} accounts={orgConfig.accounts} />}
        </div>
      );
    }

    ;(function selfTests(){
      try{
        const list = enumerateDates('2025-10-01','2025-10-03');
        console.assert(list.length===3 && list[0]==='2025-10-01' && list[2]==='2025-10-03', 'enumerateDates 测试未通过');

        const base = {}; enumerateDates('2025-10-06','2025-10-19').forEach(d=> base[d] = { '甲':'', '乙':'', '丙':'' });
        const rest = { '甲':'56', '乙':'56', '丙':'56' };
        let d0 = buildWhiteFiveTwo({ employees:['甲','乙','丙'], data:base, start:'2025-10-06', end:'2025-10-19', restPrefs:rest });
        let alt = applyAlternateByCycle({ employees:['甲','乙','丙'], data:d0, start:'2025-10-06', end:'2025-10-19' }, 0.5);
        let dayClamp = clampDailyByRange({ employees:['甲','乙','丙'], data:alt, start:'2025-10-06', end:'2025-10-19', rMin:0.3, rMax:0.7, maxRounds:80, mixMaxRatio:0.5 });
        let perClamp = clampPersonByRange({ employees:['甲','乙','丙'], data:dayClamp, start:'2025-10-06', end:'2025-10-19', pMin:0.3, pMax:0.7, maxRounds:100, mixMaxRatio:0.5 });
        let fixed = repairNoMidToWhite({ data: perClamp, employees:['甲','乙','丙'], start:'2025-10-06', end:'2025-10-19' });

        let ok=true; const ds = enumerateDates('2025-10-06','2025-10-19');
        for(let i=0;i<ds.length-1;i++){ ['甲','乙','丙'].forEach((nm)=>{ const a=fixed[ds[i]]?.[nm]; const b=fixed[ds[i+1]]?.[nm]; if(a==='中1' && b==='白'){ ok=false; } }); }
        console.assert(ok, '出现了中1→白相邻，违例');

        console.log('%c自检通过','color:green');
      }catch(err){ globalErr('自检失败：' + (err && err.message || err)); console.error(err); }
    })();
    const mountNode = document.getElementById('root');
    if(mountNode){
      try {
        const root = ReactDOM.createRoot(mountNode);
        root.render(<App/>);
      } catch (err) {
        globalErr('运行错误：' + (err && err.message || err));
        console.error(err);
      }
    }
  </script>
</body>
</html>
