# 排班协作平台 v1.0.0

## 项目概览
排班协作平台是一个面向多团队的排班管理系统，提供从账号登录、团队权限分配、班次配置到排班表维护的全流程能力。本版本基于 **FastAPI + SQLite** 提供后端接口，前端采用原生 Web 技术实现单页体验，支持按照团队与页面维度的细粒度权限控制，并内置示例数据用于快速演示。

### 核心特性
- **首次登录改密**：系统预置 `admin/admin`，首次登录必须通过“首次设置密码”完成密码更新后才能进入平台。
- **多维权限矩阵**：账号可针对排班表格、班次设置、人员管理、角色权限四个页面设置可见/可编辑；团队权限区分 `read`/`write` 影响可编辑性与数据可见性。
- **全局团队上下文**：顶部团队选择器会在所有页面保持同步，所有数据请求均依据当前团队过滤。
- **排班表格视图**：以月份为粒度展示日期 × 人员矩阵，单元格支持颜色标注与下拉修改，支持 CSV 导出。
- **设置/人员/权限管理**：支持班次字典维护、人员启用与排序、账号权限矩阵编辑以及账号新增。
- **一键初始化**：`bin/install.sh` 会创建虚拟环境、安装依赖并初始化 SQLite 数据库与演示数据。

### 目录结构
```
api/               # FastAPI 后端代码
  cli.py           # 初始化/运维脚本
  routers/         # 各业务模块路由
config/            # 应用配置（Toml）
public/            # 前端静态资源
schema/            # SQLite 数据库建表脚本
bin/               # 安装脚本
requirements.txt   # Python 依赖列表
docs/              # 项目文档
```

## 快速开始
1. **安装依赖并初始化数据库**
   ```bash
   ./bin/install.sh
   ```
   脚本会自动创建 `.venv`、安装依赖、复制 `config/app.example.toml` 并执行 `python -m api.cli init-db` 写入演示数据。

2. **启动后端服务**
   ```bash
   source .venv/bin/activate
   uvicorn api.main:app --reload
   ```
   启动后访问 `http://127.0.0.1:8000/` 即可加载前端页面，接口统一位于 `/api/*`。

3. **首位管理员登录**
   - 打开浏览器访问主页，使用账号 `admin` / `admin` 登录。
   - 系统会提示进入首次改密流程，提交新密码后方可访问主界面。

4. **演示账号**
   | 账号 | 密码 | 权限说明 |
   | ---- | ---- | -------- |
   | `admin` | 首次登录需改密 | 拥有全部页面的可见+可编辑权限，所有团队 `write` 权限 |
   | `planner` | `planner123` | 运营一组 `write`，可编辑排班/班次/人员 |
   | `viewer` | `viewer123` | 客服组 `read`，仅可查看排班 |

## 权限与页面说明
- **排班表格**：`page=schedule`。需要 `write` 团队权限与页面编辑权限方可修改单元格，`read` 团队权限可查看与导出。
- **设置**：`page=settings`。维护班次字典，可编辑权限 + 团队 `write` 才能修改，更新立即影响排班表渲染。
- **人员管理**：`page=people`。控制是否在排班表中展示及排序；只读账号仅能查看。
- **角色权限**：`page=permissions`。展示账号 × 页面 × 团队矩阵，可新增账号、批量调整权限。

## CSV 导出
排班页支持在右上角导出当前月份与当前团队的 CSV 文件，首行依次为“日期、星期、成员A、成员B...”，内容使用班次显示名。

## 运维提示
- 配置文件位于 `config/app.toml`，可调整数据库路径、会话有效期与密钥。
- SQLite 建表脚本位于 `schema/init.sql`，可用于手动校验数据结构。
- 如需重置演示数据，可删除 `data/app.db` 后重新执行 `python -m api.cli init-db`。

## 权限覆盖的 E2E 验证建议
1. **管理员首次改密**：以 `admin/admin` 登录 → 跳转首次设置密码 → 设定新密码后进入系统。
2. **页面可见性**：使用 `viewer` 登录，仅看到“排班表格”菜单，其余页面隐藏。
3. **团队只读**：`viewer` 在客服组仅能浏览排班，单元格无编辑交互，仍可切换月份与导出 CSV。
4. **团队可写 + 页面只读组合**：将某账号赋予 `schedule` 可见但不可编辑，同时拥有团队 `write`，进入排班页应显示禁用状态。
5. **班次设置联动**：以 `planner` 修改运营一组的班次颜色或显示名，返回排班页观察颜色与文本即时变化。
6. **人员展示控制**：在人员管理中勾选/取消 `show_in_schedule` 并调整 `sort_index`，回到排班页验证列显隐与顺序。
7. **权限矩阵实时生效**：管理员在“角色权限”页修改 `viewer` 的团队授权为 `write`，刷新排班页可获得编辑按钮；恢复为 `read` 后编辑入口立即消失。

更多接口细节请参考 [`docs/API.md`](API.md) 与 [`docs/SCHEMA.md`](SCHEMA.md)。
