<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>排班协作平台</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.css" />
  <style>
    :root {
      color-scheme: light;
      font-family: 'Inter', 'PingFang SC', 'Microsoft YaHei', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f7fb;
      color: #0f172a;
    }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      background: linear-gradient(160deg, #e0f2fe, #ede9fe 45%, #f5f3ff);
    }
    main#app {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }
    .screen {
      width: min(1200px, 100%);
      margin: 0 auto;
      padding: 2rem;
      box-sizing: border-box;
      display: none;
      flex-direction: column;
      gap: 1.5rem;
    }
    .screen.active {
      display: flex;
    }
    .card {
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(14px);
      border-radius: 1.5rem;
      padding: 2.5rem;
      box-shadow: 0 30px 80px rgba(15, 23, 42, 0.18);
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    .card h1 {
      margin: 0;
      font-size: 2rem;
      color: #312e81;
    }
    .card p {
      margin: 0;
      color: #475569;
      line-height: 1.6;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    label span {
      display: block;
      font-size: 0.95rem;
      font-weight: 600;
      color: #334155;
      margin-bottom: 0.35rem;
    }
    input[type="text"],
    input[type="password"],
    input[type="month"],
    input[type="date"],
    input[type="color"],
    select,
    textarea {
      width: 100%;
      border-radius: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 0.65rem 0.9rem;
      font-size: 1rem;
      background: rgba(255, 255, 255, 0.9);
      box-sizing: border-box;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25);
    }
    button {
      border: none;
      border-radius: 0.75rem;
      background: linear-gradient(135deg, #6366f1, #0ea5e9);
      color: #fff;
      padding: 0.65rem 1.35rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 30px rgba(99, 102, 241, 0.28);
    }
    button.secondary {
      background: #e2e8f0;
      color: #1e293b;
      box-shadow: none;
    }
    button.secondary:hover {
      box-shadow: none;
      transform: none;
    }
    .hint {
      font-size: 0.95rem;
      color: #6366f1;
      font-weight: 500;
    }
    .error-text {
      color: #dc2626;
      font-size: 0.95rem;
    }
    /* Main layout */
    #mainScreen {
      width: 100%;
      max-width: none;
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 0;
      padding: 2rem;
    }
    aside.sidebar {
      background: rgba(15, 23, 42, 0.92);
      color: #e2e8f0;
      border-radius: 1.5rem;
      padding: 1.5rem 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 2rem;
      box-shadow: 0 30px 70px rgba(15, 23, 42, 0.35);
    }
    .sidebar h2 {
      margin: 0;
      font-size: 1.25rem;
      letter-spacing: 0.02em;
    }
    .nav-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .nav-button {
      border-radius: 1rem;
      border: none;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255, 255, 255, 0.06);
      color: inherit;
      font-size: 0.98rem;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }
    .nav-button[disabled] {
      opacity: 0.35;
      cursor: not-allowed;
    }
    .nav-button.active {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.8), rgba(14, 165, 233, 0.8));
      box-shadow: 0 14px 30px rgba(79, 70, 229, 0.35);
    }
    .workspace {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    header.topbar {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 1.5rem;
      padding: 1.25rem 1.75rem;
      box-shadow: 0 25px 60px rgba(148, 163, 184, 0.25);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1.5rem;
      backdrop-filter: blur(14px);
    }
    .topbar-left {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }
    .topbar-left h1 {
      margin: 0;
      font-size: 1.4rem;
      color: #1e293b;
    }
    .topbar-left span {
      font-size: 0.9rem;
      color: #64748b;
    }
    .team-selector {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }
    .topbar-right {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .topbar-right .user-name {
      font-weight: 600;
      color: #312e81;
    }
    .page-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    .page {
      display: none;
      flex-direction: column;
      gap: 1rem;
      background: rgba(255, 255, 255, 0.92);
      border-radius: 1.5rem;
      padding: 1.5rem;
      box-shadow: 0 20px 55px rgba(15, 23, 42, 0.16);
      overflow: hidden;
    }
    .page.active {
      display: flex;
    }
    .page h2 {
      margin: 0;
      font-size: 1.35rem;
      color: #1f2937;
    }
    .subtle-text {
      color: #64748b;
      font-size: 0.95rem;
    }
    .table-wrapper {
      border-radius: 1.25rem;
      overflow: auto;
      border: 1px solid rgba(148, 163, 184, 0.25);
    }
    table.schedule-table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      min-width: 840px;
      background: #fff;
    }
    table.schedule-table th,
    table.schedule-table td {
      border: 1px solid rgba(226, 232, 240, 0.9);
      padding: 0.75rem;
      min-width: 120px;
      text-align: center;
      position: relative;
    }
    table.schedule-table th {
      background: #f8fafc;
      font-weight: 600;
      color: #1e293b;
      z-index: 2;
    }
    table.schedule-table th.sticky-col,
    table.schedule-table td.sticky-col {
      position: sticky;
      left: 0;
      z-index: 3;
      background: #f8fafc;
    }
    table.schedule-table th.sticky-col-2,
    table.schedule-table td.sticky-col-2 {
      position: sticky;
      left: 120px;
      z-index: 3;
      background: #f8fafc;
    }
    table.schedule-table thead th {
      top: 0;
      position: sticky;
      z-index: 4;
    }
    table.schedule-table td.cell-value {
      cursor: pointer;
      font-weight: 600;
      border-radius: 0.75rem;
      transition: transform 0.1s ease;
    }
    table.schedule-table td.cell-value:hover {
      transform: translateY(-1px);
    }
    .schedule-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.95rem;
      padding: 0.3rem 0.7rem;
      border-radius: 999px;
      background: rgba(79, 70, 229, 0.12);
      color: #4338ca;
    }
    .inline-controls {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .inline-controls label {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      font-size: 0.95rem;
      color: #475569;
    }
    .actions-row {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .pill-button {
      padding: 0.4rem 0.9rem;
      border-radius: 999px;
      border: none;
      background: rgba(226, 232, 240, 0.85);
      color: #1e293b;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .pill-button:hover {
      background: rgba(148, 163, 184, 0.45);
    }
    .grid {
      display: grid;
      gap: 0.75rem;
    }
    .grid.two-cols {
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    .data-table {
      border-collapse: collapse;
      width: 100%;
      background: #fff;
      border-radius: 1rem;
      overflow: hidden;
    }
    .data-table th,
    .data-table td {
      border: 1px solid rgba(226, 232, 240, 0.9);
      padding: 0.7rem;
      text-align: left;
    }
    .data-table th {
      background: #f8fafc;
      font-weight: 600;
    }
    .checkbox {
      width: 18px;
      height: 18px;
      accent-color: #6366f1;
    }
    .dropdown-menu {
      position: fixed;
      z-index: 999;
      background: #fff;
      border-radius: 0.75rem;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.18);
      border: 1px solid rgba(148, 163, 184, 0.2);
      min-width: 180px;
      display: flex;
      flex-direction: column;
      padding: 0.35rem;
      gap: 0.25rem;
    }
    .dropdown-menu button {
      border-radius: 0.65rem;
      background: transparent;
      color: #1e293b;
      justify-content: flex-start;
      font-weight: 500;
      padding: 0.55rem 0.65rem;
      box-shadow: none;
    }
    .dropdown-menu button:hover {
      background: rgba(79, 70, 229, 0.12);
      transform: none;
    }
    .empty-state {
      padding: 2rem;
      border-radius: 1.25rem;
      background: rgba(99, 102, 241, 0.08);
      color: #4338ca;
      text-align: center;
      font-weight: 500;
    }
    .toast {
      position: fixed;
      bottom: 2.5rem;
      right: 2.5rem;
      background: rgba(15, 23, 42, 0.92);
      color: #fff;
      padding: 0.85rem 1.25rem;
      border-radius: 0.85rem;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.35);
      opacity: 0;
      transform: translateY(30px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      pointer-events: none;
      z-index: 1200;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    @media (max-width: 1100px) {
      #mainScreen {
        grid-template-columns: 1fr;
        padding: 1.25rem;
      }
      aside.sidebar {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 1.25rem;
      }
      .nav-group {
        flex-direction: row;
        flex-wrap: wrap;
      }
      .nav-button {
        flex: 1 0 45%;
      }
    }
    @media (max-width: 768px) {
      header.topbar {
        flex-direction: column;
        align-items: flex-start;
      }
      aside.sidebar {
        flex-direction: column;
        align-items: flex-start;
      }
      .nav-button {
        flex: 1 0 100%;
      }
    }
  </style>
</head>
<body>
  <main id="app">
    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <section id="loadingScreen" class="screen active">
      <div class="card">
        <h1>正在加载排班协作平台…</h1>
        <p>请稍候，我们正在同步配置。</p>
      </div>
    </section>

    <section id="setupScreen" class="screen">
      <div class="card">
        <h1>欢迎使用排班协作平台</h1>
        <p>检测到默认管理员尚未设置密码，请先完成初始化。</p>
        <form id="setupForm">
          <label>
            <span>管理员账号</span>
            <input id="setupUsername" type="text" value="admin" disabled />
          </label>
          <label>
            <span>新密码</span>
            <input id="setupPassword" type="password" autocomplete="new-password" required />
          </label>
          <label>
            <span>确认新密码</span>
            <input id="setupPasswordConfirm" type="password" autocomplete="new-password" required />
          </label>
          <button type="submit">设定密码并进入系统</button>
        </form>
        <p class="hint">提示：密码需至少 8 位，可包含字母、数字或符号。</p>
        <p id="setupError" class="error-text" hidden></p>
      </div>
    </section>

    <section id="loginScreen" class="screen">
      <div class="card">
        <h1>登录排班协作平台</h1>
        <form id="loginForm">
          <label>
            <span>用户名</span>
            <input id="loginUsername" type="text" autocomplete="username" required />
          </label>
          <label>
            <span>密码</span>
            <input id="loginPassword" type="password" autocomplete="current-password" required />
          </label>
          <button type="submit">登录</button>
        </form>
        <p id="loginError" class="error-text" hidden></p>
      </div>
    </section>

    <section id="passwordScreen" class="screen">
      <div class="card">
        <h1>请设置新密码</h1>
        <p>出于安全要求，需要为当前账号设置新密码后才能继续。</p>
        <form id="passwordForm">
          <label>
            <span>当前密码</span>
            <input id="passwordCurrent" type="password" autocomplete="current-password" />
          </label>
          <label>
            <span>新密码</span>
            <input id="passwordNew" type="password" autocomplete="new-password" required />
          </label>
          <label>
            <span>确认新密码</span>
            <input id="passwordConfirm" type="password" autocomplete="new-password" required />
          </label>
          <button type="submit">更新密码</button>
        </form>
        <p class="hint">密码需至少 8 位。首次登录的账号无需填写当前密码。</p>
        <p id="passwordError" class="error-text" hidden></p>
      </div>
    </section>

    <section id="mainScreen" class="screen">
      <aside class="sidebar">
        <div>
          <h2>排班协作平台</h2>
          <p class="subtle-text">管理班次、权限与团队排班</p>
        </div>
        <nav class="nav-group" id="navGroup"></nav>
      </aside>
      <div class="workspace">
        <header class="topbar">
          <div class="topbar-left">
            <h1 id="pageTitle">排班表格</h1>
            <span id="teamAccess"></span>
          </div>
          <div class="team-selector">
            <label>
              <span>团队</span>
              <select id="teamSelect"></select>
            </label>
          </div>
          <div class="topbar-right">
            <span class="user-name" id="currentUser"></span>
            <button id="logoutBtn" class="secondary">退出登录</button>
          </div>
        </header>
        <div class="page-container">
          <section id="page-schedule" class="page active">
            <div class="schedule-meta">
              <div class="inline-controls">
                <label>
                  <span>月份</span>
                  <input id="monthInput" type="month" />
                </label>
                <button id="refreshSchedule" class="secondary" type="button">刷新</button>
                <button id="exportCsv" type="button">导出 CSV</button>
              </div>
              <span id="scheduleStatus" class="subtle-text"></span>
            </div>
            <div class="table-wrapper">
              <table id="scheduleTable" class="schedule-table"></table>
            </div>
          </section>

          <section id="page-settings" class="page">
            <h2>班次与样式设置</h2>
            <p class="subtle-text">调整班次代码、显示名称与颜色风格，支持上下移动排序与启用状态。</p>
            <div id="shiftList"></div>
            <form id="newShiftForm" class="grid two-cols">
              <label>
                <span>班次代码</span>
                <input name="shift_code" type="text" required />
              </label>
              <label>
                <span>显示名称</span>
                <input name="display_name" type="text" required />
              </label>
              <label>
                <span>背景色</span>
                <input name="bg_color" type="color" value="#ffffff" />
              </label>
              <label>
                <span>文字颜色</span>
                <input name="text_color" type="color" value="#111827" />
              </label>
              <div class="actions-row">
                <button type="submit">新增班次</button>
              </div>
            </form>
          </section>

          <section id="page-role_permissions" class="page">
            <h2>角色权限管理</h2>
            <p class="subtle-text">配置账号可访问的页面、操作权限与可操作团队范围。</p>
            <div id="accountsMatrix"></div>
            <h3>新增账号</h3>
            <form id="newAccountForm" class="grid two-cols">
              <label>
                <span>用户名</span>
                <input name="username" type="text" required />
              </label>
              <label>
                <span>显示名称</span>
                <input name="display_name" type="text" />
              </label>
              <label>
                <span>初始密码（选填）</span>
                <input name="initial_password" type="password" autocomplete="new-password" />
              </label>
              <div class="actions-row">
                <button type="submit">创建账号</button>
              </div>
            </form>
            <h3>团队管理</h3>
            <div id="teamManagement"></div>
            <form id="newTeamForm" class="grid two-cols">
              <label>
                <span>团队名称</span>
                <input name="name" type="text" required />
              </label>
              <label>
                <span>团队编码（选填）</span>
                <input name="code" type="text" />
              </label>
              <div class="actions-row">
                <button type="submit">新增团队</button>
              </div>
            </form>
          </section>

          <section id="page-people" class="page">
            <h2>人员管理</h2>
            <p class="subtle-text">维护团队成员，勾选“在排班显示”的人员将出现在排班表格中，可通过上下移动调整显示顺序。</p>
            <div id="peopleList"></div>
            <form id="newPersonForm" class="grid two-cols">
              <label>
                <span>姓名</span>
                <input name="name" type="text" required />
              </label>
              <div class="actions-row">
                <label><input type="checkbox" name="show_in_schedule" class="checkbox" checked /> 在排班显示</label>
                <label><input type="checkbox" name="active" class="checkbox" checked /> 启用</label>
                <button type="submit">添加成员</button>
              </div>
            </form>
          </section>
        </div>
      </div>
    </section>
  </main>
  <script type="module" src="js/app.js"></script>
</body>
</html>
